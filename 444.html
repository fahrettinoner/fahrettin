
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Personel Yönetim Sistemi</title>
    <style>
        /* Genel Stiller */
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f4f4f4;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    padding: 20px;
}
/* Konteyner Stilleri */
.container {
    display: none; /* Başlangıçta gizli */
    width: 95%;
    max-width: 1400px;
    background: #fff;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
}
/* Giriş Alanı Stilleri */
#login {
    width: 300px;
    padding: 30px 20px;
    background: #fff;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    text-align: center;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border-radius: 8px;
}
#login h2 {
    margin-top: 0;
    color: #333;
}
#login input,
#login select,
#login button {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 4 empat;
}
#login button {
     background: #5cb85c; /* Daha belirgin bir buton rengi */
     color: white;
     border: none;
     cursor: pointer;
}
#login button:hover {
    background: #4cae4c;
}
#login .error {
    color: red;
    height: 1.2em; /* Hata mesajı alanı için yer ayırma */
    margin-top: 5px;
}
/* Tab Navigasyon Stilleri */
.tab {
    margin-bottom: 20px;
    border-bottom: 1px solid #ccc;
    padding-bottom: 10px;
    display: flex; /* Butonları yan yana hizala */
    flex-wrap: wrap; /* Küçük ekranlarda alt satıra insin */
    align-items: center;
}
.tab button {
    padding: 10px 15px;
    margin-right: 5px;
    cursor: pointer;
    border: 1px solid #ccc;
    background-color: #eee;
    border-bottom: none;
    border-top-left-radius: 5px;
    border-top-right-radius: 5px;
    transition: background-color 0.3s ease;
    margin-bottom: 5px; /* Küçük ekranlarda alt satıra inince boşluk */
}
.tab button:hover:not(.active) {
    background-color: #ddd;
}
.tab button.active {
    background: #fff;
    border-bottom: 1px solid #fff;
    position: relative;
    top: 1px;
    font-weight: bold;
}
/* Kullanıcı Kontrolleri */
.user-controls {
    margin-left: auto; /* Sağ tarafa yasla */
    display: flex;
    align-items: center;
    gap: 10px; /* Butonlar arasına boşluk */
     flex-wrap: wrap; /* Küçük ekranlarda alt satıra insin */
     font-size: 0.9em; /* Biraz daha küçük font */
}
 .user-controls span {
     font-weight: bold;
}
 .user-controls button {
    padding: 8px 12px; /* Daha küçük butonlar */
    cursor: pointer;
    border-radius: 4px;
    border: none;
    color: white;
     margin: 0; /* Tab butonlarıyla aynı margin olmasın */
}
#changePasswordButton {
     background-color: #0275d8; /* Mavi */
}
#logoutButton {
    background-color: #f0ad4e; /* Turuncu */
}
/* Tab İçerikleri Stilleri */
.tabcontent {
    display: none;
    padding: 10px;
    border: 1px solid #ccc;
    border-top: none;
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
    background-color: #fff;
}
/* Form Konteyner Stilleri */
.form-container {
    display: none;
    margin-bottom: 20px;
    padding: 15px;
    background: #f9f9f9;
    border: 1px solid #eee;
    border-radius: 5px;
}
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}
.form-grid label {
    font-weight: bold;
    display: block;
    margin-bottom: 5px;
    color: #555;
}
.form-grid input:not([type="checkbox"]):not([type="radio"]),
.form-grid select,
.form-grid textarea { /* Sadece input, select, textarea */
    width: 100%;
    padding: 8px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 4px;
}
.form-grid textarea {
    height: 80px;
    resize: vertical;
}
 /* Checkbox ve Radio için özel stil */
.form-grid input[type="checkbox"],
.form-grid input[type="radio"] {
    margin-right: 5px;
}
.form-actions {
    grid-column: 1 / -1; /* Gridin tamamını kapla */
    text-align: right;
    padding-top: 10px;
    border-top: 1px solid #eee;
    margin-top: 10px;
     display: flex; /* Butonları yan yana hizala */
     justify-content: flex-end; /* Sağ tarafa yasla */
     gap: 10px; /* Butonlar arasına boşluk */
     flex-wrap: wrap; /* Küçük ekranlarda alt alta insin */
}
.form-actions button {
    padding: 10px 20px;
    background: #5cb85c;
    color: #fff;
    border: none;
    cursor: pointer;
    border-radius: 4px;
}
 .form-actions .passive-button {
     background-color: #d9534f; /* Kırmızı renk */
 }
  .form-actions .active-button {
     background-color: #0275d8; /* Mavi renk */
 }
/* Ekle Butonu ve Filtre Göster/Gizle Konteyneri */
.add-filter-controls { /* Yeni eklenen konteyner */
     display: flex;
     align-items: center;
     gap: 15px; /* Butonlar ve toggle arasına boşluk */
     margin-bottom: 15px;
     flex-wrap: wrap; /* Küçük ekranlarda alt alta insin */
}
 .add-button {
    padding: 10px 20px;
    background: #0275d8; /* Mavi */
    color: #fff;
    border: none;
    cursor: pointer;
    border-radius: 4px;
     margin: 0; /* Yeni konteynerde margin sıfırlandı */
}
 /* Filtre Göster/Gizle Butonu */
 .filter-toggle-button { /* Yeni eklenen buton stili */
    padding: 10px 20px;
    background: #6c757d; /* Gri renk */
    color: #fff;
    border: none;
    cursor: pointer;
    border-radius: 4px;
}
 .filter-toggle-button:hover {
     background: #5a6268;
 }
/* Filtre Alanları */
.filter-controls {
    margin-bottom: 20px;
    padding: 15px;
    background: #f9f9f9;
    border: 1px solid #eee;
    border-radius: 5px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
     display: none; /* CSS ile gizlendi */
}
.filter-controls label {
    font-weight: bold;
    display: block;
    margin-bottom: 5px;
    color: #555;
}
 .filter-controls input,
 .filter-controls select {
    width: 100%;
    padding: 8px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 4px;
}
 .filter-controls button {
    padding: 8px 15px; /* Daha küçük filtre butonu */
    background: #5cb85c;
    color: #fff;
    border: none;
    cursor: pointer;
    border-radius: 4px;
}
/* Tablo Stilleri */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
th, td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
     word-break: break-word; /* Uzun kelimeler satır sonuna insin */
}
th {
    background-color: #f2f2f2;
    font-weight: bold;
}
tbody tr:nth-child(even) { /* Çift satırları renklendir */
    background-color: #f9f9f9;
}
tbody tr.passive { /* Pasif personel satırlarını farklı renklendir */
     background-color: #ffebee; /* Açık kırmızı */
     font-style: italic;
     color: #666;
}
 tbody tr.passive .action-btns span { /* Pasif satırlardaki işlem butonlarının rengi */
     color: #999;
 }
 /* Pasif Personel Ayırıcı Satır */
 #personelTable tbody tr.passive-separator td {
     background-color: #e0e0e0;
     font-weight: bold;
     text-align: center;
     padding: 15px;
 }
/* İşlem Butonları */
.action-btns span {
    margin-right: 10px;
    cursor: pointer;
    color: #0275d8; /* Mavi */
    text-decoration: underline;
    white-space: nowrap; /* İşlem butonları tek satırda kalsın */
}
.action-btns span:last-child { /* Son butonda sağ boşluk olmasın */
    margin-right: 0;
}
.action-btns .delete {
    color: #d9534f; /* Kırmızı */
}
 .action-btns .password-change {
     color: #ffc107; /* Sarı */
 }
.disabled {
    color: gray !important;
    cursor: not-allowed !important;
    text-decoration: none !important;
}
/* Modal Stilleri */
.modal {
    display: none; /* Başlangıçta gizli */
    position: fixed;
    z-index: 1000; /* Modalın diğer elementlerin üzerinde olması için */
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto; /* İçerik taşarsa kaydırma çubuğu */
    background-color: rgba(0,0,0,0.4);
    justify-content: center; /* İçeriği dikeyde ortala */
    align-items: center; /* İçeriği yatayda ortala */
}
.modal-content {
    background-color: #fefefe;
    margin: 15% auto; /* Dikeyde boşluk, yatayda ortala */
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 600px;
    border-radius: 8px;
    position: relative; /* Kapatma butonu için */
}
.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
     position: absolute; /* Sağ üste sabitle */
     top: 10px;
     right: 20px;
}
.close:hover,
.close:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
}
.modal-details p {
    margin-bottom: 10px; /* Detay satırları arasına boşluk */
}
/* Ayarlar Sayfası Stilleri */
#ayarlar .tabcontent-inner { /* Ayarlar tab içeriği için Flexbox konteyner */
     display: flex;
     flex-wrap: wrap; /* Küçük ekranlarda alt alta insin */
     gap: 20px; /* Bölümler arası boşluk */
}
.settings-section {
    flex-basis: calc(25% - 20px); /* Dört eşit sütun için yaklaşık değer */
    flex-grow: 1; /* Alanı doldursun */
    min-width: 220px; /* Minimum genişlik */
    margin-bottom: 20px; /* Alt alta inince boşluk */
    padding-bottom: 0; /* Alt çizgi kaldırıldı */
    border-bottom: none; /* Alt çizgi kaldırıldı */
}
 /* Ayarlar Başlıkları ve Collapsible Stilleri */
 .settings-section h4 {
    border-bottom: none;
    padding-bottom: 0;
    margin-bottom: 10px;
    font-size: 1em;
     cursor: pointer; /* Tıklanabilir olduğunu belirt */
     background-color: #f2f2f2; /* Hafif arka plan */
     padding: 10px; /* Dolgu eklendi */
     border: 1px solid #eee; /* Kenarlık */
     border-radius: 4px; /* Kenar yuvarlaklığı */
     display: flex; /* İçeriği hizalamak için */
     justify-content: space-between; /* Başlık ve ikon arasına boşluk */
     align-items: center; /* Dikeyde ortala */
     transition: background-color 0.3s ease; /* Geçiş efekti */
 }
 .settings-section h4:hover {
     background-color: #e0e0e0;
 }
 .settings-section h4::after { /* Açılır/Kapanır ok ikonu */
     content: '\25BC'; /* Aşağı ok */
     font-size: 0.8em; /* İkon boyutu */
     margin-left: 10px; /* Başlıktan uzaklık */
     transition: transform 0.3s ease; /* Dönüşüm efekti */
 }
 .settings-section h4.active::after {
     content: '\25B2'; /* Yukarı ok */
 }
 .collapsible-content {
     display: none; /* Başlangıçta gizli */
     overflow: hidden; /* Gizlenirken içerik taşmasın */
     border: 1px solid #eee; /* İçerik kenarlığı */
     border-top: none; /* Üst kenarlık kaldırıldı */
     border-radius: 0 0 4px 4px; /* Alt kenarlar yuvarlak */
     padding: 0 10px 10px 10px; /* Üstten 0, diğer yönlerden dolgu */
     background-color: #f9f9f9; /* Hafif arka plan */
     margin-top: 0; /* Üst boşluk kaldırıldı */
 }
 .collapsible-content.active {
     display: block; /* Açıldığında göster */
     padding: 10px; /* Açıldığında dolgu eklendi */
 }
.settings-form {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    align-items: center;
     flex-wrap: wrap; /* Küçük ekranlarda alt satıra insin */
}
.settings-form input[type="text"],
.settings-form input[type="number"], /* Sayısal input için stil eklendi */
.settings-form input:not([type]) { /* Sadece text, number veya type belirtilmeyen input */
     flex-grow: 1; /* Boşluğu doldursun */
     padding: 8px;
     box-sizing: border-box;
     border: 1px solid #ccc;
     border-radius: 4px;
}
.settings-form button {
     padding: 8px 15px;
     background: #5cb85c;
     color: #fff;
     border: none;
     cursor: pointer;
     border-radius: 4px;
}
.settings-list {
    list-style: none;
    padding: 0;
    margin-top: 10px; /* Listenin üstüne boşluk */
}
.settings-list li {
    display: flex;
    justify-content: space-between;
    align-items: center; /* Dikeyde ortala */
    padding: 8px 0; /* Dikeyde boşluk azaltıldı */
    border-bottom: 1px solid #eee;
    font-size: 0.9em; /* Liste elemanı yazı boyutu küçültüldü */
}
 .settings-list li span {
     flex-grow: 1; /* Ünvan/tür adı boşluğu doldursun */
     margin-right: 10px; /* Metin ile buton arasına boşluk */
 }
 .settings-list button {
     padding: 3px 8px; /* Daha küçük silme butonu */
     background-color: #d9534f; /* Kırmızı */
     color: white;
     border: none;
     border-radius: 4px;
     cursor: pointer;
 }
 .settings-list button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
 }
/* Kullanıcı Yetkileri Checkbox Düzeni */
 #userPermissions .permission-row {
    display: flex;
    align-items: center;
    margin-bottom: 8px; /* Satırlar arasına boşluk */
    padding: 8px;
    border: 1px solid #eee;
    border-radius: 4px;
    background-color: #f9f9f9;
 }
 #userPermissions .permission-row strong {
     flex-basis: 150px; /* Ünvan ismi için sabit genişlik */
     margin-right: 15px;
 }
 #userPermissions .permission-actions {
     display: flex;
     gap: 10px; /* Yetki checkboxları arasına boşluk */
     flex-wrap: wrap; /* Yetkiler sığmazsa alt satıra insin */
 }
 #userPermissions .permission-actions label {
     font-weight: normal; /* Yetki label'ları kalın olmasın */
     margin-bottom: 0; /* Label alt boşluk kaldırıldı */
     display: inline-block; /* Checkbox ile yan yana gelmesi için */
 }
  #userPermissions .permission-actions input[type="checkbox"] {
      margin-right: 2px; /* Checkbox ile label arasına küçük boşluk */
  }
/* Yönetici rolündeyken yetki kısmını gizle */
#kullaniciFormContainer.admin-role .permission-section-title,
#kullaniciFormContainer.admin-role #userPermissions {
    display: none;
}
/* Responsive Ayarlar Bölümü */
 @media (max-width: 900px) {
    #ayarlar .tabcontent-inner {
        flex-direction: column; /* Dikey sıralama */
    }
    .settings-section {
        flex-basis: 100%; /* Tam genişlik */
        min-width: auto; /* Tam genişlikteyken minimum genişlik kısıtlamasını kaldır */
    }
 }

 /* Tatiller Sayfası Stilleri */
 #tatiller .year-selection {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
 }
 #tatiller .year-selection button {
    padding: 10px 20px;
    background: #0275d8;
    color: #fff;
    border: none;
    cursor: pointer;
    border-radius: 4px;
 }
 #tatiller .year-selection button.active {
     background: #0056b3; /* Aktif yıl butonu rengi */
 }
 #tatiller .holiday-list {
     /* display: grid; /* Grid yerine block veya flex kullanılabilir */
     /* grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
     */ /* Yıl seçilince görünecek bayram listesi */
     gap: 15px;
     margin-top: 20px;
     padding: 15px;
     background: #f9f9f9;
     border: 1px solid #eee;
     border-radius: 5px;
     display: none; /* Başlangıçta gizli */
 }
  #tatiller .holiday-list h4 { /* Bayram listesi başlığı */
      border-bottom: 1px solid #ccc;
      padding-bottom: 10px;
      margin-bottom: 15px;
      font-size: 1.1em;
      color: #555;
      cursor: default; /* Başlık tıklanabilir olmasın */
       /* Aşağı ok ikonunu kaldır */
      content: none !important;
 }
    #tatiller .holiday-list h4::after {
        content: none !important; /* Başlıktaki oku kaldır */
    }
 #tatiller .holiday-list ul { /* Ulusal Bayramlar listesi */
     list-style: none;
     padding: 0;
     margin-top: 10px;
 }
 #tatiller .holiday-list li {
     display: flex;
     justify-content: space-between;
     align-items: center;
     padding: 8px 0; /* Dikeyde boşluk azaltıldı */
     border-bottom: 1px solid #eee;
     font-size: 0.9em; /* Liste elemanı yazı boyutu küçültüldü */
     flex-wrap: wrap; /* Küçük ekranlarda alt alta insin */
 }
  #tatiller .holiday-list li span {
      flex-grow: 0;
      margin-right: 10px;
      min-width: 150px; /* Bayram adı için minimum genişlik */
  }
 /* Tatiller sayfasındaki tarih inputları için stil */
 #tatiller .holiday-list input[type="date"] {
      padding: 5px; /* Daha küçük dolgu */
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9em; /* Yazı boyutu küçültüldü */
      flex-grow: 0; /* Alanı doldursun */
      min-width: 150px; /* Tarih inputu için minimum genişlik */
 }

 #tatiller .holiday-save-button {
     margin-top: 20px;
     text-align: right;
 }
 #tatiller .holiday-save-button button {
     padding: 10px 20px;
     background: #5cb85c;
     color: #fff;
     border: none;
     cursor: pointer;
     border-radius: 4px;
 }

 /* Yeni Silme Onay Modalı Stilleri */
 #confirmDeleteModal .modal-content {
      max-width: 400px; /* Daha küçük bir modal */
      text-align: center;
 }
 #confirmDeleteModal .modal-content h4 {
      margin-top: 0;
      color: #d9534f; /* Kırmızı renk */
      border-bottom: none; /* Alt çizgi olmasın */
      padding-bottom: 0;
 }
  #confirmDeleteModal #confirmDeleteMessage {
      margin-bottom: 20px;
      font-size: 1.1em;
      color: #333;
  }
 /* Silme Nedeni Alanı Stilleri */
 #deleteReasonContainer {
     margin-top: 15px;
     text-align: left; /* Yazıyı sola hizala */
     display: none; /* Başlangıçta gizli */
 }
 #deleteReasonContainer label {
     font-weight: bold;
     display: block; /* Label'ı üstte göster */
     margin-bottom: 5px;
     color: #333;
 }
 #deleteReasonInput {
     width: 100%; /* Genişliği ayarla */
     height: 80px; /* Yüksekliği ayarla */
     padding: 10px;
     box-sizing: border-box;
     border: 1px solid #ccc;
     border-radius: 4px;
     resize: vertical; /* Sadece dikey yeniden boyutlandırmaya izin ver */
 }
 #deleteReasonError {
      color: red;
      font-size: 0.9em;
      margin-top: 5px;
      height: 1.2em; /* Hata mesajı alanı için yer ayırma */
 }

    </style>
</head>
<body>
    <div id="login">
        <h2>Giriş Yap</h2>
        <input id="loginUsername" placeholder="Kullanıcı Adı (TC Kimlik)">
        <input id="loginPassword" type="password" placeholder="Şifre">
        <button id="loginButton">Giriş</button>
        <div class="error" id="loginError"></div>
    </div>
    <div class="container">
        <div class="tab">
            <button class="tablinks" data-tab="personel">Personel</button>
            <button class="tablinks" data-tab="izin">İzin</button>
             <button class="tablinks" data-tab="tatiller">Tatiller</button>
            <button class="tablinks admin-only" data-tab="kullanicilar">Kullanıcılar</button>
            <button class="tablinks admin-only" data-tab="ayarlar">Ayarlar</button>
            <button class="tablinks admin-only" data-tab="gecmis">Geçmiş</button>
            <div class="user-controls">
                <span id="currentUserDisplayName"></span>
                <button id="changePasswordButton">Şifre Değiştir</button>
                <button id="logoutButton">Çıkış</button>
            </div>
        </div>
        <div id="personel" class="tabcontent">
            <h3>Personel İşlemleri</h3>
            <div class="add-filter-controls"> <button class="add-button" id="addPersonelButton">Yeni Personel Ekle</button>
                <button class="filter-toggle-button" id="togglePersonelFiltersButton">Filtreleri Göster</button> </div>
            <div class="filter-controls" id="personelFilterControls">
                <div>
                    <label for="personelUnvanFilter">Ünvan</label>
                    <select id="personelUnvanFilter">
                        <option value="">Tümü</option>
                    </select>
                </div>
                <div>
                    <label for="personelIsYeriFilter">İş Yeri</label>
                    <select id="personelIsYeriFilter">
                        <option value="">Tümü</option>
                        <option>Konya</option>
                        <option>Selçuklu</option>
                    </select>
                </div>
                <div>
                    <label for="personelKanFilter">Kan Grubu</label>
                    <select id="personelKanFilter">
                        <option value="">Tümü</option>
                        <option>A+</option>
                        <option>A-</option>
                        <option>B+</option>
                        <option>B-</option>
                        <option>O+</option>
                        <option>O-</option>
                        <option>AB+</option>
                        <option>AB-</option>
                    </select>
                </div>
                <div>
                    <label for="personelTahsilFilter">Tahsil</label>
                    <select id="personelTahsilFilter">
                        <option value="">Tümü</option>
                    </select>
                </div>
                <div>
                    <label for="personelIlceFilter">İlçe</label>
                    <select id="personelIlceFilter">
                        <option value="">Tümü</option>
                        <option>Karatay</option>
                        <option>Meram</option>
                        <option>Selçuklu</option>
                    </select>
                </div>
                <div style="grid-column: 1 / -1; text-align: right;">
                    <button id="applyPersonelFilters">Filtrele</button>
                </div>
            </div>
            <div class="form-container" id="personelFormContainer">
                 <h4>Personel Bilgileri</h4>
                 <div class="form-grid">
                    <input type="hidden" id="editPersonelId"> <div>
                        <label for="isYeriInput">İş Yeri</label>
                        <select id="isYeriInput">
                            <option value="">İş Yeri Seçiniz</option>
                            <option>Konya</option>
                            <option>Selçuklu</option>
                        </select>
                    </div>
                    <div>
                        <label for="unvanSelect">Ünvan</label>
                        <select id="unvanSelect">
                            <option value="">Ünvan Seçiniz</option>
                         </select>
                    </div>
                    <div>
                        <label for="adSoyadInput">Ad Soyad</label>
                        <input id="adSoyadInput" placeholder="Ad Soyad">
                    </div>
                    <div>
                        <label for="tcInput">TC Kimlik <span style="color:red;">*</span></label>
                        <input id="tcInput" placeholder="TC Kimlik (Zorunlu)">
                    </div>
                    <div>
                        <label for="gsmInput">GSM</label>
                        <input id="gsmInput" placeholder="GSM">
                    </div>
                    <div>
                        <label for="kanInput">Kan Grubu</label>
                        <select id="kanInput">
                            <option value="">Kan Grubu Seçiniz</option>
                            <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
                            <option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
                        </select>
                    </div>
                    <div>
                        <label for="iseInput">İşe Başlama Tarihi <span style="color:red;">*</span></label>
                        <input type="date" id="iseInput">
                    </div>
                    <div>
                        <label for="dogumInput">Doğum Tarihi</label>
                        <input type="date" id="dogumInput">
                    </div>
                    <div>
                        <label for="tahsilInput">Tahsili</label>
                        <select id="tahsilInput">
                            <option value="">Tahsili Seçiniz</option>
                         </select>
                    </div>
                    <div>
                        <label for="plakaInput">Plaka</label>
                        <input id="plakaInput" placeholder="Plaka">
                    </div>
                    <div>
                        <label for="emailInput">E-Posta</label>
                        <input type="email" id="emailInput" placeholder="E-Posta Adresi">
                    </div>
                    <div>
                        <label for="tiybInput">TİYB Geç.Süresi</label>
                        <input type="date" id="tiybInput">
                    </div>
                    <div>
                        <label for="pmTarihiInput">PM Tarihi</label>
                        <input type="date" id="pmTarihiInput">
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label for="adresInput">Adres</label>
                        <textarea id="adresInput" placeholder="Ev Adresi"></textarea>
                    </div>
                    <div>
                        <label for="ilceInput">İlçe</label>
                        <select id="ilceInput">
                            <option value="">İlçe Seçiniz</option>
                            <option>Karatay</option>
                            <option>Meram</option>
                            <option>Selçuklu</option>
                        </select>
                    </div>
                    <div style="grid-column: 1 / -1; margin-top: 10px;">
                        <label for="personelFotoInput">Personel Fotoğrafı</label>
                        <input type="file" id="personelFotoInput" accept="image/*" style="display: block; margin-bottom: 10px;">
                        <img id="personelFotoPreview" src="#" alt="Fotoğraf Önizleme" style="max-width: 150px; max-height: 150px; border: 1px solid #ccc; display: none; object-fit: cover;">
                        <button type="button" id="removePersonelFotoButton" style="display: none; margin-top: 5px; background-color: #d9534f; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px;">Fotoğrafı Kaldır</button>
                    </div>

                    <div id="passiveInfoDisplay" style="grid-column: 1 / -1; display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                         <strong>Pasif Bilgileri:</strong>
                         <p>Durum: <span id="passiveStatus"></span></p>
                         <p>Ayrılma Sebebi: <span id="passiveReason"></span></p>
                         <p>Ayrılma Tarihi: <span id="passiveDate"></span></p>
                    </div>
                </div>
                <div class="form-actions">
                    <button id="togglePassiveButton" class="passive-button" style="display: none;"></button>
                    <button id="deletePersonelButton" class="passive-button" style="display: none;">Sil</button> <button id="savePersonelButton">Kaydet</button>
                </div>
            </div>
            <table id="personelTable">
                <thead>
                    <tr>
                        <th>Ünvan</th>
                        <th>Ad Soyad</th>
                        <th>İşe Başlama</th>
                        <th>Yıllık İzin Hakkı</th>
                        <th>Kalan İzin Gün Sayısı</th>
                        <th>İzin Dönem Baş.</th>
                        <th>İzin Dönem Bit.</th>
                        <th>İşlem</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        <div id="izin" class="tabcontent">
            <h3>İzin İşlemleri</h3>
             <div class="add-filter-controls"> <button class="add-button" id="addIzinButton">Yeni İzin Ekle</button>
                 <button class="filter-toggle-button" id="toggleIzinFiltersButton">Filtreleri Göster</button> </div>
            <div class="filter-controls" id="izinFilterControls">
                <div>
                    <label for="izinPersonelFilter">Personel</label>
                    <select id="izinPersonelFilter">
                        <option value="">Tümü</option>
                         </select>
                </div>
                <div>
                    <label for="izinDateStart">Başlangıç Tarihi</label>
                    <input type="date" id="izinDateStart">
                </div>
                <div>
                    <label for="izinDateEnd">Bitiş Tarihi</label>
                    <input type="date" id="izinDateEnd">
                </div>
                <div>
                    <label for="izinTurFilter">İzin Türü</label>
                    <select id="izinTurFilter">
                        <option value="">Tümü</option>
                         </select>
                </div>
                <div style="grid-column: 1 / -1; text-align: right;">
                    <button id="applyIzinFilters">Filtrele</button>
                </div>
            </div>
            <div class="form-container" id="izinFormContainer">
                <h4>İzin Bilgileri</h4>
                <div class="form-grid">
                    <input type="hidden" id="editIzinId">
                    <div>
                        <label for="izinPersonelSelect">Personel <span style="color:red;">*</span></label>
                        <select id="izinPersonelSelect">
                            <option value="">Personel Seçiniz</option>
                         </select>
                    </div>
                    <div>
                        <label for="izinTurSelect">İzin Türü <span style="color:red;">*</span></label>
                        <select id="izinTurSelect">
                            </select>
                    </div>
                    <div>
                        <label for="izinBasInput">Başlangıç Tarihi <span style="color:red;">*</span></label>
                        <input type="date" id="izinBasInput">
                    </div>
                    <div>
                        <label for="izinBitInput">Bitiş Tarihi <span style="color:red;">*</span></label>
                        <input type="date" id="izinBitInput">
                    </div>
                </div>
                <div class="form-actions">
                     <button id="deleteIzinButton" class="passive-button" style="display: none;">Sil</button> <button id="saveIzinButton">Kaydet</button>
                </div>
            </div>
            <table id="izinTable">
                <thead>
                    <tr>
                        <th>Personel</th>
                        <th>Tür</th>
                        <th>Başlangıç</th>
                        <th>Bitiş</th>
                        <th>Gün</th>
                        <th>İşlem</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <div id="tatiller" class="tabcontent">
            <h3>Tatil Takvimi</h3>
            <div class="year-selection">
                <button class="year-button" data-year="2025">2025</button>
                <button class="year-button" data-year="2026">2026</button>
                <button class="year-button" data-year="2027">2027</button>
                <button class="year-button" data-year="2028">2028</button>
            </div>
            <div id="holidayDetails" class="holiday-list" style="display: none;">
                 <h4><span id="selectedYear"></span> Yılı Ulusal Bayramları</h4>
                 <ul id="nationalHolidayList" class="settings-list">
                    </ul>
                 </div>
             <div class="holiday-save-button" id="holidaySaveButton" style="display: none;">
                 <button id="saveHolidayDatesButton">Tarihleri Kaydet</button>
            </div>
        </div>

        <div id="kullanicilar" class="tabcontent">
            <h3>Kullanıcı Yönetimi</h3>
            <button class="add-button" id="addKullaniciButton">Yeni Kullanıcı Ekle</button>
            <div class="form-container" id="kullaniciFormContainer">
                <h4>Kullanıcı Bilgileri</h4>
                <div class="form-grid">
                    <input type="hidden" id="editUserId">
                    <div>
                        <label for="userPersonelSelect">Personel <span style="color:red;">*</span></label>
                        <select id="userPersonelSelect"></select>
                    </div>
                    <div>
                        <label for="userRoleSelect">Rol <span style="color:red;">*</span></label>
                        <select id="userRoleSelect">
                            <option value="Yönetici">Yönetici</option>
                            <option value="Kullanıcı">Kullanıcı</option>
                            <option value="İzleyici">İzleyici</option>
                        </select>
                    </div>
                    <div>
                        <label for="passwordInput">Şifre <span id="passwordRequired" style="color:red;">*</span></label>
                        <input id="passwordInput" type="password" placeholder="Şifre">
                    </div>
                     <div style="grid-column: 1 / -1;">
                        <label id="userPermissionsLabel" class="permission-section-title">Yetkilendirilen Ünvanlar ve İşlemler:</label>
                        <div id="userPermissions">
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button id="saveUserButton">Kaydet</button>
            </div>
            </div>
            <table id="userTable">
                <thead>
                    <tr>
                        <th>Personel</th>
                        <th>Kullanıcı Adı (TC Kimlik)</th>
                        <th>Rol</th>
                        <th>İşlem</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        <div id="ayarlar" class="tabcontent">
            <h3>Ayarlar</h3>
             <div class="tabcontent-inner">
                <div class="settings-section">
                     <h4 class="collapsible-header">Unvanlar</h4>
                     <div class="collapsible-content">
                        <div class="settings-form">
                            <input id="newUnvanInput" type="text" placeholder="Yeni Ünvan Ekle">
                            <button id="addUnvanButton">Ekle</button>
                        </div>
                        <ul id="unvanList" class="settings-list">
                        </ul>
                    </div>
                </div>
                <div class="settings-section">
                    <h4 class="collapsible-header">İzin Türleri</h4>
                    <div class="collapsible-content">
                        <div class="settings-form">
                            <input id="newIzinTurInput" type="text" placeholder="Yeni İzin Türü Ekle">
                            <button id="addIzinTurButton">Ekle</button>
                        </div>
                        <ul id="izinTurList" class="settings-list">
                            </ul>
                    </div>
                </div>
                <div class="settings-section">
                    <h4 class="collapsible-header">Tahsil Listesi</h4>
                     <div class="collapsible-content">
                        <div class="settings-form">
                            <input id="newTahsilInput" type="text" placeholder="Yeni Tahsil Ekle">
                            <button id="addTahsilButton">Ekle</button>
                        </div>
                        <ul id="tahsilList" class="settings-list">
                            </ul>
                 </div>
                </div>
                 <div class="settings-section">
                     <h4 class="collapsible-header">Ayrılma Sebepleri</h4>
                     <div class="collapsible-content">
                         <div class="settings-form">
                           <input id="newAyrilmaSebebiInput" type="text" placeholder="Yeni Sebep Ekle">
                           <button id="addAyrilmaSebebiButton">Ekle</button>
                         </div>
                        <ul id="ayrilmaSebebiList" class="settings-list">
                           </ul>
                    </div>
                 </div>
                 <div class="settings-section">
                      <h4 class="collapsible-header">Şirket İsimleri</h4>
                    <div class="collapsible-content">
                         <div class="settings-form">
                           <input id="newSirketIsmiInput" type="text" placeholder="Yeni Şirket Adı Ekle">
                           <button id="addSirketIsmiButton">Ekle</button>
                        </div>
                         <ul id="sirketIsmiList" class="settings-list">
                           </ul>
                     </div>
                </div>
                 <div class="settings-section">
                      <h4 class="collapsible-header">Ulusal Bayramlar</h4>
                     <div class="collapsible-content">
                         <div class="settings-form">
                           <input id="newUlusalBayramInput" type="text" placeholder="Yeni Ulusal Bayram Ekle">
                           <button id="addUlusalBayramButton">Ekle</button>
                        </div>
                        <ul id="ulusalBayramList" class="settings-list">
                           </ul>
                     </div>
                 </div>
                 <div class="settings-section">
                     <h4 class="collapsible-header">Yeni Sayısal Ayar</h4>
                      <div class="collapsible-content">
                         <div class="settings-form">
                           <label for="numericalSettingInput">Değer Girin:</label>
                           <input id="numericalSettingInput" type="number" placeholder="Sayısal Değer">
                           <button id="updateNumericalSettingButton">Güncelle</button>
                        </div>
                      </div>
                </div>
            </div>
        </div>
        <div id="gecmis" class="tabcontent">
            <h3>İşlem Geçmişi</h3>
             <div class="add-filter-controls">
                 <button class="filter-toggle-button" id="toggleGecmisFiltersButton">Filtreleri Göster</button>
            </div>
             <div class="filter-controls" id="gecmisFilterControls">
                 <div>
                    <label for="gecmisDateStart">Başlangıç Tarihi:</label>
                    <input type="date" id="gecmisDateStart">
                </div>
                <div>
                    <label for="gecmisDateEnd">Bitiş Tarihi:</label>
                    <input type="date" id="gecmisDateEnd">
                </div>
                <div>
                    <label for="gecmisUserFilter">İşlem Yapan Kullanıcı:</label>
                    <select id="gecmisUserFilter">
                        <option value="">Tümü</option>
                    </select>
                </div>
                <div>
                    <label for="gecmisAffectedPersonelFilter">İşlem Yapılan Personel:</label>
                    <select id="gecmisAffectedPersonelFilter">
                        <option value="">Tümü</option>
                     </select>
                </div>
                <div>
                    <label for="gecmisItemTypeFilter">Öğe Tipi:</label>
                    <select id="gecmisItemTypeFilter">
                        <option value="">Tümü</option>
                        <option value="Personel">Personel</option>
                        <option value="İzin">İzin</option>
                        <option value="Kullanıcı">Kullanıcı</option>
                        <option value="Sistem">Sistem</option>
                        <option value="Ayarlar">Ayarlar</option>
                        <option value="Tatiller">Tatiller</option>
                    </select>
                </div>
                <div>
                    <label for="gecmisDescriptionSearch">Açıklama Ara:</label>
                    <input type="text" id="gecmisDescriptionSearch" placeholder="Açıklama...">
                </div>
                <div style="grid-column: 1 / -1; text-align: right;">
                    <button id="applyGecmisFilters">Filtrele</button>
                </div>
            </div>
            <table id="gecmisTable">
                <thead>
                    <tr>
                        <th>Zaman</th>
                        <th>Kullanıcı</th>
                        <th>Tip</th>
                        <th>Öğe Tipi</th>
                        <th>İlgili Personel</th>
                        <th>Açıklama</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
    <div id="personelDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePersonelDetailModal()">×</span>
            <h4>Personel Detayları</h4>
            <div class="modal-details">
            </div>
        </div>
    </div>
    <div id="userDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUserDetailModal()">×</span>
            <h4>Kullanıcı Detayları ve Yetkileri</h4>
            <div class="modal-details" id="userDetailContent">
                </div>
        </div>
    </div>
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChangePasswordModal()">×</span>
            <h4>Şifre Değiştir</h4>
            <div class="form-grid">
                <div>
                    <label for="currentPasswordInput">Mevcut Şifre <span style="color:red;">*</span></label>
                    <input type="password" id="currentPasswordInput">
                </div>
                <div>
                    <label for="newPasswordInput">Yeni Şifre <span style="color:red;">*</span></label>
                    <input type="password" id="newPasswordInput">
                </div>
                <div>
                    <label for="confirmNewPasswordInput">Yeni Şifre (Tekrar) <span style="color:red;">*</span></label>
                    <input type="password" id="confirmNewPasswordInput">
                </div>
            </div>
            <div class="error" id="passwordChangeError" style="grid-column: 1 / -1; text-align: center; margin-bottom: 10px;">
                 </div>
            <div class="form-actions">
                <button id="savePasswordButton">Şifreyi Değiştir</button>
            </div>
        </div>
    </div>
     <div id="changeOtherPasswordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChangeOtherPasswordModal()">×</span>
            <h4>Kullanıcı Şifresini Değiştir</h4>
             <input type="hidden" id="otherUserIdToChangePassword">
             <p>Kullanıcı: <strong id="otherUserDisplayName"></strong></p>
            <div class="form-grid">
                <div>
                    <label for="otherNewPasswordInput">Yeni Şifre <span style="color:red;">*</span></label>
                    <input type="password" id="otherNewPasswordInput">
                </div>
                <div>
                    <label for="otherConfirmNewPasswordInput">Yeni Şifre (Tekrar) <span style="color:red;">*</span></label>
                    <input type="password" id="otherConfirmNewPasswordInput">
                </div>
            </div>
            <div class="error" id="otherPasswordChangeError" style="grid-column: 1 / -1; text-align: center; margin-bottom: 10px;">
                 </div>
            <div class="form-actions">
                <button id="saveOtherPasswordButton">Şifreyi Değiştir</button>
            </div>
        </div>
    </div>
    <div id="ayrilmaSebebiModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAyrilmaSebebiModal()">×</span>
            <h4>Personeli Pasife Alma</h4>
             <input type="hidden" id="personelIdToPassive">
             <div class="form-grid">
                <div>
                    <label for="ayrilmaSebebiSelect">Ayrılma Sebebi <span style="color:red;">*</span></label>
                    <select id="ayrilmaSebebiSelect">
                         <option value="">Sebep Seçiniz</option>
                         </select>
                </div>
                <div>
                    <label for="ayrilmaTarihiInput">Ayrılma Tarihi <span style="color:red;">*</span></label>
                    <input type="date" id="ayrilmaTarihiInput">
                </div>
            </div>
             <div class="error" id="ayrilmaSebebiError" style="grid-column: 1 / -1; text-align: center; margin-bottom: 10px;">
                 </div>
            <div class="form-actions">
                <button id="saveAyrilmaSebebiButton">Pasife Al ve Kaydet</button>
            </div>
        </div>
    </div>

    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeConfirmDeleteModal()">×</span>
            <h4>Silme İşlemi Onayı</h4>
            <p id="confirmDeleteMessage"></p>
             <div id="deleteReasonContainer">
                 <label for="deleteReasonInput">Silme Nedeni:</label>
                 <textarea id="deleteReasonInput" placeholder="Silme nedenini en az 10 karakter olarak giriniz." minlength="10"></textarea>
                 <div class="error" id="deleteReasonError"></div>
            </div>
            <div class="form-actions" style="text-align: center; margin-top: 20px;">
                <button id="confirmDeleteButton" class="passive-button">Sil</button>
                <button onclick="closeConfirmDeleteModal()" style="background-color: #6c757d;">İptal</button>
            </div>
        </div>
    </div>
    <script>
        // Yerel depolamadan verileri yükle veya başlangıç verilerini kullan
        let personeller = JSON.parse(localStorage.getItem('personeller') || '[]');
        let izinler = JSON.parse(localStorage.getItem('izinler') || '[]');
        let users = JSON.parse(localStorage.getItem('users') || '[]');
        let gecmis = JSON.parse(localStorage.getItem('gecmis') || '[]');
        // Başlangıç verilerini sıralayarak kaydet
        let unvanlar = JSON.parse(localStorage.getItem('unvanlar') || '["Yolcu Hizmetleri Şefi","Kabin Hizmetleri Grup Şef Yard.","Gişe Personeli Grup Şef Yard.","Gişe Personeli","Kabin Personeli","Kabin Amiri","Turuncu Masa Personeli","Taşıyıcı Personel"]').sort((a, b) => a.localeCompare(b, 'tr'));
        let izinTurileri = JSON.parse(localStorage.getItem('izinTurileri') || '["Yıllık İzin", "Sendika İzni", "Takas İzin", "Rapor İzni"]').sort((a, b) => a.localeCompare(b, 'tr'));
        // Yeni: Ayrılma Sebepleri listesi
        let ayrilmaSebepleri = JSON.parse(localStorage.getItem('ayrilmaSebepleri') || '["İstifa","Emeklilik","Vefat","Geçici Görev Sonu","Diğer"]').sort((a, b) => a.localeCompare(b, 'tr'));
        // Yeni: Ulusal Bayramlar listesi (Ayarlar'dan taşındı ve adı değiştirildi)
        let ulusalBayramlar = JSON.parse(localStorage.getItem('ulusalBayramlar') || '["Cumhuriyet Bayramı", "Zafer Bayramı", "Gençlik ve Spor Bayramı", "Emek ve Dayanışma Günü", "Ulusal Egemenlik ve Çocuk Bayramı", "Demokrasi ve Milli Birlik Günü", "Ramazan Bayramı", "Kurban Bayramı", "Yılbaşı"]').sort((a, b) => a.localeCompare(b, 'tr'));
        // Yeni: Şirket İsimleri listesi
        let sirketIsimleri = JSON.parse(localStorage.getItem('sirketIsimleri') || '["Şirket Adı 1", "Şirket Adı 2"]').sort((a, b) => a.localeCompare(b, 'tr'));
        // YENİ EKLENEN SAYISAL AYAR DEĞİŞKENİ
        let numericalSetting = JSON.parse(localStorage.getItem('numericalSetting') || '0');
        // Yeni: Tatil tarihleri için yapı (Yıl Bazlı)
         // Örnek: { "2025": [{ name: "Cumhuriyet Bayramı", date: "2025-10-29" }, { name: "Yılbaşı", date: "2025-01-01" }], "2026": [...] }
         let holidayDatesByYear = JSON.parse(localStorage.getItem('holidayDatesByYear') || '{}');
        let currentUser = null; // Giriş yapan kullanıcı bilgisi

        let currentPersonelFotoBase64 = null; // Seçilen/yüklenen fotoğrafı base64 olarak tutacak global değişken

        // Yönetici hesabı (eğer mevcut değilse ekle)
        const adminTc = '38347417748';
        const adminPassword = '50375';

        // Eğer yönetici kullanıcı listesinde yoksa ekle
        // Ayrıca, başlangıçta sadece TC ve şifre ile ekleyelim, diğer alanlar ilk login sonrası Personel ile eşleşince dolabilir
        const adminUserExists = users.some(u => u.username === adminTc);
        if (!adminUserExists) {
            const initialAdminUser = {
                id: Date.now() + 1, // Benzersiz ID
                personelId: null, // Yönetici doğrudan bir personele bağlı olmayabilir
                username: adminTc,
                password: adminPassword,
                role: 'Yönetici',
                permissions: {} // Yönetici tüm ünvanlarda tam yetkiye sahip (permissions objesi boş kalsın)
            };
            // Mevcut users dizisine ekle
            users.push(initialAdminUser);
            localStorage.setItem('users', JSON.stringify(users));
            console.log("Initial admin user added.");
        } else {
             // Yönetici varsa permissions objesini boşalt (tüm yetkilere sahip olduğunu belirtmek için)
             users = users.map(u => u.username === adminTc ? { ...u, permissions: {} } : u);
             localStorage.setItem('users', JSON.stringify(users));
             console.log("Admin user permissions ensured (empty for full access).");
        }


        // Genel silme onay modalı için değişkenler
        let currentDeleteItem = null; // Silinecek öğeyi (personel veya izin) geçici olarak saklamak için değişken
        let currentDeleteType = ''; // Silinecek öğenin tipini (personel veya izin) saklamak için değişken
        let currentDeleteElementId = ''; // Silme işlemi tetikleyen elementin ID'si (örn: personel formundaki sil butonu)


        /**
         * İşlem geçmişine yeni bir kayıt ekler.
         * @param {string} type - İşlem tipi (Ekleme, Güncelleme, Silme, Giriş, Çıkış, vb.)
         * @param {string} itemType - İşlemin ilgili olduğu öğe tipi (Personel, İzin, Kullanıcı, Sistem, Ayarlar, Tatiller)
         * @param {string} description - İşlemin kısa açıklaması
         * @param {number} [personelId=null] - İşlemin ilgili olduğu personelin ID'si (isteğe bağlı)
         */
        function logAction(type, itemType, description, personelId = null) { // personelId parametresi eklendi
            const now = new Date();
            const timestampISO = now.toISOString(); // ISO formatında zaman damgası
            // Kullanıcıya gösterilecek daha okunaklı zaman damgası
            const timestampDisplay = `${now.toLocaleDateString('tr-TR')} ${now.toLocaleTimeString('tr-TR')}`;
            const user = currentUser ? (currentUser.adSoyad || currentUser.username) : 'Bilinmiyor';
            // Geçmiş listesini belirli bir boyutta tut (örneğin son 200 kayıt)
            if (gecmis.length >= 200) {
                gecmis.shift(); // En eski kaydı sil
            }
            gecmis.push({ timestamp: timestampISO, timestampDisplay, user, type, itemType, description, personelId }); // personel ID kaydedildi
            localStorage.setItem('gecmis', JSON.stringify(gecmis));
            // Eğer geçmiş tabı açıksa, tabloyi yeniden render et
            const activeTab = document.querySelector('.tablinks.active');
            if (activeTab && activeTab.dataset.tab === 'gecmis') {
                renderGecmis();
            }
        }

        /**
         * Farklı alanlar için personel, izin türü, ünvan, tahsil ve ayrılma sebebi select (dropdown) seçeneklerini doldurur.
         */
        function renderSelects() {
            const izinPersonelSelect = document.getElementById('izinPersonelSelect');
            const userPersonelSelect = document.getElementById('userPersonelSelect');
            const izinPersonelFilter = document.getElementById('izinPersonelFilter');
            const personelUnvanSelect = document.getElementById('unvanSelect');
            const personelUnvanFilter = document.getElementById('personelUnvanFilter');
            const izinTurSelect = document.getElementById('izinTurSelect');
            const izinTurFilter = document.getElementById('izinTurFilter');
            const personelTahsilSelect = document.getElementById('tahsilInput');
            const personelTahsilFilter = document.getElementById('personelTahsilFilter');
            const personelIsYeriFilter = document.getElementById('personelIsYeriFilter');
            const gecmisUserFilter = document.getElementById('gecmisUserFilter');
            const ayrilmaSebebiSelect = document.getElementById('ayrilmaSebebiSelect'); // Yeni ayrılma sebebi select'i
             const gecmisAffectedPersonelFilter = document.getElementById('gecmisAffectedPersonelFilter'); // Yeni eklenen select

            // Select kutularını varsayılan seçeneklerle temizle
            if (izinPersonelSelect) izinPersonelSelect.innerHTML = '<option value="">Personel Seçiniz</option>';
            if (userPersonelSelect) userPersonelSelect.innerHTML = '<option value="">Personel Seçiniz</option>';
            if (izinPersonelFilter) izinPersonelFilter.innerHTML = '<option value="">Tümü</option>';
            if (personelUnvanSelect) personelUnvanSelect.innerHTML = '<option value="">Ünvan Seçiniz</option>';
            if (personelUnvanFilter) personelUnvanFilter.innerHTML = '<option value="">Tümü</option>';
            if (izinTurSelect) izinTurSelect.innerHTML = ''; // İzin türü için "Hepsi" seçeneği ayrı filtrede
            if (izinTurFilter) izinTurFilter.innerHTML = '<option value="">Tümü</option>';
            if (personelTahsilSelect) personelTahsilSelect.innerHTML = '<option value="">Tahsili Seçiniz</option>';
            if (personelTahsilFilter) personelTahsilFilter.innerHTML = '<option value="">Tümü</option>';
            if (personelIsYeriFilter) personelIsYeriFilter.innerHTML = '<option value="">Tümü</option><option>Konya</option><option>Selçuklu</option>'; // Örnek iş yerleri
            if (gecmisUserFilter) gecmisUserFilter.innerHTML = '<option value="">Tümü</option>';
            if (ayrilmaSebebiSelect) ayrilmaSebebiSelect.innerHTML = '<option value="">Sebep Seçiniz</option>'; // Ayrılma sebebi select'i temizlendi
            if (gecmisAffectedPersonelFilter) gecmisAffectedPersonelFilter.innerHTML = '<option value="">Tümü</option>'; // Yeni select temizlendi


            // Personel select kutularını doldur (Ada göre sıralı)
             // Sadece aktif personelleri izin ve kullanıcı select kutularına ekle
            const activePersoneller = personeller.filter(p => !p.isPassive); // Pasif olmayanlar aktif kabul edildi
            const sortedPersonellerForIzinUser = [...activePersoneller].sort((a, b) => (a.adSoyad || '').localeCompare(b.adSoyad || '', 'tr'));
            sortedPersonellerForIzinUser.forEach(p => {
                // ---- BAŞLANGIÇ: Kullanıcı Rolüne Göre Dropdown Personel Filtreleme ----
                let canAddToList = true; 

                if (currentUser && currentUser.role === 'Kullanıcı') {
                    const userManagedUnvans = currentUser.permissions ? Object.keys(currentUser.permissions) : [];
                    // Eğer personel bir ünvana sahip değilse VEYA ünvanı yönetilenler arasında değilse VEYA 'view' yetkisi yoksa listeye ekleme
                    if (!p.unvan || !userManagedUnvans.includes(p.unvan) || !currentUser.permissions[p.unvan]?.includes('view')) {
                        canAddToList = false;
                    }
                }
                // ---- BİTİŞ: Kullanıcı Rolüne Göre Dropdown Personel Filtreleme ----

                // Sadece listeye eklenebiliyorsa option oluştur ve ekle
                if (canAddToList) {
                    const option = new Option(p.adSoyad, p.id);
                    if (izinPersonelSelect) { // izinPersonelSelect değişkeninin yukarıda tanımlı olduğundan emin olun
                        izinPersonelSelect.add(option.cloneNode(true));
                    }

                    // userPersonelSelect değişkeninin yukarıda tanımlı olduğundan emin olun
                    const existingUserForThisPersonel = users.find(u => u.personelId === p.id);
                    if (userPersonelSelect && !existingUserForThisPersonel) {
                         userPersonelSelect.add(option.cloneNode(true));
                    }

                    if (izinPersonelFilter) { // izinPersonelFilter değişkeninin yukarıda tanımlı olduğundan emin olun
                        izinPersonelFilter.add(option.cloneNode(true));
                    }
                }
            });
            // Tüm personelleri (aktif/pasif) geçmiş filtre select kutusuna ekle (Ada göre sıralı)
             const sortedAllPersoneller = [...personeller].sort((a, b) => (a.adSoyad || '').localeCompare(b.adSoyad || '', 'tr'));
            sortedAllPersoneller.forEach(p => {
                 if (gecmisAffectedPersonelFilter) {
                     const option = new Option(`${p.adSoyad} (${p.tc})`, p.id); // Ad Soyad (TC) formatı kullanıldı
                     gecmisAffectedPersonelFilter.add(option);
                 }
            });

            // Ünvan select kutularını doldur (Alfabetik sıralı) - Zaten başlangıçta sıralandı
            unvanlar.forEach(unvan => {
                const option = new Option(unvan, unvan);
                if (personelUnvanSelect) personelUnvanSelect.add(option.cloneNode(true));
                if (personelUnvanFilter) personelUnvanFilter.add(option.cloneNode(true));
            });
            // İzin Türü select kutularını doldur (Alfabetik sıralı) - Zaten başlangıçta sıralandı
            izinTurileri.forEach(tur => {
                const option = new Option(tur, tur);
                if (izinTurSelect) izinTurSelect.add(option.cloneNode(true));
                if (izinTurFilter) izinTurFilter.add(option.cloneNode(true));
            });
            // Tahsil select kutularını doldur (Alfabetik sıralı) - Zaten başlangıçta sıralandı
            tahsiller.forEach(tahsil => {
                const option = new Option(tahsil, tahsil);
                if (personelTahsilSelect) personelTahsilSelect.add(option.cloneNode(true));
                if (personelTahsilFilter) personelTahsilFilter.add(option.cloneNode(true));
            });
            // Yeni: Ayrılma Sebepleri select kutusunu doldur (Alfabetik sıralı) - Zaten başlangıçta sıralandı
             ayrilmaSebepleri.forEach(sebep => {
                 const option = new Option(sebep, sebep);
                 if(ayrilmaSebebiSelect) ayrilmaSebebiSelect.add(option.cloneNode(true));
             });
            // Geçmiş kullanıcı filtre select kutusunu doldur
            const uniqueUsers = [...new Set(gecmis.map(g => g.user))].sort((a, b) => a.localeCompare(b, 'tr'));
            uniqueUsers.forEach(user => {
                if (gecmisUserFilter) gecmisUserFilter.add(new Option(user, user));
            });
        }


        // Giriş Butonu Tıklama Olayı
        const loginButton = document.getElementById('loginButton');
        if (loginButton) {
             loginButton.onclick = () => {
                try { // Hata yakalama eklendi
                    const u = document.getElementById('loginUsername').value;
                    const p = document.getElementById('loginPassword').value;
                    const loginErrorDiv = document.getElementById('loginError');

                    if(loginErrorDiv) loginErrorDiv.innerText = ''; // Hata mesajını temizle

                    // Kullanıcıyı bul ve şifreyi kontrol et
                    const userToLogin = users.find(usr => usr.username === u && usr.password === p);
                    if (userToLogin) {
                        currentUser = { ...userToLogin }; // Giriş yapan kullanıcıyı kaydet

                        // Eğer kullanıcı bir personele bağlıysa ad soyadını al
                        const personel = personeller.find(per => per.id === currentUser.personelId);
                        if (personel) {
                            currentUser.adSoyad = personel.adSoyad; // Kullanıcının rolü 'Kullanıcı' veya 'İzleyici' ise, personelinin ünvan yetkilerini ata (eğer yoksa varsayılan)
                            if (currentUser.role === 'Kullanıcı' || currentUser.role === 'İzleyici') {
                                // Eğer personel ünvanı varsa ve kullanıcının o ünvan için hiç yetkisi tanımlanmamışsa
                                if (personel.unvan && (!currentUser.permissions || !currentUser.permissions[personel.unvan])) { // permissions objesi veya ilgili ünvan yoksa
                                     currentUser.permissions = currentUser.permissions || {}; // permissions objesi yoksa oluştur
                                    currentUser.permissions[personel.unvan] = ['view']; // Varsayılan yetki 'view'
                                }
                            }
                     } else if (currentUser.isSuperAdmin) { // currentUser.username === adminTc yerine isSuperAdmin kullanıldı
                          // Ana yönetici için adSoyad yoksa kullanıcı adını kullan veya özel bir başlık ata
                         currentUser.adSoyad = currentUser.adSoyad || `Ana Yönetici (${currentUser.username})`;
                         currentUser.role = 'Yönetici'; // Ana yönetici her zaman Yönetici rolündedir.
                    } else {
                             // Admin olmayan ve personeli olmayan kullanıcıyı izleyici yap
                             if(currentUser.role !== 'Yönetici') currentUser.role = 'İzleyici';
                        }


                        // Oturum bilgisini yerel depolamaya kaydet
                         localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        showApp(); // Uygulamayı göster
                        logAction('Giriş', 'Sistem', `${currentUser.adSoyad || currentUser.username} giriş yaptı.`);
                    } else {
                         if(loginErrorDiv) loginErrorDiv.innerText = 'Hatalı kullanıcı adı veya şifre.';
                         logAction('Giriş Hatası', 'Sistem', `TC ${u} ile hatalı giriş denemesi.`);
                    }
                 } catch (error) { // Hata yakalandı
                     const loginErrorDiv = document.getElementById('loginError');
                     if(loginErrorDiv) loginErrorDiv.innerText = 'Giriş sırasında bir hata oluştu.';
                     // Kullanıcıya genel bir hata mesajı göster
                     console.error("Login error:", error); // Konsola hatayı yazdır
                     logAction('Giriş Hatası', 'Sistem', `Giriş sırasında hata: ${error.message}`);
                 }
            };
        }


        // Şifre alanına Enter tuşuna basıldığında giriş yap
        const loginPasswordInput = document.getElementById('loginPassword');
        if (loginPasswordInput && loginButton) { // Hem input hem de butonun varlığını kontrol et
            loginPasswordInput.addEventListener('keypress', function(event) {
                // 'Enter' tuşuna basıldı mı kontrol et
                if (event.key === 'Enter') {
                    event.preventDefault(); // Formın otomatik gönderilmesini engelle
                    loginButton.click(); // Giriş butonuna tıkla
                }
            });
        }


        /**
         * Giriş başarılı olduğunda uygulama arayüzünü gösterir.
         */
        function showApp() {
            const loginDiv = document.getElementById('login');
            if(loginDiv) {
                 loginDiv.style.display = 'none';
            } else {
            }
            const containerDiv = document.querySelector('.container');
            if(containerDiv) {
                 containerDiv.style.display = 'block';
            } else {
            }
            // Giriş yapan kullanıcının adını veya kullanıcı adını göster
            const currentUserDisplayNameSpan = document.getElementById('currentUserDisplayName');
            if (currentUserDisplayNameSpan && currentUser) { // currentUser null değilse devam et
                 // "Hoş Geldin" ön ekini kaldırdık, sadece Ad Soyad veya TC Kimlik göster
                currentUserDisplayNameSpan.innerText = currentUser.adSoyad || currentUser.username;
            } else if (!currentUserDisplayNameSpan){
            } else if (!currentUser){
            }

            // Yöneticiye özel tabları göster/gizle
            const adminOnlyTabs = document.querySelectorAll('.tablinks.admin-only');
            adminOnlyTabs.forEach(tab => {
                 const displayStyle = currentUser && currentUser.role === 'Yönetici' ? 'inline-block' : 'none';
                tab.style.display = displayStyle;
            });
            initTabs(); // Tabları başlat
         }

        // Çıkış Butonu Tıklama Olayı
        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
             logoutButton.onclick = () => {
                 if (currentUser) {
                     logAction('Çıkış', 'Sistem', `${currentUser.adSoyad || currentUser.username} çıkış yaptı.`);
                 }
                currentUser = null;
                localStorage.removeItem('currentUser'); // Oturum bilgisini kaldır
                location.reload(); // Sayfayı yeniden yükle
            };
        }

        /**
         * Tab navigasyonunu başlatır ve varsayılan tabı açar.
         */
        function initTabs() {
            const tabs = document.querySelectorAll('.tablinks');
            const contents = document.querySelectorAll('.tabcontent');
            const formContainers = document.querySelectorAll('.form-container');

            tabs.forEach(tab => {
                 // Daha önce eklenmiş listener varsa kaldır (tab geçişlerinde tekrar eklememek için)
                 // Bu senaryoda birden çok kez initTabs çağrılmadığı için gerekli değil, ancak iyi bir pratik.
                 if (tab._tabClickListener) {
                    tab.removeEventListener('click', tab._tabClickListener);
                 }

                 const listener = () => {
                     // Tüm tab içeriklerini ve formları gizle
                    contents.forEach(c => {
                        c.style.display = 'none';
                    });
                    formContainers.forEach(fc => {
                        fc.style.display = 'none';
                    });

                    // Tıklanan tabın içeriğini göster
                    const targetTab = document.getElementById(tab.dataset.tab);
                    if (targetTab) {
                        targetTab.style.display = 'block';
                    } else {
                    }

                    // Tüm tab butonlarından 'active' sınıfını kaldır
                    tabs.forEach(t => t.classList.remove('active'));
                    // Tıklanan tab butonuna 'active' sınıfını ekle
                    tab.classList.add('active');
                    // Açılan taba göre ilgili fonksiyonu çağır
                    if (tab.dataset.tab === 'personel') {
                        clearPersonelForm(); // Formu temizle
                        renderPersonel(); // Personel listesini render et
                         // Personel tabı açıldığında filtreleri gizle ve butonu sıfırla
                         const personelFilterControls = document.getElementById('personelFilterControls');
                         if(personelFilterControls) personelFilterControls.style.display = 'none';
                         const togglePersonelFiltersButton = document.getElementById('togglePersonelFiltersButton');
                         if(togglePersonelFiltersButton) togglePersonelFiltersButton.innerText = 'Filtreleri Göster';
                    } else if (tab.dataset.tab === 'izin') {
                         clearIzinForm(); // Formu temizle
                        renderIzin(); // İzin listesini render et
                         // İzin tabı açıldığında filtreleri gizle ve butonu sıfırla
                         const izinFilterControls = document.getElementById('izinFilterControls');
                         if(izinFilterControls) izinFilterControls.style.display = 'none';
                         const toggleIzinFiltersButton = document.getElementById('toggleIzinFiltersButton');
                         if(toggleIzinFiltersButton) toggleIzinFiltersButton.innerText = 'Filtreleri Göster';
                    } else if (tab.dataset.tab === 'tatiller') { // Yeni Tatiller tabı eklendi
                         renderTatiller(); // Tatiller sayfasını render et

                    } else if (tab.dataset.tab === 'kullanicilar') {
                         clearUserForm(); // Formu temizle
                        renderUsers(); // Kullanıcı listesini render et

                    } else if (tab.dataset.tab === 'ayarlar') {
                         renderSettings(); // Ayarlar sayfasını render et
                         initCollapsibles(); // Ayarlar tabı açıldığında collapsible'ları yeniden başlat
                         loadNumericalSetting(); // YENİ EKLENEN SATIR

                    } else if (tab.dataset.tab === 'gecmis') {
                         renderGecmis(); // Geçmiş listesini render et
                         // Geçmiş tabı açıldığında filtreleri gizle ve butonu sıfırla (Yeni eklendi)
                         const gecmisFilterControls = document.getElementById('gecmisFilterControls');
                         if(gecmisFilterControls) gecmisFilterControls.style.display = 'none';
                         const toggleGecmisFiltersButton = document.getElementById('toggleGecmisFiltersButton');
                         if(toggleGecmisFiltersButton) toggleGecmisFiltersButton.innerText = 'Filtreleri Göster';
                    }

                     // Belirli tablar açıldığında select kutularını yeniden doldur
                    if (['izin', 'kullanicilar', 'personel', 'gecmis'].includes(tab.dataset.tab)) {
                        renderSelects();
                    }

                    // Son açılan tabı yerel depolamaya kaydet
                    localStorage.setItem('lastTab', tab.dataset.tab);
                 };

                tab.addEventListener('click', listener);
                 tab._tabClickListener = listener; // Listener referansını sakla
            });
            // Sayfa yüklendiğinde en son açık olan tabı aç
            let lastTab = localStorage.getItem('lastTab') || 'personel';

             // Eğer son tab yöneticiye özel ise ve kullanıcı yönetici değilse, personel tabını aç
            if (currentUser && currentUser.role !== 'Yönetici' && ['ayarlar', 'gecmis', 'kullanicilar'].includes(lastTab)) { // Kullanıcılar tabı da yöneticiye özel kabul edildi
                lastTab = 'personel';
            }

            // Varsayılan tabı bul ve tıkla (bulamazsa ilk taba tıkla)
            const initialTab = document.querySelector(`.tablinks[data-tab="${lastTab}"]`) || tabs[0];

            if (initialTab) {
                 initialTab.click();
            } else if (tabs.length > 0){ // İlk tab varsa ona tıkla
                 tabs[0].click();
            } else {
            }
         }

         /**
          * Ayarlar tabındaki açılır kapanır (collapsible) başlıkları başlatır.
          */
         function initCollapsibles() {
             // Sadece ayarlar tabı aktifken collapsible'ları başlat
             const ayarlarTabContent = document.getElementById('ayarlar');
             if (!ayarlarTabContent || ayarlarTabContent.style.display !== 'block') {
                 return; // Ayarlar tabı aktif değilse veya bulunamazsa çık
             }

             const collapsibles = ayarlarTabContent.querySelectorAll('.collapsible-header');
             collapsibles.forEach(header => {
                 // Daha önce eklenmiş listener varsa kaldır (tab geçişlerinde tekrar eklememek için)
                 if (header._collapsibleListener) {
                      header.removeEventListener('click', header._collapsibleListener);
                 }

                 const listener = function() {
                     this.classList.toggle('active');
                     const content = this.nextElementSibling; // Başlığın bir sonraki kardeşi içeriktir

                     if (content && content.classList.contains('collapsible-content')) { // İçerik elementinin varlığını ve sınıfını kontrol et
                         // Display özelliği ile aç/kapa
                         if (content.style.display === 'block') {
                              content.style.display = 'none';
                         } else {
                              content.style.display = 'block';
                          }

                          // Alternatif: max-height geçişi (CSS'te de ayarlanmalı)
                           /*
                          if (content.style.maxHeight) {
                              content.style.maxHeight = null;
                         } else {
                              content.style.maxHeight = content.scrollHeight + "px";
                         }
                          */
                     } else {
                     }
                 };
                 header.addEventListener('click', listener);
                 header._collapsibleListener = listener; // Listener referansını sakla
             });
         }

        /**
         * Personel formunu temizler.
         */
        function clearPersonelForm() {
            const form = document.getElementById('personelFormContainer');
            if(form) form.querySelectorAll('input:not([type="hidden"]), select, textarea').forEach(el => el.value = ''); // Tüm inputları temizle (hidden hariç)
            const editPersonelId = document.getElementById('editPersonelId');
            if(editPersonelId) editPersonelId.value = '';

             // Select kutularını varsayılan değere sıfırla
             const unvanSelect = document.getElementById('unvanSelect');
             if(unvanSelect) unvanSelect.value = '';
             const kanInput = document.getElementById('kanInput');
             if(kanInput) kanInput.value = '';
             const isYeriInput = document.getElementById('isYeriInput');
             if(isYeriInput) isYeriInput.value = '';
             const pmTarihiInput = document.getElementById('pmTarihiInput');
             if(pmTarihiInput) pmTarihiInput.value = '';
            const ilceInput = document.getElementById('ilceInput');
             if(ilceInput) ilceInput.value = '';
             const tahsilInput = document.getElementById('tahsilInput');
             if(tahsilInput) tahsilInput.value = '';
             // Pasif bilgileri alanını gizle
             const passiveInfoDisplay = document.getElementById('passiveInfoDisplay');
             if(passiveInfoDisplay) passiveInfoDisplay.style.display = 'none';

             // Pasife Al/Aktif Yap butonunu gizle
             const togglePassiveButton = document.getElementById('togglePassiveButton');
             if(togglePassiveButton) togglePassiveButton.style.display = 'none';

             // "Sil" butonunu gizle (form temizlenirken)
             const deletePersonelButton = document.getElementById('deletePersonelButton');
             if(deletePersonelButton) deletePersonelButton.style.display = 'none';

             // "Kaydet" butonunu göster
             const saveButton = document.getElementById('savePersonelButton');
             if(saveButton) saveButton.style.display = 'inline-block';

            // ---- BAŞLANGIÇ: Fotoğraf Alanlarını Temizle ----
            const personelFotoInput = document.getElementById('personelFotoInput');
            const personelFotoPreview = document.getElementById('personelFotoPreview');
            const removePersonelFotoButton = document.getElementById('removePersonelFotoButton');

            if (personelFotoInput) {
                personelFotoInput.value = ""; // Dosya seçimini temizle
            }
            if (personelFotoPreview) {
                personelFotoPreview.style.display = 'none';
                personelFotoPreview.setAttribute('src', '#'); // Önizleme src'sini sıfırla
            }
            if (removePersonelFotoButton) {
                removePersonelFotoButton.style.display = 'none'; // Kaldır butonunu gizle
            }
            currentPersonelFotoBase64 = null; // Global base64 değişkenini sıfırla
            // ---- BİTİŞ: Fotoğraf Alanlarını Temizle ----
        }

        /**
         * İzin formunu temizler.
         */
        function clearIzinForm() {
            const form = document.getElementById('izinFormContainer');
            if(form) form.querySelectorAll('input:not([type="hidden"]), select').forEach(el => el.value = ''); // Tüm inputları temizle (hidden hariç)
            const editIzinId = document.getElementById('editIzinId');
            if(editIzinId) editIzinId.value = '';

            const izinPersonelSelect = document.getElementById('izinPersonelSelect');
             if(izinPersonelSelect) izinPersonelSelect.value = '';
             const izinTurSelect = document.getElementById('izinTurSelect');
             // İzin türü select'ini varsa ilk türe ayarla veya boşalt
             if(izinTurSelect) izinTurSelect.value = izinTurileri.length > 0 ? izinTurileri[0] : '';

             // "Sil" butonunu gizle (form temizlenirken)
             const deleteIzinButton = document.getElementById('deleteIzinButton');
             if(deleteIzinButton) deleteIzinButton.style.display = 'none';
        }

        /**
         * Kullanıcı formunu temizler.
         */
        function clearUserForm() {
            const form = document.getElementById('kullaniciFormContainer');
            if(form) form.querySelectorAll('input:not([type="hidden"]), select').forEach(el => el.value = ''); // Hidden hariç inputları ve selectleri temizle
            const editUserId = document.getElementById('editUserId');
            if(editUserId) editUserId.value = '';

            const userPersonelSelect = document.getElementById('userPersonelSelect');
            if(userPersonelSelect) {
                 userPersonelSelect.value = '';
                 userPersonelSelect.disabled = false; // Yeni kullanıcı eklerken personel seçici etkin olmalı
            }

            const userRoleSelect = document.getElementById('userRoleSelect');
            if(userRoleSelect) userRoleSelect.value = 'Kullanıcı'; // Varsayılan rol

            const passwordInput = document.getElementById('passwordInput');
            if(passwordInput) passwordInput.value = ''; // Şifre alanını boşalt

            const passwordRequiredSpan = document.getElementById('passwordRequired');
            if (passwordRequiredSpan) passwordRequiredSpan.style.display = 'inline'; // Şifre zorunlu işaretini göster

            const permissionsDiv = document.getElementById('userPermissions');
            if (permissionsDiv) {
                permissionsDiv.innerHTML = ''; // Yetki checkbox'larını temizle
            }

            // Yönetici rolü sınıfını kaldır
             if(form) form.classList.remove('admin-role');
        }

        /**
         * Personel formunu gösterir.
         */
        function showPersonelForm() {
            const form = document.getElementById('personelFormContainer');
            if(form) form.style.display = 'block';
             renderSelects(); // Select kutularını doldur
         }

        /**
         * Personel formunu gizler ve temizler.
         */
        function hidePersonelForm() {
            const form = document.getElementById('personelFormContainer');
            if(form) form.style.display = 'none';
            clearPersonelForm();
         }

        /**
         * İzin formunu gösterir.
         */
        function showIzinForm() {
            const form = document.getElementById('izinFormContainer');
            if(form) form.style.display = 'block';
             renderSelects(); // Select kutularını doldur
         }

        /**
         * İzin formunu gizler ve temizler.
         */
        function hideIzinForm() {
            const form = document.getElementById('izinFormContainer');
            if(form) form.style.display = 'none';
            clearIzinForm();
         }

        /**
         * Kullanıcı formunu gösterir.
         * Düzenleme modunda ise kullanıcı bilgilerini ve yetkilerini yükler.
         * @param {number|null} userId - Düzenlenecek kullanıcının ID'si veya yeni kullanıcı için null.
         */
        function showKullaniciForm(userId = null) {
            const formContainer = document.getElementById('kullaniciFormContainer');
            if (!formContainer) {
                 return;
            }
            formContainer.style.display = 'block';

            const passwordInput = document.getElementById('passwordInput');
            const passwordRequiredSpan = document.getElementById('passwordRequired');
            const editUserIdInput = document.getElementById('editUserId');
            const userPersonelSelect = document.getElementById('userPersonelSelect');
            const userRoleSelect = document.getElementById('userRoleSelect');

            if(passwordInput) passwordInput.value = ''; // Şifre alanını her zaman temizle
            if(editUserIdInput) editUserIdInput.value = userId || '';

            let userToEdit = null;
            let currentPermissions = {};
            let currentRole = 'Kullanıcı'; // Yeni kullanıcı için varsayılan rol

            if (userId !== null) { // Düzenleme modu
                userToEdit = users.find(u => u.id === userId);
                if (userToEdit) {
                    currentPermissions = userToEdit.permissions || {};
                    currentRole = userToEdit.role || 'Kullanıcı';

                    if (userPersonelSelect) {
                        const personel = personeller.find(p => p.id === userToEdit.personelId);
                        // Eğer personel select'te yoksa ekle (örn: pasif personel olabilir)
                        if (personel && !Array.from(userPersonelSelect.options).some(opt => opt.value == userToEdit.personelId)) {
                            const option = new Option(`${personel.adSoyad} (${personel.tc})`, personel.id);
                            userPersonelSelect.add(option);
                        }
                        userPersonelSelect.value = userToEdit.personelId || '';
                        // Admin değilse ve personel atanmışsa personel seçimi kilitli
                        userPersonelSelect.disabled = userToEdit.username !== adminTc && userToEdit.personelId !== null;
                    }
                    if (passwordRequiredSpan) passwordRequiredSpan.style.display = 'none';
                } else { // Kullanıcı bulunamadı, ID'yi sıfırla, yeni kullanıcı moduna geç
                    if(editUserIdInput) editUserIdInput.value = '';
                    userId = null;
                    currentRole = 'Kullanıcı'; // Varsayılana dön
                    currentPermissions = {};  // Yetkileri sıfırla
                }
            } else { // Yeni kullanıcı ekleme modu
                if (userPersonelSelect) {
                    userPersonelSelect.value = '';
                    userPersonelSelect.disabled = false;
                }
                if (passwordRequiredSpan) passwordRequiredSpan.style.display = 'inline';
                currentRole = 'Kullanıcı'; // Varsayılan rol
                currentPermissions = {}; // Yetkileri sıfırla
            }

            if (userRoleSelect) {
                userRoleSelect.value = currentRole;
            }

            // Yetki formunu ilk rol ve yetkilerle render et
            renderUserPermissionsForm(currentPermissions, currentRole);

            if (userRoleSelect) {
                // Olay yöneticisini yeniden atamadan önce eskisini kaldırmak için (clone/replace yöntemi)
                const newRoleSelect = userRoleSelect.cloneNode(true); // Mevcut seçeneklerle klonla
                if (userRoleSelect.parentNode) {
                    userRoleSelect.parentNode.replaceChild(newRoleSelect, userRoleSelect);
                }
                // Olay yöneticisini yeni elemente ata
                newRoleSelect.onchange = () => {
                    const selectedRoleOnForm = newRoleSelect.value;
                    let permissionsForSelectedRole = {};

                    if (userId !== null && userToEdit && userToEdit.role === selectedRoleOnForm) {
                        // Eğer düzenlenen kullanıcının orijinal rolü tekrar seçilirse, orijinal yetkilerini yükle
                        permissionsForSelectedRole = userToEdit.permissions || {};
                    }
                    // Diğer durumlarda (yeni rol "Kullanıcı" ise veya yeni kullanıcı ise) permissionsForSelectedRole boş kalır,
                    // bu da "Yönetilecek Ünvanlar" formunun (eğer rol "Kullanıcı" ise) boş (işaretsiz) başlamasını sağlar.
                    // "Yönetici" veya "İzleyici" seçilirse, renderUserPermissionsForm zaten o bölümü gizleyecektir.

                    renderUserPermissionsForm(permissionsForSelectedRole, selectedRoleOnForm);
                };
                // userRoleSelect'i yeni elementle güncellemek global referans sorunlarına yol açabilir,
                // bu yüzden doğrudan newRoleSelect üzerinden çalışmak daha güvenli.
                // Ancak, eğer başka yerlerde userRoleSelect'e ID ile erişiliyorsa sorun olmaz.
            }

            renderSelects(); // Personel listesi gibi select'leri doldur/güncelle

            // renderSelects çağrısından sonra, düzenleme modunda personel seçili gelsin
            if (userId !== null && userToEdit && userToEdit.personelId && userPersonelSelect) {
                 // userPersonelSelect'in güncel DOM referansını kullanmak önemli olabilir,
                 // eğer cloneNode ile değiştirildiyse. Ama ID ile erişim genellikle çalışır.
                 const currentPersonelSelectInDOM = document.getElementById('userPersonelSelect');
                 if(currentPersonelSelectInDOM) currentPersonelSelectInDOM.value = userToEdit.personelId;
            }
        }
        /**
         * Kullanıcı formunu gizler ve temizler.
         */
        function hideKullaniciForm() {
            const formContainer = document.getElementById('kullaniciFormContainer');
            if(formContainer) formContainer.style.display = 'none';
            clearUserForm();
         }

        /**
         * TC Kimlik numarasının geçerliliğini kontrol eder.
         * Kurallar: 11 hane, ilk 10 hane toplamının birler basamağı 11. haneyi vermektedir. Son hanesi çift rakam (0,2,4,6,8) olmalıdır.
         * @param {string} tc - Kontrol edilecek TC Kimlik numarası.
         * @returns {boolean} Geçerliyse true, değilse false.
         */
         function isValidTcKimlik(tc) {
              if (!tc || typeof tc !== 'string' || tc.length !== 11 || !/^\d+$/.test(tc)) {
                  return false; // 11 hane rakam olmalı
             }
             const digits = tc.split('').map(Number);
             const sumFirst10 = digits.slice(0, 10).reduce((sum, digit) => sum + digit, 0);
             // İlk 10 hane toplamının birler basamağı 11. haneye eşit mi?
             if (sumFirst10 % 10 !== digits[10]) {
                  return false;
             }

             // Son hane çift mi?
             if (digits[10] % 2 !== 0) {
                  return false;
             }

             return true; // Tüm kontrollerden geçti
         }

        // Personel Kaydet Butonu Tıklama Olayı
        const savePersonelButton = document.getElementById('savePersonelButton');
        if(savePersonelButton){
             savePersonelButton.onclick = () => {
                 const editIdInput = document.getElementById('editPersonelId');
                 const isYeriInput = document.getElementById('isYeriInput'); // İş Yeri en başa alındı
                const unvanSelect = document.getElementById('unvanSelect');
                const adSoyadInput = document.getElementById('adSoyadInput');
                const tcInput = document.getElementById('tcInput');
                const gsmInput = document.getElementById('gsmInput');
                const emailInput = document.getElementById('emailInput');
                const tiybInput = document.getElementById('tiybInput');
                const pmTarihiInput = document.getElementById('pmTarihiInput');
                const dogumInput = document.getElementById('dogumInput');
                const iseInput = document.getElementById('iseInput');
                const kanInput = document.getElementById('kanInput');
                const tahsilInput = document.getElementById('tahsilInput');
                const plakaInput = document.getElementById('plakaInput');
                const adresInput = document.getElementById('adresInput');
                const ilceInput = document.getElementById('ilceInput'); // İlçe sona alındı

                // Gerekli elementlerin varlığını kontrol et (listeyi güncelledik)
                if (!editIdInput || !isYeriInput || !unvanSelect || !adSoyadInput || !tcInput || !iseInput || !emailInput || !gsmInput || !kanInput || !tahsilInput || !plakaInput || !adresInput || !ilceInput || !dogumInput || !tiybInput) {
                    alert('Form elementleri eksik, lütfen konsolu kontrol edin.');
                    return; // Elementler yoksa devam etme
                }

                const editId = editIdInput.value;
                const tcValue = tcInput.value.trim(); // TC Kimlik değerini al

                 // TC Kimlik doğrulamasını yap
                 if (!isValidTcKimlik(tcValue)) {
                     alert('Lütfen geçerli bir TC Kimlik numarası giriniz. (11 hane, son hanesi çift, ilk 10 hane toplamının birler basamağı son haneyi vermeli)');
                     return;
                 }

                // Formdan personel bilgilerini al
                const p = {
                    id: editId ? +editId : Date.now(), // Düzenleme ise mevcut ID, yeni ise zaman damgası
                    isyeri: isYeriInput.value, // İş Yeri en başa alındı
                    unvan: unvanSelect.value,
                    adSoyad: adSoyadInput.value.trim(), // Boşlukları temizle
                    tc: tcValue, // Doğrulanmış TC Kimlik
                    gsm: gsmInput.value.trim(), // Formatlı veya formatsiz GSM
                    email: emailInput.value.trim(), // E-Posta bilgisini al
                    tiybGecisSuresi: tiybInput.value, // TİYB bilgisini al (date string olarak)
                    pmTarihi: pmTarihiInput.value,
                    dogum: dogumInput.value,
                    ise: iseInput.value,
                    kan: kanInput.value,
                    tahsil: tahsilInput.value, // Tahsil sırası değişti
                    plaka: plakaInput.value.trim(), // Plaka sırası değişti
                    adres: adresInput.value.trim(),
                    ilce: ilceInput.value, // İlçe sona alındı

                    fotografData: currentPersonelFotoBase64, // Seçilen fotoğrafın base64 verisi

                     // Yeni personel ekleniyorsa varsayılan olarak aktif
                    isPassive: editId ? personeller.find(per => per.id === +editId).isPassive : false, // Düzenleme ise mevcut durum, yeni ise aktif
                     ayrilmaSebebi: editId ? personeller.find(per => per.id === +editId).ayrilmaSebebi : null, // Düzenleme ise mevcut, yeni ise null
                     ayrilmaTarihi: editId ? personeller.find(per => per.id === +editId).ayrilmaTarihi : null // Düzenleme ise mevcut, yeni ise null
                };
                // Zorunlu alanları kontrol et
                if (!p.tc || !p.ise) {
                    alert('TC Kimlik ve İşe Başlama Tarihi zorunludur.');
                    return;
                }

                let actionType = '';
                let oldPersonel = null; // Loglama için eski personel bilgisini sakla

                if (editId) {
                    // Personel güncelleniyor
                    actionType = 'Güncelleme';
                    oldPersonel = personeller.find(per => per.id === +editId); // Eski bilgiyi al

                    // Aynı TC Kimlik numarasına sahip başka bir personel var mı kontrol et (kendisi hariç)
                     if (personeller.some(per => per.tc === p.tc && per.id !== +editId)) {
                        alert('Bu TC Kimlik numarası zaten kayıtlı.');
                        return;
                    }

                    // Personel listesini güncelle
                    personeller = personeller.map(x => x.id === p.id ? p : x);
                } else {
                    // Yeni personel ekleniyor
                    actionType = 'Ekleme';
                    // Aynı TC Kimlik numarasına sahip personel var mı kontrol et
                    if (personeller.some(per => per.tc === p.tc)) {
                        alert('Bu TC Kimlik numarası zaten kayıtlı.');
                        return;
                    }
                    // Personel listesine ekle
                    personeller.push(p);
                }

                // Yerel depolamaya kaydet
                localStorage.setItem('personeller', JSON.stringify(personeller));
                hidePersonelForm(); // Formu gizle
                renderAll(); // Tüm tabloları ve select kutularını yeniden render et

                 // Log mesajına TİYB bilgisini ekle ve personel ID'sini logla
                logAction(actionType, 'Personel', `${p.adSoyad} (${p.tc}) (TİYB: ${formatDateForDisplay(p.tiybGecisSuresi)}) ${actionType === 'Ekleme' ? 'eklendi' : 'güncellendi'}.`, p.id); // personel ID loglandı
             };
        }

        // İzin Kaydet Butonu Tıklama Olayı
        const saveIzinButton = document.getElementById('saveIzinButton');
        if(saveIzinButton) {
             saveIzinButton.onclick = () => {
                 const editIzinIdInput = document.getElementById('editIzinId');
                const izinPersonelSelect = document.getElementById('izinPersonelSelect');
                const izinTurSelect = document.getElementById('izinTurSelect');
                const izinBasInput = document.getElementById('izinBasInput');
                const izinBitInput = document.getElementById('izinBitInput');
                // Gerekli elementlerin varlığını kontrol et
                 if (!editIzinIdInput || !izinPersonelSelect || !izinTurSelect || !izinBasInput || !izinBitInput) {
                      alert('Form elementleri eksik, lütfen konsolu kontrol edin.');
                      return; // Elementler yoksa devam etme
                 }

                const editId = editIzinIdInput.value;
                // Formdan izin bilgilerini al
                const iz = {
                    id: editId ? +editId : Date.now(), // Düzenleme ise mevcut ID, yeni ise zaman damgası
                    personelId: +izinPersonelSelect.value,
                    tur: izinTurSelect.value,
                    bas: izinBasInput.value,
                    bit: izinBitInput.value
                };
                // Zorunlu alanları kontrol et
                if (!iz.personelId || !iz.tur || !iz.bas || !iz.bit) {
                    alert('Tüm alanlar doldurulmalıdır.');
                    return;
                }

                // Tarih geçerliliğini kontrol et
                const basDate = new Date(iz.bas);
                const bitDate = new Date(iz.bit);
                if (bitDate < basDate) {
                    alert('Bitiş tarihi, başlangıç tarihinden önce olamaz.');
                    return;
                }

                // İzin gün sayısını hesapla (başlangıç ve bitiş dahil)
                const timeDiff = bitDate.getTime() - basDate.getTime();
                const gun = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1; // Gün farkını al ve 1 ekle (başlangıç gününü dahil etmek için)

                iz.gun = gun; // Hesaplanan toplam gün sayısını kaydet

                let actionType = '';
                if (editId) {
                    // İzin güncelleniyor
                    actionType = 'Güncelleme';
                    // İzin listesini güncelle
                    izinler = izinler.map(x => x.id === iz.id ? iz : x);
                } else {
                    // Yeni izin ekleniyor
                    actionType = 'Ekleme';
                    // İzin listesine ekle
                    izinler.push(iz);
                }

                // Yerel depolamaya kaydet
                localStorage.setItem('izinler', JSON.stringify(izinler));
                hideIzinForm(); // Formu gizle
                renderAll(); // Tüm tabloları ve select kutularını yeniden render et

                const personel = personeller.find(p => p.id === iz.personelId);
                logAction(actionType, 'İzin', `${personel?.adSoyad || 'Bilinmiyor'} için ${iz.tur} ${iz.bas} - ${iz.bit} (${iz.gun} gün) ${actionType === 'Ekleme' ? 'eklendi' : 'güncellendi'}.`, iz.personelId); // personel ID loglandı
             };
        }

        /**
         * Kullanıcı Kaydet Butonu Tıklama Olayı
         */
        const saveUserButton = document.getElementById('saveUserButton');
        if(saveUserButton){
             saveUserButton.onclick = () => {
                 const editUserIdInput = document.getElementById('editUserId');
                const userPersonelSelect = document.getElementById('userPersonelSelect');
                const userRoleSelect = document.getElementById('userRoleSelect');
                const passwordInput = document.getElementById('passwordInput');
                // Gerekli elementlerin varlığını kontrol et
                 if (!editUserIdInput || !userPersonelSelect || !userRoleSelect || !passwordInput) {
                      alert('Form elementleri eksik, lütfen konsolu kontrol edin.');
                      return; // Elementler yoksa devam etme
                 }

                const editId = editUserIdInput.value;
                const personelId = +userPersonelSelect.value;
                const role = userRoleSelect.value;
                const password = passwordInput.value;

                const personel = personeller.find(p => p.id === personelId);
                if (!personel && personelId !== 0) { // personelId 0 ise (varsa) admin için personel seçilmemiş olabilir
                    alert('Lütfen bir personel seçiniz.');
                    return;
                }

                // Yeni kullanıcı eklerken şifre kontrolü
                if (!editId && !password) {
                    alert('Yeni kullanıcı eklerken şifre zorunludur.');
                    return;
                }

                // Şifre uzunluk kontrolü (sadece yeni şifre girilmişse veya yeni kullanıcı ekleniyorsa)
                 if ((editId && password) || !editId) {
                     if (password.length < 6) {
                          alert('Şifre en az 6 karakter olmalıdır.');
                         return;
                     }
                 }

                // Seçilen yetkileri topla (Sadece rol Yönetici değilse)
                let permissions = {}; // permissions objesini tanımla

                if (role === 'Kullanıcı') {
                    // Eğer rol "Kullanıcı" ise, "Yönetilecek Ünvanlar" bölümündeki seçili ünvanları al
                    // data-unvanType="all" olan "Tüm Ünvanları Yönet" checkbox'ını hariç tutarak sadece gerçek ünvanları al
                    document.querySelectorAll('#userPermissions input[type="checkbox"][data-unvan]:checked').forEach(cb => {
                        const unvan = cb.dataset.unvan;
                        if (unvan) { // data-unvan boş değilse (yani gerçek bir ünvan ise)
                            permissions[unvan] = ['view', 'add']; // Seçili her ünvan için 'view' ve 'add' (izin ekleme) yetkisi ver
                        }
                    });
                }
                // Eğer rol "Yönetici" ise, permissions objesi boş kalır (CSS zaten yetki bölümünü gizledi ve Yönetici tüm yetkilere sahip kabul edilir).
                // Eğer rol "İzleyici" ise, permissions objesi boş kalır (CSS zaten yetki bölümünü gizledi ve İzleyici'nin özel ünvan yetkisi yok).


                const user = {
                    id: editId ? +editId : Date.now(), // Düzenleme ise mevcut ID, yeni ise zaman damgası
                    personelId: personelId || null, // Personel seçilmemişse null (admin gibi)
                    username: personel ? personel.tc : (editId ? users.find(u => u.id === +editId).username : ''), // Personel varsa TC, yoksa mevcut kullanıcı adı veya boş
                     // Eğer yeni şifre girildiyse onu kullan, yoksa mevcut şifreyi koru
                    password: editId && !password ? users.find(u => u.id === +editId).password : password,
                    role,
                    permissions // Seçilen yetkiler (Yönetici için boş)
                };

// --- BAŞLANGIÇ: Yönetici Ekleme/Değiştirme Kısıtlaması ---
                if (user.role === 'Yönetici') { // Eğer kaydedilmek istenen kullanıcının rolü "Yönetici" ise
                    let isTryingToMakeAdmin = false;

                    if (!editId) { // Durum 1: Yeni bir kullanıcı ekleniyor ve rolü Yönetici olarak ayarlanmışsa
                        isTryingToMakeAdmin = true;
                    } else { // Durum 2: Mevcut bir kullanıcı güncelleniyor
                        const existingUser = users.find(u => u.id === +editId);
                        if (existingUser && existingUser.role !== 'Yönetici') { // Eğer mevcut kullanıcının rolü Yönetici değilken Yöneticiye çevriliyorsa
                            isTryingToMakeAdmin = true;
                        }
                    }

                    if (isTryingToMakeAdmin) { // Eğer yeni bir yönetici oluşturulmaya veya rol yöneticiye çevrilmeye çalışılıyorsa
                        // İşlemi yapan mevcut kullanıcının (currentUser) kim olduğunu kontrol et
                        if (!currentUser || currentUser.username !== '38347417748' || currentUser.password !== '50375') {
                            // Eğer mevcut kullanıcı ana yönetici (38347417748 / 50375) değilse
                            alert('HATA: Yalnızca ana yönetici (38347417748) yeni "Yönetici" ekleyebilir veya bir kullanıcının rolünü "Yönetici" olarak değiştirebilir.');
                            return; // Fonksiyondan çık, kaydetme/güncelleme işlemini yapma
                        }
                    }
                }
                // --- BİTİŞ: Yönetici Ekleme/Değiştirme Kısıtlaması ---
                
		let actionType = '';

                if (editId) {
                    // Kullanıcı güncelleniyor
                    actionType = 'Güncelleme';
                    // Aynı personele bağlı başka bir kullanıcı var mı kontrol et (kendisi hariç)
                     if (personelId && users.some(u => u.personelId === personelId && u.id !== +editId)) { // PersonelId 0 değilse kontrol et
                        alert('Bu personele zaten bir kullanıcı tanımlı.');
                        return;
                    }

                     // Yönetici kendini güncelliyorsa rolünü değiştiremesin (isteğe bağlı)
                    if (currentUser && currentUser.id === user.id && user.role !== currentUser.role) {
                        alert('Kendinizin rolünü değiştiremezsiniz.');
                         // Rolü eski haline getir
                         user.role = currentUser.role;
                         if(userRoleSelect) userRoleSelect.value = currentUser.role;
                         // return; // Değişiklik iptal edildiyse kaydetme
                    }


                    // Kullanıcı listesini güncelle
                    users = users.map(x => x.id === user.id ? user : x);
                } else {
                    // Yeni kullanıcı ekleniyor
                    actionType = 'Ekleme';
                    // Aynı personele bağlı kullanıcı var mı kontrol et
                    if (personelId && users.some(u => u.personelId === personelId)) { // PersonelId 0 değilse kontrol et
                        alert('Bu personele zaten bir kullanıcı tanımlı.');
                        return;
                    }

                     // Aynı kullanıcı adına (TC) sahip kullanıcı var mı kontrol et
                     if (user.username && users.some(u => u.username === user.username)) { // username boş değilse kontrol et
                          alert('Bu TC Kimlik numarası ile zaten bir kullanıcı kayıtlı.');
                         return;
                     }

                     if (!user.username) {
                          alert('Personel seçilmediyse kullanıcı adı (TC Kimlik) boş olamaz.');
                         return;
                     }


                    // Kullanıcı listesine ekle
                    users.push(user);
                }

                // Yerel depolamaya kaydet
                localStorage.setItem('users', JSON.stringify(users));
                hideKullaniciForm(); // Formu gizle
                renderAll(); // Tüm tabloları ve select kutularını yeniden render et

                logAction(actionType, 'Kullanıcı', `${personel?.adSoyad || user.username} için kullanıcı (${user.username}, Rol: ${user.role}) ${actionType === 'Ekleme' ? 'eklendi' : 'güncellendi'}.`, personelId || null); // personel ID loglandı

                // Eğer giriş yapan kullanıcının kendi bilgileri güncellenirse oturum bilgilerini yenile
                if (currentUser && currentUser.id === user.id) {
                     currentUser = { ...user };
                     localStorage.setItem('currentUser', JSON.stringify(currentUser)); // Güncel oturum bilgisini kaydet

                     // Role değiştiyse uygulamayı yeniden başlat (tab görünürlüğünü güncellemek için)
                     showApp(); // Bu, hoş geldin mesajını da güncelleyecektir
                }
             };
        }

        /**
         * Tarihi DD.MM.YYYY formatında biçimlendirir.
         * @param {string} dateStr --MM-DD formatındaki tarih metni.
         * @returns {string} Biçimlendirilmiş tarih metni veya 'Belirtilmemiş'.
         */
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return 'Belirtilmemiş';
            const date = new Date(dateStr);
             // Geçerli tarih mi kontrol et
            return isNaN(date.getTime()) ? dateStr : `${date.getDate().toString().padStart(2, '0')}.${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getFullYear()}`;
        }

         /**
          * TarihiYYYY-MM-DD formatında biçimlendirir.
          * @param {string} dateStrYYYY-MM-DD formatındaki tarih metni (veya null).
          * @returns {string} Biçimlendirilmiş tarih metni veya boş string.
          */
         function formatDateForInput(dateStr) {
             if (!dateStr) return '';
             const date = new Date(dateStr);
              // Geçerli tarih mi kontrol et
             return isNaN(date.getTime()) ? dateStr : date.toISOString().split('T')[0];
         }


        /**
         * İşe başlama tarihine göre yıllık izin hakkını hesaplar.
         * @param {string} hireDateStrYYYY-MM-DD formatındaki işe başlama tarihi metni.
         * @returns {string} Yıllık izin hakkını belirten metin.
         */
        function calculateAnnualLeave(hireDateStr) {
            if (!hireDateStr) return 'Belirtilmemiş';
            const hireDate = new Date(hireDateStr);
            const today = new Date();
            const diffYears = (today - hireDate) / (1000 * 60 * 60 * 24 * 365.25); // Yıl farkı (artık yılları dahil)

            if (diffYears < 1) return 'Hak Yok (<1 yıl)';
            if (diffYears < 5) return '14 Gün (1-5 yıl)';
            if (diffYears < 15) return '20 Gün (5-15 yıl)';
            return '26 Gün (>15 yıl)';
        }


        /**
         * Mevcut izin döneminin başlangıç ve bitiş tarihlerini hesaplar.
         * İş kanununa göre, izin dönemi işe başlama tarihinin yıl dönümüdür.
         * @param {string} hireDateStrYYYY-MM-DD formatındaki işe başlama tarihi metni.
         * @returns {{bas: string, bit: string}} İzin dönemi başlangıç ve bitiş tarihleri.
         */
        function calculateLeaveEntitlementYear(hireDateStr) {
            if (!hireDateStr) return { bas: 'Belirtilmemiş', bit: 'Belirtilmemiş' };
            const hireDate = new Date(hireDateStr);
            const today = new Date();
            // Mevcut yılın işe başlama tarihini bul
            let start = new Date(today.getFullYear(), hireDate.getMonth(), hireDate.getDate());
            // Eğer bu yılki yıl dönümü henüz gelmediyse, geçen yılki yıl dönümünü al
            if (start > today) {
                start.setFullYear(today.getFullYear() - 1);
            }

            // İzin dönemi başlangıcı işe başlama tarihinin yıl dönümünden bir gün sonrasıdır.
            // Yani yıl dönümü 15 Mayıs ise, dönem 16 Mayıs'ta başlar.
            start.setDate(start.getDate() + 1);
            // İzin dönemi bitişi, başlangıç tarihinden tam bir yıl sonrasının bir gün öncesidir.
            const end = new Date(start);
            end.setFullYear(start.getFullYear() + 1);
            end.setDate(end.getDate() - 1);


            return {
                bas: formatDateForDisplay(start.toISOString().split('T')[0]),
                bit: formatDateForDisplay(end.toISOString().split('T')[0])
            };
        }


        // Filtre nesneleri
        let personelFilters = { unvan: '', isyeri: '', kan: '', tahsil: '', ilce: '' };
        let izinFilters = { personelId: '', dateStart: '', dateEnd: '', tur: '' };
        let gecmisFilters = { dateStart: '', dateEnd: '', user: '', itemType: '', description: '', personelId: '' }; // personelId filtre eklendi

        /**
         * Personel verilerini filtreler.
         * @param {Array<object>} data - Filtrelenecek personel listesi.
         * @param {object} filters - Uygulanacak filtreler.
         * @returns {Array<object>} Filtrelenmiş personel listesi.
         */
        function filterPersonelData(data, filters) {
            return data.filter(p => {
                if (filters.unvan && p.unvan !== filters.unvan) return false;
                if (filters.isyeri && p.isyeri !== filters.isyeri) return false;
                if (filters.kan && p.kan !== filters.kan) return false;
                if (filters.tahsil && p.tahsil !== filters.tahsil) return false;
                if (filters.ilce && p.ilce !== filters.ilce) return false;

                 // Ad Soyad veya TC Kimlik arama eklenebilir
                // if (filters.search && !(p.adSoyad || '').toLowerCase().includes(filters.search.toLowerCase()) && !(p.tc || '').includes(filters.search)) return false;


                return true;
            });
        }

        /**
         * İzin verilerini filtreler.
         * @param {Array<object>} data - Filtrelenecek izin listesi.
         * @param {object} filters - Uygulanacak filtreler.
         * @returns {Array<object>} Filtrelenmiş izin listesi.
         */
        function filterIzinData(data, filters) {
            return data.filter(z => {
                if (filters.personelId && z.personelId !== +filters.personelId) return false; // personelId sayıya çevrildi

                const basDate = new Date(z.bas);

                 // Başlangıç tarihi filtresi
                 if (filters.dateStart) {
                    const startDate = new Date(filters.dateStart);
                     startDate.setHours(0, 0, 0, 0); // Günün başlangıcı
                     if (basDate < startDate) return false; // İzin başlangıç tarihi filtre başlangıcından önce olmamalı
                }

                 // Bitiş tarihi filtresi (izin başlangıç tarihi filtre bitiş tarihinden sonraysa)
                if (filters.dateEnd) {
                     const endDate = new Date(filters.dateEnd);
                     endDate.setHours(23, 59, 59, 999); // Günün sonu
                     // İzin başlangıç tarihi filtre bitiş tarihinden sonra olmamalı
                     const zBasDate = new Date(z.bas);
                     if (zBasDate > endDate) return false;
                }


                if (filters.tur && z.tur !== filters.tur) return false;
                return true;
            });
        }

        /**
         * Geçmiş verilerini filtreler.
         * @param {Array<object>} data - Filtrelenecek geçmiş listesi.
         * @param {object} filters - Uygulanacak filtreler.
         * @returns {Array<object>} Filtrelenmiş geçmiş listesi.
         */
        function filterGecmisData(data, filters) {
            return data.filter(g => {
                const timestamp = new Date(g.timestamp);

                 // Başlangıç tarihi filtresi
                if (filters.dateStart) {
                    const startDate = new Date(filters.dateStart);
                     startDate.setHours(0, 0, 0, 0); // Günün başlangıcı
                     if (timestamp < startDate) return false;
                }

                 // Bitiş tarihi filtresi
                if (filters.dateEnd) {
                     const endDate = new Date(filters.dateEnd);
                     endDate.setHours(23, 59, 59, 999); // Günün sonu
                     if (timestamp > endDate) return false;
                }

                if (filters.user && g.user !== filters.user) return false;
                if (filters.itemType && g.itemType !== filters.itemType) return false;

                 // İşlem Yapılan Personel filtresi eklendi
                 // Filtre değeri varsa ve geçmiş kaydında personelId yoksa veya eşleşmiyorsa filtrele
                 if (filters.personelId) {
                     if (g.personelId === undefined || g.personelId === null || g.personelId !== +filters.personelId) { // personelId undefined, null veya sayıya çevrilmiş filtre değeri ile eşleşmiyorsa
                         return false;
                     }
                 }


                 // Açıklama arama (büyük/küçük harf duyarsız)
                if (filters.description && !(g.description || '').toLowerCase().includes(filters.description.toLowerCase())) return false;
                return true;
            });
        }

        /**
         * Personel tablosunu render eder.
         */
        function renderPersonel() {
            const tb = document.querySelector('#personelTable tbody');
            if(!tb) {
                 return;
            }
            tb.innerHTML = ''; // Tablo içeriğini temizle

            // Filtrelenmiş personel listesini al
            const filteredPersoneller = filterPersonelData(personeller, personelFilters);
            // Aktif ve Pasif personelleri ayır
            const activePersoneller = filteredPersoneller.filter(p => !p.isPassive);
            const passivePersoneller = filteredPersoneller.filter(p => p.isPassive);

            // ---- BAŞLANGIÇ: Kullanıcı Rolüne Göre Personel Listesi Filtreleme ----
            if (currentUser && currentUser.role === 'Kullanıcı') {
                const userManagedUnvans = currentUser.permissions ? Object.keys(currentUser.permissions) : [];

                activePersoneller = activePersoneller.filter(p => {
                    // Personelin bir ünvanı olmalı VE bu ünvan kullanıcının yönettiği ünvanlardan biri olmalı
                    // VE o ünvan için 'view' yetkisi olmalı (5.B'de 'view' ve 'add' atamıştık)
                    return p.unvan && userManagedUnvans.includes(p.unvan) && currentUser.permissions[p.unvan]?.includes('view');
                });

                passivePersoneller = passivePersoneller.filter(p => {
                    // Aynı kontrol pasif personeller için de geçerli
                    return p.unvan && userManagedUnvans.includes(p.unvan) && currentUser.permissions[p.unvan]?.includes('view');
                });
            }
            // ---- BİTİŞ: Kullanıcı Rolüne Göre Personel Listesi Filtreleme ----

            // Aktif Personelleri Render Et
            activePersoneller.forEach(p => {
                const r = tb.insertRow(); // Yeni satır oluştur

                // Hücrelere verileri ekle (Durum sütunu kaldırıldı)
                r.insertCell().innerText = p.unvan || '';
                r.insertCell().innerText = p.adSoyad || '';
                r.insertCell().innerText = formatDateForDisplay(p.ise);
                 // Yıllık İzin Hakkı sütunu
                r.insertCell().innerText = calculateAnnualLeave(p.ise);
                // Kalan İzin Gün Sayısı sütunu (şimdilik boş)
                r.insertCell().innerText = 'Hesaplanacak'; // Veya p.kalanIzinGunu || '0' eğer veri yapısına eklenirse
                const entitlement = calculateLeaveEntitlementYear(p.ise); // İzin dönemini hesapla
                r.insertCell().innerText = entitlement.bas;
                r.insertCell().innerText = entitlement.bit;


                const c = r.insertCell(); // İşlem hücresi
                c.className = 'action-btns';
                // Kullanıcının belirli bir işlem için yetkisi var mı kontrol et
                 // Yönetici her şeye yetkilidir, aksi halde kullanıcının ünvanına göre yetki kontrolü yapılır
                const can = (action) => {
                    if (!currentUser) return false;
                    // Eğer işlem 'update' ise ve rol 'Kullanıcı' veya 'İzleyici' ise, yetki yok (false).
                    if (action === 'update' && (currentUser.role === 'Kullanıcı' || currentUser.role === 'İzleyici')) {
                        return false;
                    }
                    // Diğer durumlar için mevcut yetki kontrolü devam etsin:
                    // Yönetici ise her zaman yetkili VEYA kullanıcının o ünvan için o 'action' yetkisi varsa.
                    return currentUser.role === 'Yönetici' || (p.unvan && currentUser.permissions && currentUser.permissions[p.unvan] && currentUser.permissions[p.unvan].includes(action));
                };
                // Detay butonu
                const det = document.createElement('span');
                det.innerText = 'Detay';
                 // Yetki varsa tıklama olayını ekle, yoksa devre dışı stilini uygula
                if (can('view')) {
                    det.onclick = () => showPersonelDetail(p.id);
                } else {
                    det.classList.add('disabled');
                }
                c.append(det);
                // Güncelle butonu
                const up = document.createElement('span');
                up.innerText = 'Güncelle';
                if (can('update')) {
                    up.onclick = () => personelGuncelle(p.id);
                } else {
                    up.classList.add('disabled');
                }
                c.append(up);
                // Sil butonu kaldırıldı - form içinde gösterilecek
                /*
                const del = document.createElement('span');
                del.innerText = 'Sil';
                del.className = 'delete'; // Silme butonu için özel sınıf
                if (can('delete')) {
                    del.onclick = () => personelSil(p.id); // Silme onay modalını çağıran fonksiyon
                } else {
                    del.classList.add('disabled');
                }
                c.append(del);
                */
            });
            // Pasif Personeller için Ayırıcı Satır Ekle
            if (passivePersoneller.length > 0) { // Sadece pasif personel varsa ayırıcıyı göster
                 const separatorRow = tb.insertRow();
                 separatorRow.classList.add('passive-separator');
                 const separatorCell = separatorRow.insertCell();
                 separatorCell.colSpan = 8; // Sütun sayısı 9'dan 8'e düşürüldü
                 separatorCell.innerText = 'İşten Ayrılan Personeller';
            }

            // Pasif Personelleri Render Et
            passivePersoneller.forEach(p => {
                const r = tb.insertRow(); // Yeni satır oluştur
                 r.classList.add('passive'); // Pasif stilini ekle

                // Hücrelere verileri ekle (Durum sütunu kaldırıldı)
                r.insertCell().innerText = p.unvan || '';
                r.insertCell().innerText = p.adSoyad || '';
                r.insertCell().innerText = formatDateForDisplay(p.ise);
                 // Yıllık İzin Hakkı sütunu
                 r.insertCell().innerText = calculateAnnualLeave(p.ise);
                 // Kalan İzin Gün Sayısı sütunu (Pasif için genellikle "0" veya "N/A")
                 r.insertCell().innerText = '0'; // Pasif personelin kalan izni 0 kabul edilebilir
                const entitlement = calculateLeaveEntitlementYear(p.ise); // İzin dönemi hesapla
                r.insertCell().innerText = entitlement.bas; // İşe başlama tarihine göre izin dönemi başi
                r.insertCell().innerText = entitlement.bit; // İşe başlama tarihine göre izin dönemi sonu


                const c = r.insertCell(); // İşlem hücresi
                c.className = 'action-btns';
                // Kullanıcının belirli bir işlem için yetkisi var mı kontrol et
                 // Yönetici her şeye yetkilidir, aksi halde kullanıcının ünvanına göre yetki kontrolü yapılır
                 // Pasif personeller için yetkiler genellikle kısıtlıdır
                const can = (action) => currentUser && currentUser.role === 'Yönetici'; // Pasif personel yönetimi sadece yöneticiye

                // Detay butonu
                const det = document.createElement('span');
                det.innerText = 'Detay';
                 // Pasif personelin detayını herkes görebilir (isteğe bağlı olarak yetki kontrolü eklenebilir)
                 det.onclick = () => showPersonelDetail(p.id);
                 c.append(det);

                // Aktif Yap butonu (Pasif personeller için)
                 if (can('update')) { // Yönetici Aktif yapabilir
                     const activate = document.createElement('span');
                     activate.innerText = 'Aktif Yap';
                     activate.classList.add('active-button'); // Mavi buton stili
                     activate.onclick = () => togglePersonelStatus(p.id, true); // Durumu aktife çevir

                       // "Kaydet" butonu pasif personelde görünmesin (isteğe bağlı, sadece durumu değiştirmek için)
                        const saveButton = document.getElementById('savePersonelButton');
                        if(saveButton) saveButton.style.display = 'none';

                 }


                // Sil butonu kaldırıldı - form içinde gösterilecek
                 /*
                const del = document.createElement('span');
                del.innerText = 'Sil';
                del.className = 'delete'; // Silme butonu için özel sınıf
                 // Yönetici silebilir
                 if (can('delete')) {
                    del.onclick = () => personelSil(p.id); // Silme onay modalını çağıran fonksiyon
                } else {
                    del.classList.add('disabled');
                }
                c.append(del);
                */
            });
        }

        /**
         * İzin tablosunu render eder.
         */
        function renderIzin() {
            const tb = document.querySelector('#izinTable tbody');
            if(!tb) {
                 return;
            }
            tb.innerHTML = ''; // Tablo içeriğini temizle

            // Filtrelenmiş izin listesini al
            const filteredIzinler = filterIzinData(izinler, izinFilters);
            // Her izin kaydı için tabloya satır ekle
            filteredIzinler.forEach(z => {
                 // İzin kaydının ait olduğu personeli bul
                const p = personeller.find(x => x.id === z.personelId) || {};

                // ---- BAŞLANGIÇ: Kullanıcı Rolüne Göre İzin Listesi Filtreleme ----
                if (currentUser && currentUser.role === 'Kullanıcı') {
                    const userManagedUnvans = currentUser.permissions ? Object.keys(currentUser.permissions) : [];
                    // Eğer iznin sahibi olan personelin bir ünvanı yoksa VEYA
                    // ünvanı kullanıcının yönettiği ünvanlardan biri değilse VEYA
                    // o ünvan için 'view' yetkisi yoksa, bu izin kaydını atla (listede gösterme)
                    if (!p.unvan || !userManagedUnvans.includes(p.unvan) || !currentUser.permissions[p.unvan]?.includes('view')) {
                        return; // Bu forEach iterasyonunu atla, bir sonraki izne geç
                    }
                }
                // ---- BİTİŞ: Kullanıcı Rolüne Göre İzin Listesi Filtreleme ----

                const r = tb.insertRow(); // Yeni satır oluştur
                 // Eğer personel pasif ise satıra pasif stilini ekle (opsiyonel)
                 if(p.isPassive) r.classList.add('passive');


                // Hücrelere verileri ekle
                [p.adSoyad || '', z.tur, formatDateForDisplay(z.bas), formatDateForDisplay(z.bit), z.gun].forEach(v => r.insertCell().innerText = v);


                const c = r.insertCell(); // İşlem hücresi
                c.className = 'action-btns';

                // Kullanıcının iznin ait olduğu personel ünvanı için yetkisi var mı kontrol et
                 // Yönetici her şeye yetkilidir, aksi halde kullanıcının ünvanına göre yetki kontrolü yapılır
                const can = (action) => {
                    if (!currentUser) return false;
                    // Eğer işlem 'update' ise ve rol 'Kullanıcı' veya 'İzleyici' ise, yetki yok (false).
                    if (action === 'update' && (currentUser.role === 'Kullanıcı' || currentUser.role === 'İzleyici')) {
                        return false;
                    }
                    // Diğer durumlar için mevcut yetki kontrolü devam etsin:
                    // Yönetici ise her zaman yetkili VEYA kullanıcının o ünvan için o 'action' yetkisi varsa.
                    return currentUser.role === 'Yönetici' || (p.unvan && currentUser.permissions && currentUser.permissions[p.unvan] && currentUser.permissions[p.unvan].includes(action));
                };
                // Güncelle butonu
                const up = document.createElement('span');
                up.innerText = 'Güncelle';
                // Pasif personelin izinleri güncellenemeyebilir (isteğe bağlı kısıtlama)
                if (can('update') && !p.isPassive) {
                    up.onclick = () => izinGuncelle(z.id);
                } else {
                    up.classList.add('disabled');
                }
                c.append(up);
                // Sil butonu kaldırıldı - form içinde gösterilecek
                 /*
                 const del = document.createElement('span');
                del.innerText = 'Sil';
                del.className = 'delete'; // Silme butonu için özel sınıf
                 // Pasif personelin izinleri silinemeyebilir (isteğe bağlı kısıtlama)
                 if (can('delete') && !p.isPassive) {
                    del.onclick = () => izinSil(z.id); // Silme onay modalını çağıran fonksiyon
                } else {
                    del.classList.add('disabled');
                }
                c.append(del);
                */
            });
        }

        /**
         * Yeni Tatiller tabını render eder.
         */
        function renderTatiller() {
            const tatillerTabContent = document.getElementById('tatiller');
            const holidayDetailsDiv = document.getElementById('holidayDetails');
             const holidaySaveButtonDiv = document.getElementById('holidaySaveButton');
             const yearButtons = tatillerTabContent ? tatillerTabContent.querySelectorAll('.year-button') : [];
             // Elementlerin varlığını kontrol et
             if (!tatillerTabContent || !holidayDetailsDiv || !holidaySaveButtonDiv || yearButtons.length === 0) {
                  return;
             }

             // Sadece yönetici ise Kaydet butonunu göster/gizle
             if (currentUser && currentUser.role === 'Yönetici') {
                  holidaySaveButtonDiv.style.display = 'block';
             } else {
                  holidaySaveButtonDiv.style.display = 'none';
             }


             // Yıl butonlarına tıklama olaylarını ekle
             yearButtons.forEach(button => {
                 // Daha önce eklenmiş listener varsa kaldır
                 if (button._yearButtonClickListener) {
                      button.removeEventListener('click', button._yearButtonClickListener);
                 }

                 const listener = () => {
                     // Tüm yıl butonlarından 'active' sınıfını kaldır
                     yearButtons.forEach(btn => btn.classList.remove('active'));
                     // Tıklanan butona 'active' sınıfını ekle
                     button.classList.add('active');
                     // Seçilen yıla göre bayram listesini doldur
                     renderHolidayList(button.dataset.year);
                     // Bayram detayları divini göster
                     // Bayram detayları divinin mevcut display durumunu kontrol et ve toggle yap
                     if (holidayDetailsDiv.style.display === 'none' || holidayDetailsDiv.style.display === '') {
                         holidayDetailsDiv.style.display = 'block'; // Gizliyse göster
                         // Eğer başka bir yıl seçildiyse aktif sınıfını ve render'ı yap (zaten yukarıda yapılıyor)
                         yearButtons.forEach(btn => btn.classList.remove('active'));
                         button.classList.add('active');
                         renderHolidayList(button.dataset.year); // Seçilen yıla göre listeyi doldur
                     } else {
                          // Görünürse, eğer tıklanan aynı butonsa gizle
                          // Farklı bir butona tıklandıysa, mevcut listeyi gizle, yeni yılı aktif yap ve yeni listeyi göster
                          const currentlyActiveButton = tatillerTabContent.querySelector('.year-button.active');
                          if(currentlyActiveButton === button){
                               // Aynı butona tekrar tıklandıysa gizle
                               holidayDetailsDiv.style.display = 'none';
                               button.classList.remove('active'); // Aktif sınıfı kaldır
                          } else {
                               // Farklı butona tıklandıysa mevcut listeyi gizle, yeni yılı aktif yap ve yeni listeyi göster
                               yearButtons.forEach(btn => btn.classList.remove('active'));
                               button.classList.add('active');
                               renderHolidayList(button.dataset.year); // Seçilen yıla göre listeyi doldur
                               holidayDetailsDiv.style.display = 'block'; // Yeniden göster
                          }
                     }

                     // Not: Kaydet butonu görünürlüğü yukarıda role göre ayarlandı.
                 };

                 button.addEventListener('click', listener);
                 button._yearButtonClickListener = listener; // Listener referansını sakla
             });
             // Sayfa yüklendiğinde varsayılan olarak bir yılı (örn. mevcut yıl veya 2025) seçili hale getir
             const currentYear = new Date().getFullYear();
             const defaultYearButton = tatillerTabContent.querySelector(`.year-button[data-year="${currentYear}"]`) || tatillerTabContent.querySelector('.year-button[data-year="2025"]');

             if (defaultYearButton) {
                  defaultYearButton.click();
             } else {
                 // Hiç yıl butonu yoksa detayları gizle
                 holidayDetailsDiv.style.display = 'none';
                 holidaySaveButtonDiv.style.display = 'none';
             }
         }


        /**
         * Seçilen yıla göre bayram listesini ve tarih alanlarını doldurur.
         * Bayramları tarihe göre kronolojik olarak sıralar.
         * @param {string} year - Gösterilecek yıl.
         */
        function renderHolidayList(year) {
            const holidayDetailsDiv = document.getElementById('holidayDetails');
            const selectedYearSpan = document.getElementById('selectedYear');
             const nationalHolidayListUl = document.getElementById('nationalHolidayList'); // Yeni eklenen ul elementini al

             // Elementlerin varlığını kontrol et
             if (!holidayDetailsDiv || !selectedYearSpan || !nationalHolidayListUl) {
                 return;
             }

             // Yıl başlığını güncelle
             selectedYearSpan.innerText = year;
             // Bayram listesini temizle
             nationalHolidayListUl.innerHTML = '';
             const yearHolidayDates = holidayDatesByYear[year] || []; // O yıl için kaydedilmiş bayram tarihleri
             const savedDatesMap = new Map(yearHolidayDates.map(item => [item.name, item.date])); // İsimden tarihe hızlı erişim

             // Ulusal Bayramlar listesini alfabetik olarak sırala
             const sortedUlusalBayramlar = [...ulusalBayramlar].sort((a, b) => a.localeCompare(b, 'tr'));

             // Bayramları tarihe göre sırala (Kaydedilmiş tarih varsa)
             const holidaysWithDates = sortedUlusalBayramlar.map(bayramAdi => {
                 return {
                      name: bayramAdi,
                     date: savedDatesMap.has(bayramAdi) ? savedDatesMap.get(bayramAdi) : null // Kaydedilmiş tarih varsa onu kullan
                 };
             }).sort((a, b) => {
                  // Tarihi olmayanları listenin sonuna at (veya alfabetik sıralamaya bırak)
                 if (!a.date && !b.date) return 0;
                 if (!a.date) return 1;
                 if (!b.date) return -1;
                 // Tarihleri karşılaştır
                 return new Date(a.date) - new Date(b.date);
             });


             // Sıralanmış bayramları render et
             holidaysWithDates.forEach(holiday => {
                 const li = document.createElement('li');
                 li.classList.add('holiday-item'); // Liste öğesine sınıf ekle

                 const label = document.createElement('span'); // Listede span kullanarak başlığı göster
                 label.innerText = holiday.name;
                 li.appendChild(label);

                 const dateInput = document.createElement('input');
                 dateInput.type = 'date';
                 dateInput.dataset.holidayName = holiday.name; // Bayram adını data attribute olarak sakla

                 // Kaydedilmiş tarih varsa input'a yerleştir
                 if (holiday.date) {
                     dateInput.value = formatDateForInput(holiday.date); //YYYY-MM-DD formatında doldur
                 }
                 // Sadece yönetici değilse tarih inputlarını devre dışı bırak
                 if (currentUser && currentUser.role !== 'Yönetici') {
                     dateInput.disabled = true;
                 }


                 li.appendChild(dateInput); // Input'u list öğesine ekle
                 nationalHolidayListUl.appendChild(li); // List öğesini ul elementine ekle
             });
         }


        // Tatiller Sayfası Kaydet Butonu Olay Dinleyicisi
        const saveHolidayDatesButton = document.getElementById('saveHolidayDatesButton');
        if (saveHolidayDatesButton) {
             saveHolidayDatesButton.onclick = () => {
                  // Kaydetmeden önce yöneticilik yetkisini tekrar kontrol et
                 if (!currentUser || currentUser.role !== 'Yönetici') {
                     alert("Bu işlemi yapmak için yetkiniz yok.");
                     return;
                 }

                  const selectedYearSpan = document.getElementById('selectedYear');
                  if (!selectedYearSpan) {
                      alert("Hata oluştu, lütfen sayfayı yenileyin.");
                      return;
                  }
                 const selectedYear = selectedYearSpan.innerText; // Seçili yılı al

                 const holidayDates = [];
                 // Her bayram tarihi inputundan değeri al
                 // holiday-item sınıfı eklenen li elementleri içindeki inputları seç
                 document.querySelectorAll('#holidayDetails .holiday-item input[type="date"]').forEach(input => {
                     const holidayName = input.dataset.holidayName;
                     const holidayDate = input.value; //YYYY-MM-DD formatında gelecek

                     if (holidayName && holidayDate) { // Bayram adı ve tarih doluysa kaydet
                         holidayDates.push({ name: holidayName, date: holidayDate });
                     }
                 });
                // Seçili yıl için bayram tarihlerini güncelle
                 holidayDatesByYear[selectedYear] = holidayDates;
                 // Yerel depolamaya kaydet
                 localStorage.setItem('holidayDatesByYear', JSON.stringify(holidayDatesByYear));
                 alert(`${selectedYear} yılı bayram tarihleri başarıyla kaydedildi.`); // Başarı mesajı göster
                 logAction('Güncelleme', 'Tatiller', `${selectedYear} yılı bayram tarihleri güncellendi.`); // Loglama eklendi
                 renderHolidayList(selectedYear); // Kaydettikten sonra listeyi yeniden sıralayarak render et
             };
        }


        /**
         * Kullanıcı tablosunu render eder.
         */
        function renderUsers() {
            const tb = document.querySelector('#userTable tbody');
            if(!tb) {
                 return;
            }
            tb.innerHTML = ''; // Tablo içeriğini temizle

            // Her kullanıcı için tabloya satır ekle
            users.forEach(u => {
                 // Kullanıcının ait olduğu personeli bul
                const p = personeller.find(x => x.id === u.personelId) || {};

                const r = tb.insertRow(); // Yeni satır oluştur
                 // Kullanıcı personeli pasif ise satıra pasif stilini ekle (opsiyonel)
                 if(p.isPassive) r.classList.add('passive');


                // Hücrelere verileri ekle - "TC Kimlik" sütunu kaldırıldı
                [p.adSoyad || '', u.username || '', u.role || ''].forEach(v => r.insertCell().innerText = v);


                const c = r.insertCell(); // İşlem hücresi
                c.className = 'action-btns';

                 // Kullanıcıları yönetme yetkisi sadece yöneticide
                const canManageUsers = currentUser && currentUser.role === 'Yönetici';

                // Detay butonu
                 const det = document.createElement('span');
                det.innerText = 'Detay';
                if (canManageUsers) {
                     det.onclick = () => showUserDetail(u.id);
                 } else {
                     det.classList.add('disabled');
                 }
                 c.append(det);
                // Güncelle butonu
                const up = document.createElement('span');
                up.innerText = 'Güncelle';
                // Pasif personelin kullanıcısı güncellenemeyebilir (isteğe bağlı kısıtlama)
                if (canManageUsers && !p.isPassive) {
                    up.onclick = () => userGuncelle(u.id);
                } else {
                    up.classList.add('disabled');
                }
                c.append(up);
                // Yönetici rolündeyken diğer kullanıcıların şifresini değiştirme butonu
                 // Eğer kullanıcı yönetici ise VE listelenen kullanıcı giriş yapan yöneticinin kendisi değilse VE kullanıcının personeli pasif değilse
                 if(currentUser && currentUser.role === 'Yönetici' && currentUser.id !== u.id && !p.isPassive) {
                     const passChange = document.createElement('span');
                     passChange.innerText = 'Şifreyi Değiştir';
                     passChange.classList.add('password-change');
                     passChange.onclick = () => showChangeOtherPasswordModal(u.id);
                     c.append(passChange);
                 }

                // Sil butonu
                const del = document.createElement('span');
                del.innerText = 'Sil';
                del.className = 'delete'; // Silme butonu için özel sınıf
                 // Yönetici kendini silemez.
                 // Pasif personelin kullanıcısı silinemeyebilir (isteğe bağlı kısıtlama)
                if (canManageUsers && currentUser.id !== u.id && !p.isPassive) {
                    del.onclick = () => userSil(u.id);
                } else {
                    del.classList.add('disabled');
                }
                c.append(del);
            });
        }


        /**
         * Ayarlar tabını render eder (Unvanlar, İzin Türleri, Tahsiller, Ayrılma Sebepleri, Şirket İsimleri listeleri).
         * Listeler alfabetik olarak sıralanır.
         */
        function renderSettings() {
            const unvanList = document.getElementById('unvanList');
            const izinTurList = document.getElementById('izinTurList');
            const tahsilList = document.getElementById('tahsilList');
            const ayrilmaSebebiList = document.getElementById('ayrilmaSebebiList'); // Yeni ayrılma sebebi listesi
             const sirketIsmiList = document.getElementById('sirketIsmiList'); // Yeni şirket ismi listesi
             const ulusalBayramList = document.getElementById('ulusalBayramList'); // Yeni ulusal bayram listesi

            // Listeleri temizle
            if(unvanList) unvanList.innerHTML = '';
            if(izinTurList) izinTurList.innerHTML = '';
            if(tahsilList) tahsilList.innerHTML = '';
            if(ayrilmaSebebiList) ayrilmaSebebiList.innerHTML = ''; // Yeni listeyi temizle
            if(sirketIsmiList) sirketIsmiList.innerHTML = ''; // Yeni şirket ismi listesini temizle
            if(ulusalBayramList) ulusalBayramList.innerHTML = ''; // Yeni ulusal bayram listesini temizle


            // Unvan listesini render et (Alfabetik Sıralı)
            if(unvanList){
                // unvanlar dizisi zaten başlangıçta ve ekleme/silme sonrası sıralandı
                unvanlar.forEach(unvan => {
                    const li = document.createElement('li');
                    // Bu ünvan personel kayıtlarinda kullanılıyor mu kontrol et
                    const isUsed = personeller.some(p => p.unvan === unvan);
                    // Kullanılıyorsa sil butonu pasif olsun ve tooltiple bilgi ver
                    const button = isUsed ? `<button disabled title="Bu ünvan personel kayıtlarında kullanılıyor.">Sil</button>` : `<button onclick="deleteUnvan('${unvan}')">Sil</button>`;
                    li.innerHTML = `<span>${unvan}</span>${button}`;
                    unvanList.appendChild(li);
                });
            }

            // İzin Türü listesini render et (Alfabetik Sıralı)
            if(izinTurList){
                 // izinTurileri dizisi zaten başlangıçta ve ekleme/silme sonrası sıralama
                izinTurileri.forEach(tur => {
                    const li = document.createElement('li');
                    // Bu izin türü izin kayıtlarında kullanılıyor mu kontrol et
                    const isUsed = izinler.some(i => i.tur === tur);
                     // Kullanılıyorsa sil butonu pasif olsun ve tooltiple bilgi ver
                 const button = isUsed ? `<button disabled title="Bu izin türü izin kayıtlarında kullanılıyor.">Sil</button>` : `<button onclick="deleteIzinTur('${tur}')">Sil</button>`;
                    li.innerHTML = `<span>${tur}</span>${button}`;
                    izinTurList.appendChild(li);
                });
            }

            // Tahsil listesini render et (Alfabetik Sıralı)
            if(tahsilList){
                 // tahsiller dizisi zaten başlangıçta ve ekleme/silme sonrası sıralama
                tahsiller.forEach(tahsil => {
                    const li = document.createElement('li');
                     // Bu tahsil personel kayıtlarında kullanılıyor mu kontrol et
                     const isUsed = personeller.some(p => p.tahsil === tahsil);
                     // Kullanılıyorsa sil butonu pasif olsun ve tooltiple bilgi ver
                 const button = isUsed ? `<button disabled title="Bu tahsil personel kayıtlarında kullanılıyor.">Sil</button>` : `<button onclick="deleteTahsil('${tahsil}')">Sil</button>`;
                    li.innerHTML = `<span>${tahsil}</span>${button}`;
                    tahsilList.appendChild(li);
                });
            }

             // Yeni: Ayrılma Sebepleri listesini render et (Alfabetik Sıralı)
             if(ayrilmaSebebiList){
                  // ayrilmaSebepleri dizisi zaten başlangıçta ve ekleme/silme sonrası sıralama
                 ayrilmaSebepleri.forEach(sebep => {
                     const li = document.createElement('li');
                      // Bu sebep personel kayıtlarinda kullanılıyor mu kontrol et
                     const isUsed = personeller.some(p => p.ayrilmaSebebi === sebep);
                      // Kullanılıyorsa sil butonu pasif olsun ve tooltiple bilgi ver
                     const button = isUsed ? `<button disabled title="Bu sebep personel kayıtlarında kullanılıyor.">Sil</button>` : `<button onclick="deleteAyrilmaSebebi('${sebep}')">Sil</button>`;
                     li.innerHTML = `<span>${sebep}</span>${button}`;
                     ayrilmaSebebiList.appendChild(li);
                 });
            }

             // Yeni: Şirket İsimleri listesini render et (Alfabetik Sıralı)
             if(sirketIsmiList){
                  // sirketIsimleri dizisi zaten başlangıçta ve ekleme/silme sonrası sıralandı
                 sirketIsimleri.forEach(sirket => {
                     const li = document.createElement('li');
                      // Bu şirket adı personel kayıtlarında kullanılıyor mu kontrol et (placeholder)
                      // Gelecekte personel veri yapısına şirket adı alanı eklendiğinde burası güncellenmeli
                     const isUsed = personeller.some(p => p.sirketIsmi === sirket); // p.sirketIsmi alanı henüz yok, bu sadece placeholder
                      // Kullanılıyorsa sil butonu pasif olsun ve tooltiple bilgi ver
                     const button = isUsed ? `<button disabled title="Bu şirket adı personel kayıtlarında kullanılıyor.">Sil</button>` : `<button onclick="deleteSirketIsmi('${sirket}')">Sil</button>`; // deleteSirketIsmi fonksiyonu çağrıldı
                     li.innerHTML = `<span>${sirket}</span>${button}`;
                     sirketIsmiList.appendChild(li);
                 });
             }

            // Yeni: Ulusal Bayramlar listesini render et (Alfabetik Sıralı)
            if(ulusalBayramList){
                 // ulusalBayramlar dizisi zaten başlangıçta ve ekleme/silme sonrası sıralandı
                ulusalBayramlar.forEach(bayramAdi => {
                    const li = document.createElement('li');
                    // Bu bayram adı tatil tarihlerinde kullanılıyor mu kontrol et (herhangi bir yılda)
                    const isUsed = Object.values(holidayDatesByYear).some(yearData =>
                        yearData.some(holiday => holiday.name === bayramAdi)
                    );
                     // Kullanılıyorsa sil butonu pasif olsun ve tooltiple bilgi ver
                    const button = isUsed ? `<button disabled title="Bu bayram adı tatil kayıtlarında kullanılıyor.">Sil</button>` : `<button onclick="deleteUlusalBayram('${bayramAdi}')">Sil</button>`;
                    li.innerHTML = `<span>${bayramAdi}</span>${button}`;
                    ulusalBayramList.appendChild(li);
                });
            }


             // Sayısal Ayar değerini inputa yükle (Yeni eklendi)
              const numericalSettingInput = document.getElementById('numericalSettingInput');
              if(numericalSettingInput) {
                  numericalSettingInput.value = numericalSetting;
              }
         }


        /**
         * Geçmiş tablosunu render eder.
         */
        function renderGecmis() {
            const tb = document.querySelector('#gecmisTable tbody');
            if(!tb) {
                 return;
            }
            tb.innerHTML = ''; // Tablo içeriğini temizle

            // Filtrelenmiş geçmiş listesini al (zamana göre tersten sıralı)
            const filteredGecmis = filterGecmisData(gecmis, gecmisFilters).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            // Her geçmiş kaydı için tabloya satır ekle
            filteredGecmis.forEach(g => {
                const r = tb.insertRow(); // Yeni satır oluştur

                 // Hücrelere verileri ekle
                [g.timestampDisplay, g.user, g.type, g.itemType].forEach(v => r.insertCell().innerText = v);

                 // İlgili Personel hücresi
                 const personelCell = r.insertCell();
                 // Eğer personelId mevcutsa ve Personel veya İzin tipi ise ilgili personeli bul ve göster
                 if (g.personelId && (g.itemType === 'Personel' || g.itemType === 'İzin' || g.itemType === 'Kullanıcı' || g.itemType === 'Tatiller')) { // Tatiller logları için de personel ID eklendi
                      const affectedPersonel = personeller.find(p => p.id === g.personelId);
                     personelCell.innerText = affectedPersonel ? affectedPersonel.adSoyad : 'Bilinmiyor';
                 } else {
                     personelCell.innerText = ''; // Veya '-' veya uygun bir değer
                 }

                 // Açıklama hücresi
                 r.insertCell().innerText = g.description;
            });
         }


        /**
         * Tüm tabloları ve select kutularını yeniden render eder.
         * Genellikle bir veri değişikliği olduğunda çağrılır.
         */
        function renderAll() {
            renderPersonel();
            renderIzin();
            renderUsers();
            renderSelects(); // Veri değişince select kutuları güncellenmeli

             // Ayarlar tabı açıksa onu da güncelle (örn: silme butonlarının durumu)
             const activeTab = document.querySelector('.tablinks.active');
             if(activeTab && activeTab.dataset.tab === 'ayarlar') {
                 renderSettings();
                 initCollapsibles(); // Ayarlar render edildiğinde collapsible'ları yeniden başlat
                 loadNumericalSetting(); // YENİ EKLENEN SATIR
             }

              // Tatiller tabı açıksa onu da güncelle
             if(activeTab && activeTab.dataset.tab === 'tatiller') {
                 // Tatiller tabını yeniden render et - ancak burası renderTatiller içinde yıl seçimi yapıldığı için doğrudan renderHolidayList çağırılmamalı
                 // renderTatiller çağrıldığında en son seçilen yıl otomatik olarak yüklenir ve renderHolidayList onun için çalışır
                 renderTatiller();
             }
         }


        /**
         * Personel düzenleme formunu açar ve seçilen personelin bilgilerini doldurur.
         * @param {number} id - Düzenlenecek personelin ID'si.
         */
        function personelGuncelle(id) {
            const p = personeller.find(x => x.id === id); // Personeli bul
            if (!p) {
                 return;
            }

            // Formu temizle ve göster
            clearPersonelForm();
            showPersonelForm();


            // Form alanlarını personel bilgileriyle doldur (Yeni sıra dikkate alındı)
            const editPersonelId = document.getElementById('editPersonelId');
            if(editPersonelId) editPersonelId.value = p.id;
             const isYeriInput = document.getElementById('isYeriInput'); // İş Yeri en başa alındı
             if(isYeriInput) isYeriInput.value = p.isyeri || '';
            const unvanSelect = document.getElementById('unvanSelect');
            if(unvanSelect) unvanSelect.value = p.unvan || '';
            const adSoyadInput = document.getElementById('adSoyadInput');
            if(adSoyadInput) adSoyadInput.value = p.adSoyad || '';
            const tcInput = document.getElementById('tcInput');
            if(tcInput) tcInput.value = p.tc || '';
            const gsmInput = document.getElementById('gsmInput');
            if(gsmInput) gsmInput.value = p.gsm || '';
            const emailInput = document.getElementById('emailInput'); // E-Posta inputu
            if(emailInput) emailInput.value = p.email || ''; // E-Posta bilgisini doldur
             const tiybInput = document.getElementById('tiybInput'); // TİYB inputu (date)
             if(tiybInput) tiybInput.value = p.tiybGecisSuresi || ''; // TİYB bilgisini doldur (date string)
             const pmTarihiInput = document.getElementById('pmTarihiInput');
             if(pmTarihiInput) pmTarihiInput.value = p.pmTarihi || '';
            const dogumInput = document.getElementById('dogumInput');
            if(dogumInput) dogumInput.value = p.dogum || '';
            const iseInput = document.getElementById('iseInput');
            if(iseInput) iseInput.value = p.ise || '';
            const kanInput = document.getElementById('kanInput');
            if(kanInput) kanInput.value = p.kan || '';
            const tahsilInput = document.getElementById('tahsilInput'); // Tahsil sırası değişti
            if(tahsilInput) tahsilInput.value = p.tahsil || '';
            const plakaInput = document.getElementById('plakaInput'); // Plaka sırası değişti
            if(plakaInput) plakaInput.value = p.plaka || '';
             const adresInput = document.getElementById('adresInput');
            if(adresInput) adresInput.value = p.adres || '';
             const ilceInput = document.getElementById('ilceInput'); // İlçe sona alındı
             if(ilceInput) ilceInput.value = p.ilce || '';
            // ---- BAŞLANGIÇ: Mevcut Personel Fotoğrafını Forma Yükle ----
            const personelFotoPreview = document.getElementById('personelFotoPreview');
            const removePersonelFotoButton = document.getElementById('removePersonelFotoButton');
            const personelFotoInput = document.getElementById('personelFotoInput'); // Input'u da alalım ki sıfırlayabilelim

            if (personelFotoInput) personelFotoInput.value = ""; // Yeni dosya seçimine izin vermek için inputu sıfırla

            if (p.fotografData) { // Eğer personelin kayıtlı bir fotoğraf verisi varsa
                if (personelFotoPreview) {
                    personelFotoPreview.setAttribute('src', p.fotografData);
                    personelFotoPreview.style.display = 'block';
                }
                if (removePersonelFotoButton) {
                    removePersonelFotoButton.style.display = 'inline-block';
                }
                currentPersonelFotoBase64 = p.fotografData; // Global değişkeni güncelle
            } else { // Kayıtlı fotoğraf yoksa önizlemeyi ve butonu gizle, global değişkeni sıfırla
                if (personelFotoPreview) {
                    personelFotoPreview.style.display = 'none';
                    personelFotoPreview.setAttribute('src', '#');
                }
                if (removePersonelFotoButton) {
                    removePersonelFotoButton.style.display = 'none';
                }
                currentPersonelFotoBase64 = null;
            }
            // ---- BİTİŞ: Mevcut Personel Fotoğrafını Forma Yükle ----

            // Pasif bilgileri alanını ve Pasife Al/Aktif Yap butonunu göster
             const passiveInfoDisplay = document.getElementById('passiveInfoDisplay');
             const passiveStatusSpan = document.getElementById('passiveStatus');
             const passiveReasonSpan = document.getElementById('passiveReason');
             const passiveDateSpan = document.getElementById('passiveDate');
             const togglePassiveButton = document.getElementById('togglePassiveButton');
             const deletePersonelButton = document.getElementById('deletePersonelButton'); // Sil butonu alındı

             // Kullanıcının silme yetkisi varsa sil butonunu göster (aktif veya pasif personel için)
             const canDelete = currentUser && (currentUser.role === 'Yönetici' || (p.unvan && currentUser.permissions[p.unvan] && currentUser.permissions[p.unvan].includes('delete')));

             if (canDelete) {
                  if(deletePersonelButton) {
                       deletePersonelButton.style.display = 'inline-block';
                       deletePersonelButton.onclick = () => personelSil(p.id); // Sil butonu tıklama olayı
                   }
             } else {
                  if(deletePersonelButton) deletePersonelButton.style.display = 'none';
             }


             if(p.isPassive){
                 if(passiveInfoDisplay) passiveInfoDisplay.style.display = 'block';
                 if(passiveStatusSpan) passiveStatusSpan.innerText = 'Pasif';
                 if(passiveReasonSpan) passiveReasonSpan.innerText = p.ayrilmaSebebi || 'Belirtilmemiş';
                 if(passiveDateSpan) passiveDateSpan.innerText = formatDateForDisplay(p.ayrilmaTarihi) || 'Belirtilmemiş';
                 // Buton metnini ve rengini "Aktif Yap" olarak ayarla
                 if(togglePassiveButton) {
                       togglePassiveButton.innerText = 'Aktif Yap';
                       togglePassiveButton.classList.remove('passive-button');
                       togglePassiveButton.classList.add('active-button');
                       togglePassiveButton.style.display = 'inline-block';
                       togglePassiveButton.onclick = () => togglePersonelStatus(p.id, true); // Durumu aktife çevir

                       // "Kaydet" butonu pasif personelde görünmesin (isteğe bağlı, sadece durumu değiştirmek için)
                        const saveButton = document.getElementById('savePersonelButton');
                        if(saveButton) saveButton.style.display = 'none';

                 } else {
                 }

            } else {
                 if(passiveInfoDisplay) passiveInfoDisplay.style.display = 'none';
                 // Buton metnini ve rengini "Çıkış Yap" olarak ayarla (Burada değişiklik yapıldı)
                 if(togglePassiveButton) {
                      togglePassiveButton.innerText = 'Çıkış Yap'; // **** Değişiklik Burada ****
                      togglePassiveButton.classList.remove('active-button');
                      togglePassiveButton.classList.add('passive-button');
                      togglePassiveButton.style.display = 'inline-block';
                       togglePassiveButton.onclick = () => showAyrilmaSebebiModal(p.id); // Ayrılma sebebi modalını aç

                       // "Kaydet" butonu aktif personelde görünsün
                       const saveButton = document.getElementById('savePersonelButton');
                       if(saveButton) saveButton.style.display = 'inline-block';

                 } else {
                 }
            }
         }

        /**
         * Personelin aktif/pasif durumunu değiştirir ve kaydeder.
         * @param {number} id - Durumu değiştirilecek personelin ID'si.
         * @param {boolean} makeActive - Personeli aktif yapmak için true, pasif yapmak için false.
         * @param {string} ayrilmaSebebi - Pasif yapılıyorsa ayrılma sebebi.
         * @param {string} ayrilmaTarihi - Pasif yapılıyorsa ayrılma tarihi.
         */
         function togglePersonelStatus(id, makeActive, ayrilmaSebebi = null, ayrilmaTarihi = null) {
              const personelIndex = personeller.findIndex(p => p.id === id);
              if (personelIndex === -1) {
                  return;
              }

             const personel = personeller[personelIndex];
             let actionType = '';
             let logDescription = '';

             if (makeActive) {
                  // Aktif Yapılıyor
                 if (!confirm(`${personel.adSoyad} personelini tekrar aktif yapmak istediğinizden emin misiniz?`)) {
                     return; // Vazgeçildi
                 }
                 personel.isPassive = false;
                 personel.ayrilmaSebebi = null;
                 personel.ayrilmaTarihi = null;
                 actionType = 'Durum Değişikliği';
                 logDescription = `${personel.adSoyad} (${personel.tc}) tekrar aktif yapıldı.`;
             } else {
                 // Pasif Yapılıyor (Bu fonksiyon ayrılma sebebi modalından çağrılacak)
                 personel.isPassive = true;
                 personel.ayrilmaSebebi = ayrilmaSebebi;
                 personel.ayrilmaTarihi = ayrilmaTarihi;
                  actionType = 'Durum Değişikliği';
                 logDescription = `${personel.adSoyad} (${personel.tc}) pasife alındı (Sebep: ${ayrilmaSebebi}, Tarih: ${formatDateForDisplay(ayrilmaTarihi)}).`;
             }

             // Personel listesini güncelle (zaten referans üzerinden güncellendi)
             localStorage.setItem('personeller', JSON.stringify(personeller)); // Yerel depolamaya kaydet

             hidePersonelForm(); // Formu gizle
             renderAll(); // Tabloları yeniden render et

             logAction(actionType, 'Personel', logDescription, personel.id); // personel ID loglandı
          }


        /**
         * Seçilen personeli silme onay modalını açar.
         * @param {number} id - Silinecek personelin ID'si.
         */
        function personelSil(id) {
            const p = personeller.find(x => x.id === id);
            if (!p) {
                 return;
            }
             // Onay modalını göster
             showConfirmDeleteModal('personel', id, `"${p.adSoyad}" adlı personeli silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.`);
         }


         /**
          * Personeli gerçekten siler (onaylandıktan sonra çağrılır).
          * @param {number} id - Silinecek personelin ID'si.
          * @param {string} reason - Silme nedeni (log için).
          */
         function personelSilConfirmed(id, reason) {
             const p = personeller.find(x => x.id === id); // Silinecek personeli bul (log için)
             // Personel listesinden sil
            personeller = personeller.filter(x => x.id !== id);
            localStorage.setItem('personeller', JSON.stringify(personeller)); // Yerel depolamaya kaydet

            // Silinen personele ait kullanıcıları da sil
            users = users.filter(u => u.personelId !== id);
            localStorage.setItem('users', JSON.stringify(users));

            // Silinen personele ait izin kayıtlarını da sil
            izinler = izinler.filter(i => i.personelId !== id);
            localStorage.setItem('izinler', JSON.stringify(izinler));

            // Silinen personele ait geçmiş kayıtlarındaki personelId'yi null yap veya kaydı sil (opsiyonel, null yapmak daha bilgilendirici olabilir)
            gecmis = gecmis.map(g => g.personelId === id ? { ...g, personelId: null, description: `Silinen personele ait işlem: ${g.description} (Silme Nedeni: ${reason})` } : g); // Açıklamaya silme nedeni eklendi
             localStorage.setItem('gecmis', JSON.stringify(gecmis));


             renderAll(); // Tabloları ve select kutularını yeniden render et

            logAction('Silme', 'Personel', `${p?.adSoyad || 'Bilinmiyor'} (${p?.tc || 'Bilinmiyor'}) silindi. Silme Nedeni: ${reason}`, id); // personel ID ve silme nedeni loglandı
         }


        /**
         * İzin düzenleme formunu açar ve seçilen iznin bilgilerini doldurur.
         * @param {number} id - Düzenlenecek iznin ID'si.
         */
        function izinGuncelle(id) {
            const z = izinler.find(x => x.id === id); // İzin kaydını bul
            if (!z) {
                 return;
            }

            // Form alanlarını izin bilgileriyle doldur
            const editIzinId = document.getElementById('editIzinId');
            if(editIzinId) editIzinId.value = z.id;
            const izinPersonelSelect = document.getElementById('izinPersonelSelect');
            if(izinPersonelSelect) izinPersonelSelect.value = z.personelId;
            const izinTurSelect = document.getElementById('izinTurSelect');
            if(izinTurSelect) izinTurSelect.value = z.tur;
            const izinBasInput = document.getElementById('izinBasInput');
            if(izinBasInput) izinBasInput.value = z.bas;
            const izinBitInput = document.getElementById('izinBitInput');
            if(izinBitInput) izinBitInput.value = z.bit;

             // Sil butonunu göster (güncelleme ekranında)
             const deleteIzinButton = document.getElementById('deleteIzinButton');
             const p = personeller.find(personel => personel.id === z.personelId); // İzin sahibini bul
             // Kullanıcının silme yetkisi varsa ve izin sahibi pasif değilse sil butonunu göster
            const canDelete = currentUser && (currentUser.role === 'Yönetici' || (p?.unvan && currentUser.permissions[p.unvan] && currentUser.permissions[p.unvan].includes('delete')));

             if (deleteIzinButton && canDelete && !p?.isPassive) { // Personel pasif değilse silme butonu görünsün
                 deleteIzinButton.style.display = 'inline-block';
                 deleteIzinButton.onclick = () => izinSil(z.id); // Sil butonu tıklama olayı
             } else if(deleteIzinButton){
                 deleteIzinButton.style.display = 'none';
             }


            showIzinForm(); // İzin formunu göster
         }


        /**
         * Seçilen izin kaydını silme onay modalını açar.
         * @param {number} id - Silinecek iznin ID'si.
         */
        function izinSil(id) {
             const z = izinler.find(x => x.id === id);
             if (!z) {
                 return;
             }
             const p = personeller.find(x => x.id === z.personelId);
             // Onay modalını göster
             showConfirmDeleteModal('izin', id, `${p?.adSoyad || 'Bilinmiyor'} personelinin ${z.tur} (${formatDateForDisplay(z.bas)} - ${formatDateForDisplay(z.bit)}) iznini silmek istediğinizden emin misiniz?`);
         }


         /**
          * İzin kaydını gerçekten siler (onaylandıktan sonra çağrılır).
          * @param {number} id - Silinecek iznin ID'si.
          * @param {string} reason - Silme nedeni (log için).
          */
         function izinSilConfirmed(id, reason) {
             const z = izinler.find(x => x.id === id); // Silinecek izni bul (log için)
             // İzin listesinden sil
            izinler = izinler.filter(x => x.id !== id);
            localStorage.setItem('izinler', JSON.stringify(izinler)); // Yerel depolamaya kaydet

             renderAll(); // Tabloları ve select kutularını yeniden render et

            const p = personeller.find(x => x.id === z?.personelId);
            logAction('Silme', 'İzin', `${p?.adSoyad || 'Bilinmiyor'} için ${z?.tur || 'Bilinmiyor'} ${z?.bas || ''} - ${z?.bit || ''} silindi. Silme Nedeni: ${reason}`, z?.personelId || null); // personel ID ve silme nedeni loglandı
         }


        /**
         * Kullanıcı düzenleme formunu açar ve seçilen kullanıcının bilgilerini doldurur.
         * @param {number} id - Düzenlenecek kullanıcının ID'si.
         */
        function userGuncelle(id) {
            const u = users.find(x => x.id === id); // Kullanıcıyı bul
            if (!u) {
                 return;
            }

            // Form alanlarını kullanıcı bilgileriyle doldur
            const editUserId = document.getElementById('editUserId');
            if(editUserId) editUserId.value = u.id;

            const userPersonelSelect = document.getElementById('userPersonelSelect');
            if(userPersonelSelect) {
                userPersonelSelect.value = u.personelId || '';
                 // Personel seçicisini pasif yap (kullanıcının personelini değiştiremez)
                 // Ancak admin kullanıcısı için personel seçeneği aktif kalmalı
                 userPersonelSelect.disabled = u.username !== adminTc && u.personelId !== null;
                 // Eğer kullanıcıya atanmış personel, select box'ta yoksa (örn: pasif olduğu için), ekle
                 const personel = personeller.find(p => p.id === u.personelId);
                 if (personel && !userPersonelSelect.querySelector(`option[value="${personel.id}"]`)) {
                       const option = new Option(personel.adSoyad, personel.id);
                       userPersonelSelect.add(option);
                  }

            }

            const userRoleSelect = document.getElementById('userRoleSelect');
            if(userRoleSelect) userRoleSelect.value = u.role || 'Kullanıcı';

            const passwordInput = document.getElementById('passwordInput');
            if(passwordInput) passwordInput.value = ''; // Şifre alanı boş bırakılır

            showKullaniciForm(u.id); // Kullanıcı formunu göster (düzenleme modunda)
         }


        /**
         * Seçilen kullanıcıyı siler.
         * @param {number} id - Silinecek kullanıcının ID'si.
         */
        function userSil(id) {
             // Yönetici kendini silemez kontrolü
             if (currentUser && currentUser.id === id) {
                  alert("Kendinizi silemezsiniz.");
                  return;
             }

             if (confirm('Bu kullanıcıyı silmek istediğinizden emin misiniz?')) {
                const u = users.find(x => x.id === id); // Silinecek kullanıcıyı bul (log için)

                 // Kullanıcı listesinden sil
                users = users.filter(x => x.id !== id);
                localStorage.setItem('users', JSON.stringify(users)); // Yerel depolamaya kaydet

                 renderAll(); // Tabloları ve select kutularını yeniden render et

                const p = personeller.find(x => x.id === u?.personelId);
                logAction('Silme', 'Kullanıcı', `${p?.adSoyad || 'Bilinmiyor'} için kullanıcı (${u?.username || 'Bilinmiyor'}) silindi.`, u?.personelId || null); // personel ID loglandı
             }
        }


        /**
         * Personel detay modalını açar ve seçilen personelin detaylarını gösterir.
         * @param {number} id - Detayları gösterilecek personelin ID'si.
         */
        function showPersonelDetail(id) {
            const p = personeller.find(x => x.id === id); // Personeli bul
            if (!p) {
                 return;
            }

            const modal = document.getElementById('personelDetailModal');
            const detailsDiv = modal ? modal.querySelector('.modal-details') : null;

            if(!modal || !detailsDiv) {
                 return;
            }

            detailsDiv.innerHTML = ''; // Modal içeriğini temizle

            // Detay alanlarını doldur (Yeni sıra dikkate alındı)
            const fields = {
                 isyeri: 'İş Yeri', // İş Yeri en başa alındı
                unvan: 'Ünvan', adSoyad: 'Ad Soyad', tc: 'TC Kimlik', gsm: 'GSM', email: 'E-Posta',
                tiybGecisSuresi: 'TİYB Geçiş Süresi',
                pmTarihi: 'PM Tarihi',
                dogum: 'Doğum Tarihi', ise: 'İşe Başlama Tarihi', kan: 'Kan Grubu',
                tahsil: 'Tahsili', // Tahsil sırası değişti
                plaka: 'Plaka', // Plaka sırası değişti
                adres: 'Adres', ilce: 'İlçe' // İlçe sona alındı
            };
            for (const key in fields) {
                let value = p[key] || 'Belirtilmemiş';
                 // Tarih alanlarını biçimlendir (TİYB de dahil)
                if (['dogum', 'ise', 'tiybGecisSuresi', 'pmTarihi'].includes(key)) {
                    value = formatDateForDisplay(value);
                }
                detailsDiv.innerHTML += `<p><strong>${fields[key]}:</strong> ${value}</p>`;
            }

             // İzin hakkı ve dönemi bilgilerini ekle
            detailsDiv.innerHTML += `<p><strong>Yıllık İzin Hakkı:</strong> ${calculateAnnualLeave(p.ise)}</p>`;
            // Kalan İzin Gün Sayısı buraya da eklenebilir (veri yapısına eklenince)
            detailsDiv.innerHTML += `<p><strong>Mevcut İzin Yılı:</strong> ${calculateLeaveEntitlementYear(p.ise).bas} - ${calculateLeaveEntitlementYear(p.ise).bit}</p>`; // İzin dönemi hesaplandı ve eklendi

             // Pasif bilgilerini ekle (varsa)
             if(p.isPassive){
                 detailsDiv.innerHTML += `<p><strong>Durum:</strong> Pasif</p>`;
                 detailsDiv.innerHTML += `<p><strong>Ayrılma Sebebi:</strong> ${p.ayrilmaSebebi || 'Belirtilmemiş'}</p>`;
                 detailsDiv.innerHTML += `<p><strong>Ayrılma Tarihi:</strong> ${formatDateForDisplay(p.ayrilmaTarihi) || 'Belirtilmemiş'}</p>`;
             }

	// ---- BAŞLANGIÇ: Personel Fotoğrafını Detay Modalında Göster ----
            if (p.fotografData) { // Eğer personelin kayıtlı bir fotoğraf verisi varsa
                const fotoDiv = document.createElement('div');
                fotoDiv.style.marginTop = '15px';
                fotoDiv.style.textAlign = 'center'; // Fotoğrafı ortala

                const fotoImg = document.createElement('img');
                fotoImg.setAttribute('src', p.fotografData);
                fotoImg.setAttribute('alt', `${p.adSoyad || 'Personel'} Fotoğrafı`);
                fotoImg.style.maxWidth = '200px'; // Modal içinde görünecek max genişlik
                fotoImg.style.maxHeight = '200px'; // Modal içinde görünecek max yükseklik
                fotoImg.style.border = '1px solid #ddd';
                fotoImg.style.borderRadius = '4px';
                fotoImg.style.objectFit = 'cover';

                fotoDiv.appendChild(fotoImg);
                detailsDiv.appendChild(fotoDiv); // Fotoğrafı modal içeriğine ekle
            }
            // ---- BİTİŞ: Personel Fotoğrafını Detay Modalında Göster ----

            modal.style.display = 'flex'; // Modalı göster
         }


        /**
         * Personel detay modalını kapatır.
         */
        function closePersonelDetailModal() {
            const modal = document.getElementById('personelDetailModal');
            if(modal) modal.style.display = 'none';
        }


         /**
          * Kullanıcı detay modalını açar ve seçilen kullanıcının detaylarını ve yetkilerini gösterir.
          * @param {number} id - Detayları gösterilecek kullanıcının ID'si.
          */
         function showUserDetail(id) {
              const u = users.find(x => x.id === id); // Kullanıcıyı bul
             if (!u) {
                  return;
             }

             const modal = document.getElementById('userDetailModal');
             const detailsDiv = modal ? modal.querySelector('.modal-details') : null;

              if(!modal || !detailsDiv) {
                  return;
              }

             detailsDiv.innerHTML = ''; // Modal içeriğini temizle

             const personel = personeller.find(p => p.id === u.personelId);
             detailsDiv.innerHTML += `<p><strong>Personel:</strong> ${personel?.adSoyad || 'Atanmamış'}</p>`;
             detailsDiv.innerHTML += `<p><strong>Kullanıcı Adı (TC):</strong> ${u.username || 'Belirtilmemiş'}</p>`;
             detailsDiv.innerHTML += `<p><strong>Rol:</strong> ${u.role || 'Belirtilmemiş'}</p>`;
             // Yetkileri göster (eğer rol Yönetici değilse)
             if (u.role !== 'Yönetici' && u.permissions) {
                 detailsDiv.innerHTML += `<p><strong>Yetkilendirilen Ünvanlar ve İşlemler:</strong></p>`;
                 // Yetkileri ünvanlara göre sırala
                 const sortedUnvans = Object.keys(u.permissions).sort((a, b) => a.localeCompare(b, 'tr'));
                 if (sortedUnvans.length > 0) {
                     detailsDiv.innerHTML += `<ul>`;
                     sortedUnvans.forEach(unvan => {
                         const actions = u.permissions[unvan];
                          // İşlem isimlerini daha anlaşılır hale getir
                         const actionNames = actions.map(action =>
                             action === 'view' ? 'Görme' : action === 'add' ? 'Ekleme' : action === 'update' ? 'Güncelleme' : 'Silme'
                         );
                         detailsDiv.innerHTML += `<li><strong>${unvan}:</strong> ${actionNames.join(', ')}</li>`;
                      });
                     detailsDiv.innerHTML += `</ul>`;
                 } else {
                      detailsDiv.innerHTML += `<p><em>Hiç yetki tanımlanmamış.</em></p>`;
                 }

             } else if (u.role === 'Yönetici') {
                 detailsDiv.innerHTML += `<p><strong>Yetkiler:</strong> Yönetici (Tüm yetkilere sahip)</p>`;
             } else {
                 detailsDiv.innerHTML += `<p><strong>Yetkiler:</strong> Belirtilmemiş veya Geçersiz</p>`;
             }


             modal.style.display = 'flex'; // Modalı göster
          }


         /**
          * Kullanıcı detay modalını kapatır.
          */
         function closeUserDetailModal() {
              const modal = document.getElementById('userDetailModal');
              if(modal) modal.style.display = 'none';
          }


        // Şifre Değiştir Butonu Tıklama Olayı (Kullanıcının kendi şifresini değiştirme modalını açar)
        const changePasswordButton = document.getElementById('changePasswordButton');
        if(changePasswordButton){
             changePasswordButton.onclick = () => {
                 // Form alanlarını temizle
                const currentPasswordInput = document.getElementById('currentPasswordInput');
                if(currentPasswordInput) currentPasswordInput.value = '';
                const newPasswordInput = document.getElementById('newPasswordInput');
                if(newPasswordInput) newPasswordInput.value = '';
                const confirmNewPasswordInput = document.getElementById('confirmNewPasswordInput');
                if(confirmNewPasswordInput) confirmNewPasswordInput.value = '';
                const passwordChangeError = document.getElementById('passwordChangeError');
                if(passwordChangeError) passwordChangeError.innerText = ''; // Hata mesajını temizle

                const changePasswordModal = document.getElementById('changePasswordModal');
                if(changePasswordModal) {
                     changePasswordModal.style.display = 'flex'; // Modalı göster
                 } else {
                 }
            };
        }


        // Kullanıcının Kendi Şifresini Değiştirme Modalındaki Kaydet Butonu Olayı
        const savePasswordButton = document.getElementById('savePasswordButton');
        if(savePasswordButton){
             savePasswordButton.onclick = () => {
                 const currentInput = document.getElementById('currentPasswordInput');
                const newInput = document.getElementById('newPasswordInput');
                const confirmInput = document.getElementById('confirmNewPasswordInput');
                const errorDiv = document.getElementById('passwordChangeError');
                // Elementlerin varlığını kontrol et
                 if (!currentInput || !newInput || !confirmInput || !errorDiv) {
                      alert('Form elementleri eksik, lütfen konsolu kontrol edin.');
                      return; // Elementler yoksa devam etme
                 }

                const current = currentInput.value;
                const newPass = newInput.value;
                const confirm = confirmInput.value;
                errorDiv.innerText = ''; // Hata mesajını temizle

                // Alanların dolu olup olmadığını kontrol et
                if (!current || !newPass || !confirm) {
                    errorDiv.innerText = 'Tüm alanlar doldurulmalıdır.';
                    return;
                }

                // Mevcut şifrenin doğru olup olmadığını kontrol et
                if (currentUser && currentUser.password !== current) {
                    errorDiv.innerText = 'Mevcut şifre yanlış.';
                    return;
                }

                // Yeni şifrelerin eşleşip eşleşmediğini kontrol et
                if (newPass !== confirm) {
                    errorDiv.innerText = 'Yeni şifreler eşleşmiyor.';
                    return;
                }

                // Yeni şifre uzunluğunu kontrol et
                if (newPass.length < 6) {
                    errorDiv.innerText = 'Yeni şifre en az 6 karakter olmalıdır.';
                    return;
                }

                 // Kullanıcının şifresini güncelle
                users = users.map(u => u.id === currentUser.id ? { ...u, password: newPass } : u);
                localStorage.setItem('users', JSON.stringify(users)); // Yerel depolamaya kaydet

                 currentUser.password = newPass; // Giriş yapan kullanıcının şifresini güncelle

                logAction('Güncelleme', 'Şifre', `${currentUser.adSoyad || currentUser.username} şifresini değiştirdi.`);
                const changePasswordModal = document.getElementById('changePasswordModal');
                if(changePasswordModal) changePasswordModal.style.display = 'none'; // Modalı kapat

                alert('Şifre başarıyla değiştirildi.'); // Başarı mesajı göster
             };
        }

        /**
         * Şifre değiştir modalını kapatır.
         */
        function closeChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            if(modal) modal.style.display = 'none';
        }


         /**
          * Yönetici olarak başka bir kullanıcının şifresini değiştirme modalını açar.
          * @param {number} userId - Şifresi değiştirilecek kullanıcının ID'si.
          */
         function showChangeOtherPasswordModal(userId) {
              const userToChange = users.find(u => u.id === userId);
              if (!userToChange) {
                  return;
              }

             const modal = document.getElementById('changeOtherPasswordModal');
             const userIdInput = document.getElementById('otherUserIdToChangePassword');
             const userDisplayNameSpan = document.getElementById('otherUserDisplayName');
             const newPasswordInput = document.getElementById('otherNewPasswordInput');
             const confirmNewPasswordInput = document.getElementById('otherConfirmNewPasswordInput');
             const errorDiv = document.getElementById('otherPasswordChangeError');
             // Elementlerin varlığını kontrol et
              if (!modal || !userIdInput || !userDisplayNameSpan || !newPasswordInput || !confirmNewPasswordInput || !errorDiv) {
                   alert('Modal elementleri eksik, lütfen konsolu kontrol edin.');
                   return; // Elementler yoksa devam etme
              }

             userIdInput.value = userToChange.id; // Kullanıcı ID'sini sakla

             const personel = personeller.find(p => p.id === userToChange.personelId);
             userDisplayNameSpan.innerText = personel?.adSoyad || userToChange.username; // Kullanıcı adını/soyadını göster

             // Form alanlarını ve hata mesajını temizle
             newPasswordInput.value = '';
             confirmNewPasswordInput.value = '';
             errorDiv.innerText = '';


             modal.style.display = 'flex'; // Modalı göster
          }

         /**
          * Yönetici olarak başka bir kullanıcının şifresini değiştirme modalını kapatır.
          */
         function closeChangeOtherPasswordModal() {
              const modal = document.getElementById('changeOtherPasswordModal');
              if(modal) modal.style.display = 'none';
          }


        /**
         * Personeli pasife alma modalını açar.
         * @param {number} personelId - Pasife alınacak personelin ID'si.
         */
         function showAyrilmaSebebiModal(personelId) {
              const modal = document.getElementById('ayrilmaSebebiModal');
              const personelIdInput = document.getElementById('personelIdToPassive');
             const ayrilmaSebebiSelect = document.getElementById('ayrilmaSebebiSelect');
             const ayrilmaTarihiInput = document.getElementById('ayrilmaTarihiInput');
             const errorDiv = document.getElementById('ayrilmaSebebiError');
             // Elementlerin varlığını kontrol et
             if (!modal || !personelIdInput || !ayrilmaSebebiSelect || !ayrilmaTarihiInput || !errorDiv) {
                 alert('Modal elementleri eksik, lütfen konsolu kontrol edin.');
                 return; // Elementler yoksa devam etme
             }

             personelIdInput.value = personelId; // Pasife alınacak personel ID'sini sakla

             // Ayrılma Sebepleri select kutusunu doldur (renderSelects zaten yapıyor, sadece temizle)
             ayrilmaSebebiSelect.innerHTML = '<option value="">Sebep Seçiniz</option>';
             ayrilmaSebepleri.forEach(sebep => {
                  ayrilmaSebebiSelect.add(new Option(sebep, sebep));
             });
             // Tarih alanını ve hata mesajını temizle
             ayrilmaTarihiInput.value = '';
             errorDiv.innerText = '';


             modal.style.display = 'flex'; // Modalı göster
          }

         /**
          * Personeli pasife alma modalını kapatır.
          */
         function closeAyrilmaSebebiModal() {
              const modal = document.getElementById('ayrilmaSebebiModal');
              if(modal) modal.style.display = 'none';
          }


        // Ayrılma Sebebi Modalındaki Kaydet Butonu Olayı (Personeli Pasife Alma)
        const saveAyrilmaSebebiButton = document.getElementById('saveAyrilmaSebebiButton');
        if(saveAyrilmaSebebiButton){
             saveAyrilmaSebebiButton.onclick = () => {
                 const personelIdInput = document.getElementById('personelIdToPassive');
                const ayrilmaSebebiSelect = document.getElementById('ayrilmaSebebiSelect');
                const ayrilmaTarihiInput = document.getElementById('ayrilmaTarihiInput');
                const errorDiv = document.getElementById('ayrilmaSebebiError');
                // Elementlerin varlığını kontrol et
                 if (!personelIdInput || !ayrilmaSebebiSelect || !ayrilmaTarihiInput || !errorDiv) {
                      alert('Form elementleri eksik, lütfen konsolu kontrol edin.');
                      return; // Elementler yoksa devam etme
                 }

                const personelId = +personelIdInput.value; // Kullanıcı ID'sini al
                const ayrilmaSebebi = ayrilmaSebebiSelect.value;
                const ayrilmaTarihi = ayrilmaTarihiInput.value;
                errorDiv.innerText = ''; // Hata mesajını temizle

                // Alanların dolu olup olmadığını kontrol et
                if (!ayrilmaSebebi || !ayrilmaTarihi) {
                    errorDiv.innerText = 'Lütfen ayrılma sebebi ve tarihini seçiniz.';
                    return;
                }

                // Tarih formatını kontrol et (date input zaten formatı zorlar aberinde boş olmamalı)
                if (!ayrilmaTarihi) {
                    errorDiv.innerText = 'Lütfen geçerli bir ayrılma tarihi seçiniz.';
                    return;
                }

                 // Personeli pasife al ve kaydet
                togglePersonelStatus(personelId, false, ayrilmaSebebi, ayrilmaTarihi);
                closeAyrilmaSebebiModal(); // Modalı kapat
             };
        }

        // Yönetici Tarafından Başka Kullanıcının Şifresini Değiştirme Modalındaki Kaydet Butonu Olayı
        const saveOtherPasswordButton = document.getElementById('saveOtherPasswordButton');
        if(saveOtherPasswordButton){
             saveOtherPasswordButton.onclick = () => {
                 const userIdInput = document.getElementById('otherUserIdToChangePassword');
                const newPasswordInput = document.getElementById('otherNewPasswordInput');
                const confirmNewPasswordInput = document.getElementById('otherConfirmNewPasswordInput');
                const errorDiv = document.getElementById('otherPasswordChangeError');
                // Elementlerin varlığını kontrol et
                 if (!userIdInput || !newPasswordInput || !confirmNewPasswordInput || !errorDiv) {
                      alert('Form elementleri eksik, lütfen konsolu kontrol edin.');
                      return; // Elementler yoksa devam etme
                 }

                const userId = +userIdInput.value; // Kullanıcı ID'sini al
                const newPass = newPasswordInput.value;
                const confirm = confirmNewPasswordInput.value;
                errorDiv.innerText = ''; // Hata mesajını temizle

                // Alanların dolu olup olmadığını kontrol et
                if (!newPass || !confirm) {
                    errorDiv.innerText = 'Tüm alanlar doldurulmalıdır.';
                    return;
                }

                // Yeni şifrelerin eşleşip eşleşmediğini kontrol et
                if (newPass !== confirm) {
                    errorDiv.innerText = 'Yeni şifreler eşleşmiyor.';
                    return;
                }

                // Yeni şifre uzunluğunu kontrol et
                if (newPass.length < 6) {
                    errorDiv.innerText = 'Yeni şifre en az 6 karakter olmalıdır.';
                    return;
                }

                 // Kullanıcıyı bul ve şifresini güncelle
                const userToUpdate = users.find(u => u.id === userId);
                if (userToUpdate) {
                     userToUpdate.password = newPass; // Şifreyi güncelle
                     localStorage.setItem('users', JSON.stringify(users)); // Yerel depolamaya kaydet

                     const personel = personeller.find(p => p.id === userToUpdate.personelId);
                     logAction('Şifre Sıfırlama', 'Kullanıcı', `${currentUser.adSoyad || currentUser.username} kullanıcısının şifresini değiştirdi.`, userToUpdate.personelId || null); // personel ID loglandı


                     closeChangeOtherPasswordModal(); // Modalı kapat
                     alert('Şifre başarıyla değiştirildi.'); // Başarı mesajı göster
                     renderUsers(); // Kullanıcı listesini yenile (gerekirse)

                } else {
                     errorDiv.innerText = 'Kullanıcı bulunamadı.';
                }
             };
        }


        // Genel silme onay modalı fonksiyonları
        /**
         * Genel silme onay modalını açar.
         * @param {string} type - Silinecek öğenin tipi ('personel' veya 'izin').
         * @param {number} id - Silinecek öğenin ID'si.
         * @param {string} message - Onay modalında gösterilecek mesaj.
         */
        function showConfirmDeleteModal(type, id, message) {
             const modal = document.getElementById('confirmDeleteModal');
             const messageElement = document.getElementById('confirmDeleteMessage');
             const confirmButton = document.getElementById('confirmDeleteButton');
             const deleteReasonContainer = document.getElementById('deleteReasonContainer'); // Silme nedeni konteynerini al
             const deleteReasonInput = document.getElementById('deleteReasonInput'); // Silme nedeni inputunu al
             const deleteReasonError = document.getElementById('deleteReasonError'); // Silme nedeni hata alanını al


             if (!modal || !messageElement || !confirmButton || !deleteReasonContainer || !deleteReasonInput || !deleteReasonError) {
                  alert('Silme onay modalı elementleri eksik.');
                  return;
             }

             // Silinecek öğe bilgilerini global değişkenlere kaydet
             currentDeleteItem = id;
             currentDeleteType = type;
             // Silme nedeni alanını ve hata mesajını temizle
             deleteReasonInput.value = '';
             deleteReasonError.innerText = '';

             // Modal mesajını ayarla
             messageElement.innerText = message;
             // Onay butonunun olay dinleyicisini güncelle
             // Eski dinleyiciyi kaldırarak birden fazla kez eklenmesini engelle
             if (confirmButton._confirmListener) {
                 confirmButton.removeEventListener('click', confirmButton._confirmListener);
             }

             const listener = () => {
                 handleConfirmDelete(); // Onaylandığında çağrılacak fonksiyon
             };
             confirmButton.addEventListener('click', listener);
             confirmButton._confirmListener = listener; // Dinleyiciyi referans olarak sakla

             // Modalı göster
             modal.style.display = 'flex';
             // Silme nedeni alanını göster
             deleteReasonContainer.style.display = 'block'; // Silme nedeni konteynerini göster
         }

        /**
         * Genel silme onay modalını kapatır.
         */
        function closeConfirmDeleteModal() {
             const modal = document.getElementById('confirmDeleteModal');
             const deleteReasonContainer = document.getElementById('deleteReasonContainer'); // Silme nedeni konteynerini al
             const deleteReasonInput = document.getElementById('deleteReasonInput'); // Silme nedeni inputunu al
             const deleteReasonError = document.getElementById('deleteReasonError'); // Silme nedeni hata alanını al


             if (modal) {
                 modal.style.display = 'none';
             }
             // Geçici değişkenleri sıfırla
             currentDeleteItem = null;
             currentDeleteType = '';

             // Silme nedeni alanını gizle ve temizle
             if(deleteReasonContainer) deleteReasonContainer.style.display = 'none';
             if(deleteReasonInput) deleteReasonInput.value = '';
             if(deleteReasonError) deleteReasonError.innerText = '';
         }

        /**
         * Silme işlemi onaylandığında ilgili silme fonksiyonunu çağırır.
         */
        function handleConfirmDelete() {
            const deleteReasonInput = document.getElementById('deleteReasonInput'); // Silme nedeni inputunu al
            const deleteReasonError = document.getElementById('deleteReasonError'); // Silme nedeni hata alanını al


            if (!deleteReasonInput || !deleteReasonError) {
                 alert('Silme nedeni elementleri eksik.');
                 return;
            }

            const reason = deleteReasonInput.value.trim(); // Silme nedenini al ve boşlukları temizle

            // Silme nedeni karakter sayısını kontrol et (en az 10)
             if (reason.length < 10) {
                 deleteReasonError.innerText = 'Silme nedeni en az 10 karakter olmalıdır.';
                 return; // Doğrulama başarısız
             }

             // Doğrulama başarılı, silme işlemine devam et
            if (currentDeleteItem !== null && currentDeleteType !== '') {
                 if (currentDeleteType === 'personel') {
                     personelSilConfirmed(currentDeleteItem, reason); // Personel silme fonksiyonunu çağır ve nedeni ilet
                 } else if (currentDeleteType === 'izin') {
                     izinSilConfirmed(currentDeleteItem, reason); // İzin silme fonksiyonunu çağır ve nedeni ilet
                 }
            }
             // İşlem tamamlandıktan sonra modalı kapat
             closeConfirmDeleteModal();
         }


        // Filtre Uygula Butonları Tıklama Olayları
        const applyPersonelFiltersButton = document.getElementById('applyPersonelFilters');
        if(applyPersonelFiltersButton){
             applyPersonelFiltersButton.onclick = () => {
                 // Personel filtre değerlerini al
                personelFilters = {
                    unvan: document.getElementById('personelUnvanFilter').value,
                    isyeri: document.getElementById('personelIsYeriFilter').value,
                    kan: document.getElementById('personelKanFilter').value,
                    tahsil: document.getElementById('personelTahsilFilter').value,
                    ilce: document.getElementById('personelIlceFilter').value
                     // Arama kutusu eklenecekse buraya eklenebilir
                 // search: document.getElementById('personelSearchInput').value.trim()
                };
                renderPersonel(); // Personel tablosunu filtrelerle yeniden render et
                logAction('Filtre Uygulama', 'Personel', 'Personel filtreleri uygulandı.'); // Loglama eklendi
             };
        }
        const applyIzinFiltersButton = document.getElementById('applyIzinFilters');
        if(applyIzinFiltersButton){
             applyIzinFiltersButton.onclick = () => {
                 // İzin filtre değerlerini al
                izinFilters = {
                    personelId: document.getElementById('izinPersonelFilter').value,
                    dateStart: document.getElementById('izinDateStart').value,
                    dateEnd: document.getElementById('izinDateEnd').value,
                    tur: document.getElementById('izinTurFilter').value
                };
                renderIzin(); // İzin tablosunu filtrelerle yeniden render et
                logAction('Filtre Uygulama', 'İzin', 'İzin filtreleri uygulandı.'); // Loglama eklendi
             };
        }
        const applyGecmisFiltersButton = document.getElementById('applyGecmisFilters');
        if(applyGecmisFiltersButton){
             applyGecmisFiltersButton.onclick = () => {
                 // Geçmiş filtre değerlerini al
                gecmisFilters = {
                    dateStart: document.getElementById('gecmisDateStart').value,
                    dateEnd: document.getElementById('gecmisDateEnd').value,
                    user: document.getElementById('gecmisUserFilter').value,
                    itemType: document.getElementById('gecmisItemTypeFilter').value,
                    description: document.getElementById('gecmisDescriptionSearch').value.trim(), // Boşlukları temizle
                    personelId: document.getElementById('gecmisAffectedPersonelFilter').value // Yeni filtre değeri alındı
                };
                renderGecmis(); // Geçmiş tablosunu filtrelerle yeniden render et
                 logAction('Filtre Uygulama', 'Geçmiş', 'Geçmiş filtreleri uygulandı.'); // Loglama eklendi
             };
        }


        // Ayarlar Sayfası Ekle Butonları Tıklama Olayları
        // Yeni Ünvan Ekle
        const addUnvanButton = document.getElementById('addUnvanButton');
        if(addUnvanButton){
             addUnvanButton.onclick = () => {
                 const newUnvanInput = document.getElementById('newUnvanInput');
                 if(!newUnvanInput) {
                     return;
                 }
                const newUnvan = newUnvanInput.value.trim(); // Boşlukları temizle
                 if (!newUnvan) {
                    alert('Lütfen bir ünvan giriniz.');
                    return;
                }
                if (unvanlar.includes(newUnvan)) {
                    alert('Bu ünvan zaten mevcut.');
                    return;
                }
                unvanlar.push(newUnvan); // Listeye ekle
                 unvanlar.sort((a, b) => a.localeCompare(b, 'tr')); // Ekleme sonrası sırala
                localStorage.setItem('unvanlar', JSON.stringify(unvanlar)); // Yerel depolamaya kaydet
                 newUnvanInput.value = ''; // Giriş alanını temizle
                renderSettings(); // Ayarlar listesini yeniden render et
                renderSelects(); // Unvan select kutularını güncelle
                logAction('Ekleme', 'Ayarlar', `Yeni ünvan "${newUnvan}" eklendi.`);
             };
        }

        // Yeni İzin Türü Ekle
        const addIzinTurButton = document.getElementById('addIzinTurButton');
        if(addIzinTurButton){
             addIzinTurButton.onclick = () => {
                 const newIzinTurInput = document.getElementById('newIzinTurInput');
                 if(!newIzinTurInput) {
                     return;
                 }
                const newIzinTur = newIzinTurInput.value.trim(); // Boşlukları temizle
                 if (!newIzinTur) {
                    alert('Lütfen bir izin türü giriniz.');
                    return;
                }
                if (izinTurileri.includes(newIzinTur)) {
                    alert('Bu izin türü zaten mevcut.');
                    return;
                }
                izinTurileri.push(newIzinTur); // Listeye ekle
                 izinTurileri.sort((a, b) => a.localeCompare(b, 'tr')); // Ekleme sonrası sırala
                localStorage.setItem('izinTurileri', JSON.stringify(izinTurileri)); // Yerel depolamaya kaydet
                 newIzinTurInput.value = ''; // Giriş alanını temizle
                renderSettings(); // Ayarlar listesini yeniden render et
                renderSelects(); // İzin türü select kutularini güncell
                logAction('Ekleme', 'Ayarlar', `Yeni izin türü "${newIzinTur}" eklendi.`);
             };
        }

        // Yeni Tahsil Ekle
        const addTahsilButton = document.getElementById('addTahsilButton');
        if(addTahsilButton){
             addTahsilButton.onclick = () => {
                 const newTahsilInput = document.getElementById('newTahsilInput');
                 if(!newTahsilInput) {
                     return;
                 }
                const newTahsil = newTahsilInput.value.trim(); // Boşlukları temizle
                 if (!newTahsil) {
                    alert('Lütfen bir tahsil giriniz.');
                    return;
                }
                if (tahsiller.includes(newTahsil)) {
                    alert('Bu tahsil zaten mevcut.');
                    return;
                }
                tahsiller.push(newTahsil); // Listeye ekle
                 tahsiller.sort((a, b) => a.localeCompare(b, 'tr')); // Ekleme sonrası sırala
                localStorage.setItem('tahsiller', JSON.stringify(tahsiller)); // Yerel depolamaya kaydet
                 newTahsilInput.value = ''; // Giriş alanını temizle
                renderSettings(); // Ayarlar listesini yeniden render et
                renderSelects(); // Tahsil select kutularını güncelle
                logAction('Ekleme', 'Ayarlar', `Yeni tahsil "${newTahsil}" eklendi.`);
             };
        }

        // Yeni Ayrılma Sebebi Ekle (Yeni eklendi)
        const addAyrilmaSebebiButton = document.getElementById('addAyrilmaSebebiButton');
        if(addAyrilmaSebebiButton){
             addAyrilmaSebebiButton.onclick = () => {
                 const newAyrilmaSebebiInput = document.getElementById('newAyrilmaSebebiInput');
                 if(!newAyrilmaSebebiInput) {
                     return;
                 }
                const newAyrilmaSebebi = newAyrilmaSebebiInput.value.trim(); // Boşlukları temizle
                 if (!newAyrilmaSebebi) {
                    alert('Lütfen bir ayrılma sebebi giriniz.');
                    return;
                }
                if (ayrilmaSebepleri.includes(newAyrilmaSebebi)) {
                    alert('Bu ayrılma sebebi zaten mevcut.');
                    return;
                }
                ayrilmaSebepleri.push(newAyrilmaSebebi); // Listeye ekle
                 ayrilmaSebepleri.sort((a, b) => a.localeCompare(b, 'tr')); // Ekleme sonrası sırala
                localStorage.setItem('ayrilmaSebepleri', JSON.stringify(ayrilmaSebepleri)); // Yerel depolamaya kaydet
                 newAyrilmaSebebiInput.value = ''; // Giriş alanını temizle
                renderSettings(); // Ayarlar listesini yeniden render et
                renderSelects(); // Ayrılma sebebi select kutusunu güncelle
                logAction('Ekleme', 'Ayarlar', `Yeni ayrılma sebebi "${newAyrilmaSebebi}" eklendi.`);
             };
        }

        // Yeni Şirket İsmi Ekle (Yeni eklendi)
        const addSirketIsmiButton = document.getElementById('addSirketIsmiButton');
        if(addSirketIsmiButton){
             addSirketIsmiButton.onclick = () => {
                 const newSirketIsmiInput = document.getElementById('newSirketIsmiInput');
                 if(!newSirketIsmiInput) {
                     return;
                 }
                const newSirketIsmi = newSirketIsmiInput.value.trim(); // Boşlukları temizle
                 if (!newSirketIsmi) {
                    alert('Lütfen bir şirket adı giriniz.');
                    return;
                }
                if (sirketIsimleri.includes(newSirketIsmi)) {
                    alert('Bu şirket adı zaten mevcut.');
                    return;
                }
                sirketIsimleri.push(newSirketIsmi); // Listeye ekle
                 sirketIsimleri.sort((a, b) => a.localeCompare(b, 'tr')); // Ekleme sonrası sırala
                localStorage.setItem('sirketIsimleri', JSON.stringify(sirketIsimleri)); // Yerel depolamaya kaydet
                 newSirketIsmiInput.value = ''; // Giriş alanını temizle
                renderSettings(); // Ayarlar listesini yeniden render et
                // Şirket adı select kutusu şu anda personel formunda yok, eklenirse renderSelects güncellenmeli
                logAction('Ekleme', 'Ayarlar', `Yeni şirket adı "${newSirketIsmi}" eklendi.`);
             };
        }

         // Yeni Ulusal Bayram Ekle (Yeni eklendi)
        const addUlusalBayramButton = document.getElementById('addUlusalBayramButton');
        if(addUlusalBayramButton){
             addUlusalBayramButton.onclick = () => {
                 const newUlusalBayramInput = document.getElementById('newUlusalBayramInput');
                 if(!newUlusalBayramInput) {
                     return;
                 }
                const newUlusalBayram = newUlusalBayramInput.value.trim(); // Boşlukları temizle
                 if (!newUlusalBayram) {
                    alert('Lütfen bir ulusal bayram adı giriniz.');
                    return;
                }
                if (ulusalBayramlar.includes(newUlusalBayram)) {
                    alert('Bu ulusal bayram adı zaten mevcut.');
                    return;
                }
                ulusalBayramlar.push(newUlusalBayram); // Listeye ekle
                 ulusalBayramlar.sort((a, b) => a.localeCompare(b, 'tr')); // Ekleme sonrası sırala
                localStorage.setItem('ulusalBayramlar', JSON.stringify(ulusalBayramlar)); // Yerel depolamaya kaydet
                 newUlusalBayramInput.value = ''; // Giriş alanını temizle
                renderSettings(); // Ayarlar listesini yeniden render et
                // Bayramlar tabı açıksa onu da güncelle
                const activeTab = document.querySelector('.tablinks.active');
                if(activeTab && activeTab.dataset.tab === 'tatiller') {
                    renderTatiller();
                }
                logAction('Ekleme', 'Ayarlar', `Yeni ulusal bayram "${newUlusalBayram}" eklendi.`);
             };
        }


        // Ayarlar Sayfası Silme Fonksiyonları (window object'ine eklenmişlerdi)
        window.deleteUnvan = (unvan) => {
             // Bu ünvan personel kayıtlarinda kullanılıyor mu kontrol et
             const isUsed = personeller.some(p => p.unvan === unvan);
             if (isUsed) {
                 alert(`Bu ünvan "${unvan}" personel kayıtlarında kullanıldığı için silinemez.`);
                 return; // Kullanılıyorsa silme
             }
             if (confirm(`"${unvan}" ünvanını silmek istediğinizden emin misiniz?`)) {
                 unvanlar = unvanlar.filter(u => u !== unvan); // Listeden sil
                  unvanlar.sort((a, b) => a.localeCompare(b, 'tr')); // Silme sonrası sırala
                 localStorage.setItem('unvanlar', JSON.stringify(unvanlar)); // Yerel depolamaya kaydet
                 renderSettings(); // Ayarlar listesini yeniden render et
                 renderSelects(); // Unvan select kutularini güncelle
                 logAction('Silme', 'Ayarlar', `Ünvan "${unvan}" silindi.`);
             }
         };
        window.deleteIzinTur = (tur) => {
             // Bu izin türü izin kayıtlarında kullanılıyor mu kontrol et
             const isUsed = izinler.some(i => i.tur === tur);
             if (isUsed) {
                 alert(`Bu izin türü "${tur}" izin kayıtlarında kullanıldığı için silinemez.`);
                 return; // Kullanılıyorsa silme
              }
             if (confirm(`"${tur}" izin türünü silmek istediğinizden emin misiniz?`)) {
                 izinTurileri = izinTurileri.filter(t => t !== tur); // Listeden sil
                  izinTurileri.sort((a, b) => a.localeCompare(b, 'tr')); // Silme sonrası sırala
                 localStorage.setItem('izinTurileri', JSON.stringify(izinTurileri)); // Yerel depolamaya kaydet
                 renderSettings(); // Ayarlar listesini yeniden render et
                 renderSelects(); // İzin türü select kutularini güncell
                 logAction('Silme', 'Ayarlar', `İzin türü "${tur}" silindi.`);
             }
         };
        window.deleteTahsil = (tahsil) => {
              // Bu tahsil personel kayıtlarinda kullanılıyor mu kontrol et
             const isUsed = personeller.some(p => p.tahsil === tahsil);
             if (isUsed) {
                 alert(`Bu tahsil "${tahsil}" personel kayıtlarında kullanıldığı için silinemez.`);
                 return; // Kullanılıyorsa silme
              }
              if (confirm(`"${tahsil}" tahsilini silmek istediğinizden emin misiniz?`)) {
                 tahsiller = tahsiller.filter(t => t !== tahsil); // Listeden sil
                  tahsiller.sort((a, b) => a.localeCompare(b, 'tr')); // Silme sonrası sırala
                 localStorage.setItem('tahsiller', JSON.stringify(tahsiller)); // Yerel depolamaya kaydet
                 renderSettings(); // Ayarlar listesini yeniden render et
                 renderSelects(); // Tahsil select kutularını güncelle
                 logAction('Silme', 'Ayarlar', `Tahsil "${tahsil}" silindi.`);
             }
         };
        window.deleteAyrilmaSebebi = (sebep) => { // Yeni ayrılma sebebi silme fonksiyonu
              // Bu sebep personel kayıtlarinda kullanılıyor mu kontrol et
             const isUsed = personeller.some(p => p.ayrilmaSebebi === sebep);
             if (isUsed) {
                 alert(`Bu ayrılma sebebi "${sebep}" personel kayıtlarında kullanıldığı için silinemez.`);
                 return; // Kullanılıyorsa silme
              }
              if (confirm(`"${sebep}" ayrılma sebebini silmek istediğinizden emin misiniz?`)) {
                 ayrilmaSebepleri = ayrilmaSebepleri.filter(s => s !== sebep); // Listeden sil
                  ayrilmaSebepleri.sort((a, b) => a.localeCompare(b, 'tr')); // Silme sonrası sırala
                 localStorage.setItem('ayrilmaSebepleri', JSON.stringify(ayrilmaSebepleri)); // Yerel depolamaya kaydet
                 renderSettings(); // Ayarlar listesini yeniden render et
                 renderSelects(); // Ayrılma sebebi select kutusunu güncelle
                 logAction('Silme', 'Ayarlar', `Ayrılma sebebi "${sebep}" silindi.`);
             }
         };
        window.deleteSirketIsmi = (sirket) => { // Yeni şirket ismi silme fonksiyonu
              // Bu şirket adı personel kayıtlarinda kullanılıyor mu kontrol et (placeholder)
              // const isUsed = personeller.some(p => p.sirketIsmi === sirket);
              // Bu kontrol personel veri yapısı güncellenince aktif edilecek
              const isUsed = false; // Şimdilik her zaman silinebilir varsayalım

               if (isUsed) {
                  alert(`Bu şirket adı "${sirket}" personel kayıtlarında kullanıldığı için silinemez.`);
                  return; // Kullanılıyorsa silme
               }
              if (confirm(`"${sirket}" şirket adını silmek istediğinizden emin misiniz?`)) {
                 sirketIsimleri = sirketIsimleri.filter(s => s !== sirket); // Listeden sil
                  sirketIsimleri.sort((a, b) => a.localeCompare(b, 'tr')); // Silme sonrası sırala
                 localStorage.setItem('sirketIsimleri', JSON.stringify(sirketIsimleri)); // Yerel depolamaya kaydet
                 renderSettings(); // Ayarlar listesini yeniden render et
                 // Şirket adı select kutusu varsa güncelle (şimdilik yok)
                 logAction('Silme', 'Ayarlar', `Şirket adı "${sirket}" silindi.`);
             }
         };
         // Yeni Ulusal Bayram Silme Fonksiyonu (Yeni eklendi)
        window.deleteUlusalBayram = (bayramAdi) => {
             // Bu bayram adı tatil tarihlerinde kullanılıyor mu kontrol et (herhangi bir yılda)
             const isUsed = Object.values(holidayDatesByYear).some(yearData =>
                 yearData.some(holiday => holiday.name === bayramAdi)
             );
             if (isUsed) {
                 alert(`Bu ulusal bayram adı tatil kayıtlarında kullanıldığı için silinemez.`);
                 return; // Kullanılıyorsa silme
             }
             if (confirm(`"${bayramAdi}" ulusal bayramını silmek istediğinizden emin misiniz?`)) {
                 ulusalBayramlar = ulusalBayramlar.filter(b => b !== bayramAdi); // Listeden sil
                  ulusalBayramlar.sort((a, b) => a.localeCompare(b, 'tr')); // Silme sonrası sırala
                 localStorage.setItem('ulusalBayramlar', JSON.stringify(ulusalBayramlar)); // Yerel depolamaya kaydet
                 renderSettings(); // Ayarlar listesini yeniden render et
                  // Bayramlar tabı açıksa onu da güncelle
                const activeTab = document.querySelector('.tablinks.active');
                if(activeTab && activeTab.dataset.tab === 'tatiller') {
                    renderTatiller();
                }
                 logAction('Silme', 'Ayarlar', `Ulusal bayram "${bayramAdi}" silindi.`);
             }
         };
         // Sayısal Ayar Kaydet Butonu Olay Dinleyicisi (Yeni eklendi)
          const updateNumericalSettingButton = document.getElementById('updateNumericalSettingButton');
          if(updateNumericalSettingButton){
               updateNumericalSettingButton.onclick = () => {
                   const numericalSettingInput = document.getElementById('numericalSettingInput');
                   if(!numericalSettingInput) {
                       return;
                   }
                   const newValue = parseFloat(numericalSettingInput.value); // Sayısal değeri al
                   if (isNaN(newValue)) {
                       alert('Lütfen geçerli bir sayısal değer giriniz.');
                       return;
                   }
                   numericalSetting = newValue; // Değeri güncelle
                   localStorage.setItem('numericalSetting', JSON.stringify(numericalSetting)); // Yerel depolamaya kaydet
                   alert('Sayısal ayar başarıyla güncellendi.'); // Başarı mesajı göster
                   logAction('Güncelleme', 'Ayarlar', `Sayısal ayar "${newValue}" olarak güncellendi.`); // Loglama eklendi
               };
          }

         // Sayısal Ayarı Yükleme Fonksiyonu (Yeni eklendi)
          function loadNumericalSetting() {
               const numericalSettingInput = document.getElementById('numericalSettingInput');
               if(numericalSettingInput) {
                   numericalSetting = JSON.parse(localStorage.getItem('numericalSetting') || '0'); // Yerel depolamadan yükle
                   numericalSettingInput.value = numericalSetting; // Input alanına yerleştir
               }
          }

        /**
         * Kullanıcı yetki checkboxlarını render eder.
         * @param {object} currentPermissions - Mevcut kullanıcı yetkileri { unvan: ['view', 'add', ...], ... }
         */
        function renderUserPermissionsForm(currentPermissions) {

const permissionsDiv = document.getElementById('userPermissions');
            const permissionsLabel = document.getElementById('userPermissionsLabel'); // Label elementini de alalım

            if (!permissionsDiv || !permissionsLabel) return;

            permissionsDiv.innerHTML = ''; // Önceki içeriği temizle

            // Eğer rol "Kullanıcı" değilse (Yönetici veya İzleyici ise), yetki seçim bölümünü gizle
            if (selectedRole !== 'Kullanıcı') {
                permissionsLabel.style.display = 'none';
                permissionsDiv.style.display = 'none';
                return;
            }

            // Rol "Kullanıcı" ise, yönetilecek ünvan seçimini göster
            permissionsLabel.style.display = 'block';
            permissionsDiv.style.display = 'block';
            permissionsLabel.innerText = 'Yönetilecek Ünvanlar:'; // Label'ı güncelle

            // "Tüm Ünvanları Yönet" checkbox'ı
            const allUnvanRow = document.createElement('div');
            allUnvanRow.classList.add('permission-row'); // Stil için mevcut sınıfı kullanabiliriz

            const allUnvanCheckboxId = 'perm-manage-all-unvans';
            const allUnvanCheckbox = document.createElement('input');
            allUnvanCheckbox.type = 'checkbox';
            allUnvanCheckbox.id = allUnvanCheckboxId;
            allUnvanCheckbox.dataset.unvanType = 'all'; // Özel bir işaretleyici

            const allUnvanLabelStrong = document.createElement('strong'); // "Tüm Ünvanlar" başlığını kalın yapalım
            const allUnvanLabelElement = document.createElement('label'); // İsim çakışmasını önlemek için 'Element' eklendi
            allUnvanLabelElement.htmlFor = allUnvanCheckboxId;
            allUnvanLabelElement.innerText = 'Tüm Ünvanları Yönet';
            allUnvanLabelStrong.appendChild(allUnvanLabelElement);

            allUnvanRow.appendChild(allUnvanCheckbox);
            allUnvanRow.appendChild(allUnvanLabelStrong);
            permissionsDiv.appendChild(allUnvanRow);

            // Her bir ünvan için "Yönet" checkbox'ı oluştur
            const sortedUnvanlar = [...unvanlar].sort((a, b) => a.localeCompare(b, 'tr'));
            sortedUnvanlar.forEach(unvan => {
                const row = document.createElement('div');
                row.classList.add('permission-row');

                const unvanCheckboxId = `perm-manage-${unvan.replace(/[^a-zA-Z0-9çğıİöşüÇĞIÖŞÜ]/g, '-')}`;
                const unvanCheckbox = document.createElement('input');
                unvanCheckbox.type = 'checkbox';
                unvanCheckbox.id = unvanCheckboxId;
                unvanCheckbox.dataset.unvan = unvan; // Hangi ünvana ait olduğunu sakla

                // Mevcut yetkilerde bu ünvan yönetiliyorsa (yani 'view' ve 'add' yetkileri varsa) checkbox'ı işaretle
                if (currentPermissions && currentPermissions[unvan] && currentPermissions[unvan].includes('view') && currentPermissions[unvan].includes('add')) {
                    unvanCheckbox.checked = true;
                }

                const labelElement = document.createElement('label'); // İsim çakışmasını önlemek için 'Element' eklendi
                labelElement.htmlFor = unvanCheckboxId;
                labelElement.innerText = unvan;

                const unvanNameSpan = document.createElement('span');
                unvanNameSpan.appendChild(labelElement);


                row.appendChild(unvanCheckbox);
                row.appendChild(unvanNameSpan); 
                permissionsDiv.appendChild(row);
            });

            // "Tüm Ünvanları Yönet" checkbox'ının işlevselliği
            allUnvanCheckbox.onchange = () => {
                const isChecked = allUnvanCheckbox.checked;
                permissionsDiv.querySelectorAll('input[type="checkbox"][data-unvan]').forEach(cb => {
                    cb.checked = isChecked;
                });
            };

            // Bireysel ünvan checkbox'ları değiştiğinde "Tüm Ünvanları Yönet" checkbox'ını güncelle
            permissionsDiv.querySelectorAll('input[type="checkbox"][data-unvan]').forEach(cb => {
                cb.onchange = () => {
                    if (!cb.checked) {
                        allUnvanCheckbox.checked = false;
                    } else {
                        let allChecked = true;
                        permissionsDiv.querySelectorAll('input[type="checkbox"][data-unvan]').forEach(individualCb => {
                            if (!individualCb.checked) {
                                allChecked = false;
                            }
                        });
                        allUnvanCheckbox.checked = allChecked;
                    }
                };
            });

            // Form yüklenirken "Tüm Ünvanları Yönet" checkbox'ının başlangıç durumunu ayarla
            let allInitiallyChecked = true;
            if (sortedUnvanlar.length === 0) { 
                allInitiallyChecked = false;
            } else {
                sortedUnvanlar.forEach(unvan => {
                    if (!(currentPermissions && currentPermissions[unvan] && currentPermissions[unvan].includes('view') && currentPermissions[unvan].includes('add'))) {
                        allInitiallyChecked = false;
                    }
                });
            }
            allUnvanCheckbox.checked = allInitiallyChecked;
  
         }

         // Yeni Ekle Butonları Olay Dinleyicileri (Eklendi)
         const addPersonelButton = document.getElementById('addPersonelButton');
         if(addPersonelButton) {
             addPersonelButton.onclick = () => {
                 clearPersonelForm(); // Formu temizle
                 showPersonelForm(); // Formu göster
             };
         }

         const addIzinButton = document.getElementById('addIzinButton');
         if(addIzinButton) {
             addIzinButton.onclick = () => {
                 clearIzinForm(); // Formu temizle
                 showIzinForm(); // Formu göster
             };
         }

         const addKullaniciButton = document.getElementById('addKullaniciButton');
         if(addKullaniciButton) {
             addKullaniciButton.onclick = () => {
                 clearUserForm(); // Formu temizle
                 showKullaniciForm(); // Formu göster (yeni kullanıcı modu)
             };
         }


        // Uygulama başlangıcı
        // Sayfa yüklendiğinde ilk çalışacak kod bloğu
        window.onload = () => {
// Yeni Ekle Butonları Olay Dinleyicileri (Güncellenmiş Hali)

        const addPersonelButton = document.getElementById('addPersonelButton');
        const personelFormContainer = document.getElementById('personelFormContainer');

        if (addPersonelButton && personelFormContainer) {
            addPersonelButton.onclick = () => {
                // Diğer formlar açıksa kapat
                if (izinFormContainer.style.display === 'block') {
                    izinFormContainer.style.display = 'none';
                    // İlgili "Ekle" butonunun metnini "Yeni İzin Ekle" yapabilirsiniz (isteğe bağlı)
                    // addIzinButton.innerText = 'Yeni İzin Ekle';
                }
                if (kullaniciFormContainer.style.display === 'block') {
                    kullaniciFormContainer.style.display = 'none';
                    // addKullaniciButton.innerText = 'Yeni Kullanıcı Ekle';
                }

                if (personelFormContainer.style.display === 'block') {
                    hidePersonelForm(); // Formu gizle ve temizle
                    // addPersonelButton.innerText = 'Yeni Personel Ekle'; // Buton metnini eski haline getir (isteğe bağlı)
                } else {
                    clearPersonelForm(); // Formu temizle
                    showPersonelForm();  // Formu göster
                    // addPersonelButton.innerText = 'Personel Formunu Gizle'; // Buton metnini değiştir (isteğe bağlı)
                }
            };
        }

        const addIzinButton = document.getElementById('addIzinButton');
        const izinFormContainer = document.getElementById('izinFormContainer');

        if (addIzinButton && izinFormContainer) {
            addIzinButton.onclick = () => {
                // Diğer formlar açıksa kapat
                if (personelFormContainer.style.display === 'block') {
                    personelFormContainer.style.display = 'none';
                    // addPersonelButton.innerText = 'Yeni Personel Ekle';
                }
                if (kullaniciFormContainer.style.display === 'block') {
                    kullaniciFormContainer.style.display = 'none';
                    // addKullaniciButton.innerText = 'Yeni Kullanıcı Ekle';
                }

                if (izinFormContainer.style.display === 'block') {
                    hideIzinForm();
                    // addIzinButton.innerText = 'Yeni İzin Ekle';
                } else {
                    clearIzinForm();
                    showIzinForm();
                    // addIzinButton.innerText = 'İzin Formunu Gizle';
                }
            };
        }

        const addKullaniciButton = document.getElementById('addKullaniciButton');
        const kullaniciFormContainer = document.getElementById('kullaniciFormContainer');

        if (addKullaniciButton && kullaniciFormContainer) {
            addKullaniciButton.onclick = () => {
                // Diğer formlar açıksa kapat
                if (personelFormContainer.style.display === 'block') {
                    personelFormContainer.style.display = 'none';
                    // addPersonelButton.innerText = 'Yeni Personel Ekle';
                }
                if (izinFormContainer.style.display === 'block') {
                    izinFormContainer.style.display = 'none';
                    // addIzinButton.innerText = 'Yeni İzin Ekle';
                }

                if (kullaniciFormContainer.style.display === 'block') {
                    hideKullaniciForm();
                    // addKullaniciButton.innerText = 'Yeni Kullanıcı Ekle';
                } else {
                    clearUserForm();
                    showKullaniciForm(); // Yeni kullanıcı modu için parametresiz çağırın
                    // addKullaniciButton.innerText = 'Kullanıcı Formunu Gizle';
                }
            };
        }
            // Oturum bilgisi varsa uygulamayı göster, yoksa giriş ekranını göster
             const savedUser = localStorage.getItem('currentUser');
             if (savedUser) {
                 try {
                      currentUser = JSON.parse(savedUser); // Oturum bilgisi doğru ise uygulamayı göster
                      if (currentUser && (currentUser.username || currentUser.id)) { // Temel kullanıcı bilgisi var mı kontrol et
                         showApp();
                        // Uygulama arayüzü gösterildikten sonra filtre butonlarının kurulumunu yap
                         setupFilterToggle('togglePersonelFiltersButton', 'personelFilterControls');
                         setupFilterToggle('toggleIzinFiltersButton', 'izinFilterControls');
                         setupFilterToggle('toggleGecmisFiltersButton', 'gecmisFilterControls');

            // ---- BAŞLANGIÇ: Ad Soyad Input Kısıtlamaları ----
            const adSoyadInput = document.getElementById('adSoyadInput');
            if (adSoyadInput) {
                adSoyadInput.addEventListener('input', function(event) {
                    let value = event.target.value;
                    // Sadece harfleri (Türkçe karakterler ve boşluk dahil) ve boşlukları koru, diğerlerini sil
                    value = value.replace(/[^a-zA-ZğüşıöçĞÜŞİÖÇ\s]/g, '');
                    // Tamamını büyük harfe çevir
                    value = value.toLocaleUpperCase('tr-TR'); // Türkçe'ye özgü büyük harf çevrimi
                    event.target.value = value;
                });
            }
            // ---- BİTİŞ: Ad Soyad Input Kısıtlamaları ----

            // ---- BAŞLANGIÇ: Plaka Input Kısıtlamaları ----
            const plakaInput = document.getElementById('plakaInput');
            if (plakaInput) {
                plakaInput.addEventListener('input', function(event) {
                    let value = event.target.value;
                    // Sadece harf (İngilizce alfabe) ve rakamları koru, diğerlerini (boşluk dahil) sil
                    value = value.replace(/[^a-zA-Z0-9]/g, '');
                    // Tamamını büyük harfe çevir (Türkçe'ye özgü olmayan standart büyük harf)
                    value = value.toUpperCase();
                    event.target.value = value;
                });
            }
            // ---- BİTİŞ: Plaka Input Kısıtlamaları ----

            // ---- BAŞLANGIÇ: GSM Input Formatlama ----
            const gsmInput = document.getElementById('gsmInput');
            if (gsmInput) {
                gsmInput.addEventListener('input', function(event) {
                    let value = event.target.value;
                    // Sadece rakamları al
                    let numbers = value.replace(/\D/g, '');

                    // Numara formatlama (maksimum 11 rakam: 0 + 10)
                    // Baştaki '0' her zaman korunacaksa ve kullanıcı '0' ile başlamak zorunda değilse,
                    // ilk rakam '0' değilse ve toplam rakam sayısı 10 ise başına '0' eklenebilir.
                    // Şimdilik girilen ilk rakamın 0 olduğunu varsayarak ilerleyelim.
                    // Ya da kullanıcı 0 girmese bile biz formatlarken başına ekleyebiliriz eğer ilk rakam 5 ise.

                    let formattedNumber = "";
                    if (numbers.length > 0) {
                        // Eğer ilk rakam 0 değilse ve ilk rakam 5 ise (ve toplamda 10 rakam girilecekse)
                        // otomatik olarak başına 0 ekleyebiliriz veya kullanıcıyı 0 ile başlamaya yönlendirebiliriz.
                        // Şimdilik basit tutalım: kullanıcı 0 ile başlarsa formatlayalım.
                        // Eğer kullanıcı 0 girmemişse ve ilk rakam 5 ise, ve uzunluk 10 ise başına 0 ekleyebiliriz.

                        // Sadece ilk 11 rakamı al (başındaki 0 ile birlikte)
                        numbers = numbers.substring(0, 11);

                        if (numbers.length > 0 && numbers.charAt(0) !== '0' && numbers.charAt(0) === '5' && numbers.length <=10) {
                            // Kullanıcı 5XX XXX XX XX giriyorsa, biz bunu 0(5XX) XXX XX XX yapabiliriz.
                            // Geçici olarak bu senaryoyu basit tutmak için, kullanıcının '0' ile başlamasını bekleyelim.
                            // Ya da daha gelişmiş bir mantık kurulabilir.
                            // Şimdilik: Eğer numara 0 ile başlamıyorsa ve 5 ile başlıyorsa,
                            // ve toplamda 10 haneye ulaşacaksa, başına '0' ekleyelim.
                            // Bu kısım karmaşıklaşabilir, şimdilik doğrudan formatlamaya odaklanalım.
                        }


                        // Format: 0(XXX) XXX XX XX
                        if (numbers.length > 0) {
                            formattedNumber = numbers.substring(0, 1); // İlk rakam (genellikle 0)
                        }
                        if (numbers.length > 1) {
                            formattedNumber += "(" + numbers.substring(1, Math.min(4, numbers.length));
                        }
                        if (numbers.length >= 4) { // Parantezi kapat
                             if (numbers.length === 4) formattedNumber += ")"; // Sadece 4. rakam girildiyse parantezi hemen kapat
                             else formattedNumber += ")"; // Daha fazlası varsa da kapat
                        }
                        if (numbers.length > 4) {
                            formattedNumber += " " + numbers.substring(4, Math.min(7, numbers.length));
                        }
                        if (numbers.length > 7) {
                            formattedNumber += " " + numbers.substring(7, Math.min(9, numbers.length));
                        }
                        if (numbers.length > 9) {
                            formattedNumber += " " + numbers.substring(9, Math.min(11, numbers.length));
                        }
                    }
                    event.target.value = formattedNumber;
                });
            }
            // ---- BİTİŞ: GSM Input Formatlama ----

	// ---- BAŞLANGIÇ: Personel Fotoğrafı Seçme, Önizleme ve Kaldırma ----
            const personelFotoInput = document.getElementById('personelFotoInput');
            const personelFotoPreview = document.getElementById('personelFotoPreview');
            const removePersonelFotoButton = document.getElementById('removePersonelFotoButton');

            if (personelFotoInput && personelFotoPreview && removePersonelFotoButton) {
                personelFotoInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        // Dosya boyutu kontrolü (örneğin 2MB)
                        if (file.size > 2 * 1024 * 1024) {
                            alert('Fotoğraf boyutu 2MB\'dan büyük olamaz.');
                            personelFotoInput.value = ""; // Dosya seçimini temizle
                            personelFotoPreview.style.display = 'none';
                            personelFotoPreview.setAttribute('src', '#');
                            removePersonelFotoButton.style.display = 'none';
                            currentPersonelFotoBase64 = null;
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function(e) {
                            personelFotoPreview.setAttribute('src', e.target.result);
                            personelFotoPreview.style.display = 'block';
                            removePersonelFotoButton.style.display = 'inline-block'; // Butonu göster
                            currentPersonelFotoBase64 = e.target.result; // Base64 verisini sakla
                        }
                        reader.readAsDataURL(file);
                    } else {
                        // Dosya seçilmediyse veya seçim iptal edildiyse
                        personelFotoPreview.style.display = 'none';
                        personelFotoPreview.setAttribute('src', '#');
                        removePersonelFotoButton.style.display = 'none';
                        currentPersonelFotoBase64 = null;
                        // Input'u temizlemek, aynı dosyayı tekrar seçmeyi sağlar
                        // Ancak bazı tarayıcılarda bu input.value = "" ataması güvenlik nedeniyle çalışmayabilir.
                        // Genellikle kullanıcı tekrar aynı dosyayı seçemezse farklı bir dosya seçmek zorunda kalır.
                        // Ya da input'u resetlemek için <form> içine alıp form.reset() denenebilir (ama tüm formu resetler).
                    }
                });

                removePersonelFotoButton.addEventListener('click', function() {
                    personelFotoInput.value = ""; // Dosya inputunu temizle (tarayıcı izin verirse)
                    personelFotoPreview.style.display = 'none';
                    personelFotoPreview.setAttribute('src', '#');
                    removePersonelFotoButton.style.display = 'none';
                    currentPersonelFotoBase64 = null; // Saklanan base64 verisini temizle
                    // Kayıtlı bir personelin fotoğrafını kaldırıyorsak, bu bilgiyi de bir şekilde işaretlememiz gerekebilir.
                    // Şimdilik sadece önizlemeyi ve seçimi temizliyoruz.
                });
            }
            // ---- BİTİŞ: Personel Fotoğrafı Seçme, Önizleme ve Kaldırma ----

                         } else {
                         // Oturum bilgisi bozuksa temizle
                         currentUser = null;
                         localStorage.removeItem('currentUser');
                          // Giriş ekranını göster
                          const loginDiv = document.getElementById('login');
                          if(loginDiv) {
                              loginDiv.style.display = 'block';
                         } else {
                           }
                          const containerDiv = document.querySelector('.container');
                          if(containerDiv) {
                               containerDiv.style.display = 'none';
                         } else {
                           }
                     }
                 } catch (e) {
                     currentUser = null;
                     localStorage.removeItem('currentUser');
                     // Giriş ekranını göster
                      const loginDiv = document.getElementById('login');
                      if(loginDiv) {
                          loginDiv.style.display = 'block';
                       } else {
                       }
                      const containerDiv = document.querySelector('.container');
                      if(containerDiv) {
                           containerDiv.style.display = 'none';
                       } else {
                       }
                 }
             } else {
                 // Oturum yoksa giriş ekranını göster
                 const loginDiv = document.getElementById('login');
                 if(loginDiv) {
                     loginDiv.style.display = 'block';
                  } else {
                  }
                  const containerDiv = document.querySelector('.container');
                 if(containerDiv) {
                     containerDiv.style.display = 'none';
                  } else {
                  }
             }

             // Sayfa kapatılırken veya yenilenirken mevcut kullanıcı bilgisini kaydet (isteğe bağlı)
             // Bu, tarayıcı sekmesi kapatıldığında veya yenilendiğinde kullanıcının giriş yapmış kalmasını sağlar.
             // Dikkat: Bu güvenlik riskleri taşıyabilir (örneğin, ortak kullanılan bilgisayarlarda).
             // Daha güvenli bir uygulama için sunucu tarafı oturum yönetimi veya daha gelişmiş istemci tarafı token yönetimi gerekir.
	// Filtre Açma/Kapatma Butonu Fonksiyonelliği
        // Belirtilen butona tıklanıldığında, belirtilen filtre kontrol elementini gösterir veya gizler.
        // Butonun metnini de duruma göre günceller.
        function setupFilterToggle(buttonId, controlsId) {
            const toggleButton = document.getElementById(buttonId); // Butonu ID'si ile bul
            const filterControls = document.getElementById(controlsId); // Filtre bölümünü ID'si ile bul

            // Hem butonun hem de filtre bölümünün sayfada var olduğundan emin ol
            if (toggleButton && filterControls) {
                // Butona tıklandığında çalışacak fonksiyonu ata
                toggleButton.onclick = () => {
                    // Eğer filtre bölümü gizliyse (display none veya başlangıçta hiç ayarlanmamışsa)
                    if (filterControls.style.display === 'none' || filterControls.style.display === '') {
                        filterControls.style.display = 'grid'; // CSS'inizdeki gibi 'grid' olarak göster (veya 'block' kullanıyorsanız)
                        toggleButton.innerText = 'Filtreleri Gizle'; // Buton metnini değiştir
                    } else { // Eğer filtre bölümü görünüyorsa
                        filterControls.style.display = 'none'; // Filtre bölümünü gizle
                        toggleButton.innerText = 'Filtreleri Göster'; // Buton metnini tekrar değiştir
                    }
                };
            }
        }
             window.addEventListener('beforeunload', () => {
                  if(currentUser){
                       localStorage.setItem('currentUser', JSON.stringify(currentUser));
                  } else {
                       localStorage.removeItem('currentUser');
                   }
              });
        };

    </script>
</body>
</html>